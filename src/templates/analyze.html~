{% set title="Analyze Genesets" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<div class="page-header">
    <h1>{{ title }}</h1>
</div>

<form id="todo-id" class="form-horizontal" role="form" method="post">
    <div class="row">

        <!-- the Analysis tools column -->
        <div class="col-md-4">
            <div class="page-header"><h2>Analysis Tools</h2></div>

            {% for tool in active_tools %}
                {% include 'tool/' + tool.classname + '_options.html' %}
            {% endfor %}
        </div>

        <!-- the projects column -->
        <div class="col-md-8">
            <div class="page-header"><h2>Projects</h2></div>

            {#
            TODO this should be changed to use JSON to fetch data for project panels when they are expanded
            (for users with many projects the current version is too slow)
            #}
            {% if "user" in g %}
                {% for proj in g.user.projects %}
                    <div id="project-{{ proj.project_id }}" class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <input
                                        class="proj-checkbox"
                                        data-project="{{ proj.project_id }}"
                                        style="margin: 5px;"
                                        type="checkbox">
                                <a data-toggle="collapse" href="#genesets-{{ proj.project_id }}">
                                    <span class="glyphicon glyphicon-plus"></span>
                                    {{ proj.name }}
                                </a>
                            </h4>
                        </div>
                        <div id="genesets-{{ proj.project_id }}" class="panel-collapse collapse">
                            <div class="panel-body">
                                <table class="table table-hover">
                                    <tbody>
                                    {% for geneset in proj.get_genesets(g.user.user_id) %}
                                        <tr>
                                            <td>
                                                <label>
                                                    <input
                                                            class="gs-checkbox"
                                                            data-parentproject="{{ proj.project_id }}"
                                                            type="checkbox"
                                                            name="geneset_{{ geneset.geneset_id }}"
                                                            value="1">
                                                    {{ geneset.name }}
                                                </label>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</form>

<script type="text/javascript">
    function genesetCheckboxChanged(projCheckbox, genesetCheckboxes) {
        var anyChecked = false;
        genesetCheckboxes.each(function(i, gsCheckbox) {
            gsCheckbox = $(gsCheckbox);
            if(gsCheckbox.prop('checked')) {
                anyChecked = true;
                return false;
            }
        });

        projCheckbox.prop('checked', anyChecked);
    }

    function projectCheckboxChanged(projCheckbox, genesetCheckboxes) {
        var projChecked = projCheckbox.prop('checked');
        genesetCheckboxes.each(function(i, gsCheckbox) {
            gsCheckbox = $(gsCheckbox);
            gsCheckbox.prop('checked', projChecked);
        });
    }

    $(function() {
        $('.proj-checkbox').each(function(i, projCheckbox) {
            projCheckbox = $(projCheckbox);
            var projID = projCheckbox.attr('data-project');
            var genesetCheckboxes = $('[data-parentproject=\'' + projID + '\']');

            projCheckbox.change(function() {
                console.log('proj change happended');
                projectCheckboxChanged(projCheckbox, genesetCheckboxes);
            });

            console.log('the proj is: ' + projID);

            genesetCheckboxes.each(function(i, gsCheckbox) {
                gsCheckbox = $(gsCheckbox);
                console.log('registering');
                console.log(gsCheckbox);
                gsCheckbox.change(function() {
                    console.log('gs change happended');
                    genesetCheckboxChanged(projCheckbox, genesetCheckboxes);
                });
            });
        });
    });

</script>

{% include 'footer.html' %}
