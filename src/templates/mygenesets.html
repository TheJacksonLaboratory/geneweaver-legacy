{% set title="My Genesets" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<style type="text/css">
    td.details-control:before {
        position: relative;
        background-image: none !important;
        display: inline-block;
        font-family: FontAwesome;
        content: "\f067";
        cursor: pointer;
        vertical-align: middle;
        horiz-align: center;
    }

    tr.shown td.details-control:before {
        content: "\f068";
    }

    .datatablerowhighlight {
        background-color: #ECFFB3;
    }

    .row_selected {
        background-color: #000000;
    }

</style>


{% if user_id == 0 %}
    {% include 'permissionError.html' %}
{% else %}


    {% block body %}

        <div id="maindiv" xmlns="http://www.w3.org/1999/html">

            <script>
                function format(d) {
                    // `d` is the original data object for the row
                    return '<tr><td colspan=7><table class="table">' +
                            '<tr>' +
                            '<td align=right width=25%><strong>GeneSet Label:</strong> </td>' +
                            '<td><p>' + d[7] + '</p></td></tr>' +
                            '<tr><td align=right width=25%><strong>Desscription:</strong> </td>' +
                            '<td><p>' + d[8] + '</p></td></tr>' +
                            '<tr><td align=right width=25%><strong>Date Created:</strong> </td>' +
                            '<td><p>' + d[9] + '</p></td></tr>' +
                            '<tr><td align=right width=25%><strong>Last Updated:</strong> </td>' +
                            '<td><p>' + d[10] + '</p></td>' +
                            '</tr>' +
                            '</table></td></tr>';
                }


                $(function () {
                    $("[data-toggle='tooltip']").tooltip();
                });
                var r = false;
                var editor;
                $(document).ready(function () {

                    //var trindex = 0;
                    var dbtable = '{{table}}';
                    var user_id = '{{user_id}}';
                    var columns = {{columns | safe}};
                    //var numCols = columns.length;
                    var headerCols = {{headerCols | safe}};
                    var table = $('#mygenesetsViewer').dataTable({
                        "dom": '<"clear">f<"input-lg"l><"clear">rtip<"col-lg-12 col-md-6"T>',
                        "tableTools": {
                            "sSwfPath": "/static/pixit/admin/assets/plugins/datatables/swf/copy_csv_xls_pdf.swf",
                            "sRowSelect": "multi",
                            "aButtons": [
                                "select_all",
                                "select_none",
                                "copy",
                                "print",
                                "pdf",
                                "xls",
                                "csv"
                            ]
                        },
                        "processing": true,
                        "serverSide": true,
                        "ajax": {
                            'url': "/../getServersideGenesetsdb",
                            'type': 'GET',
                            "data": {"table": dbtable, "user_id": user_id}
                        },
                        "columns": [
                            {
                                "className": 'details-control',
                                "orderable": false,
                                "data": null,
                                "defaultContent": '',
                                "width": "5%"
                            },
                            {
                                "name": "sp_id",
                                "width": "5%"
                            },
                            {
                                "name": "cur_id",
                                "width": "5%"
                            },
                            {
                                "name": "gs_attribution",
                                "width": "5%"
                            },
                            {
                                "name": "gs_count",
                                "width": "5%"
                            },
                            {"name": "gs_id"},
                            {"name": "gs_name"},
                            {
                                "orderable": false,
                                "data": null,
                                "defaultContent": ''
                            }
                        ],


                        //"columns": columns,
                        "aoColumnDefs": [

                            {
                                "aTargets": [0],
                                "bSortable": false
                            },
                            {
                                "aTargets": [1],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    $(nTd).empty();
                                    switch (sData) {
                                        case 1:
                                            $(nTd).append('<span class="mouse">Mouse</span>');
                                            break;
                                        case 2:
                                            $(nTd).append('<span class="human">Human</span>');
                                            break;
                                        case 3:
                                            $(nTd).append('<span class="rat">Rat</span>');
                                            break;
                                        case 4:
                                            $(nTd).append('<span class="zebrafish">ZFish</span>');
                                            break;
                                        case 5:
                                            $(nTd).append('<span class="fly">Fly</span>');
                                            break;
                                        case 6:
                                            $(nTd).append('<span class="monkey">Monkey</span>');
                                            break;
                                    }
                                }
                            },
                            {
                                "aTargets": [2],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    var curID = sData;
                                    $(nTd).empty();
                                    switch (curID) {
                                        case 1:
                                            $(nTd).append('<span class="tier1">Tier I</span>');
                                            break;
                                        case 2:
                                            $(nTd).append('<span class="tier2">Tier II</span>');
                                            break;
                                        case 3:
                                            $(nTd).append('<span class="tier3">Tier III</span>');
                                            break;
                                        case 4:
                                            $(nTd).append('<span class="tier4">Tier IV</span>');
                                            break;
                                        case 5:
                                            $(nTd).append('<span class="tier5">Tier V</span>');
                                            break;
                                    }
                                }
                            },
                            {
                                "aTargets": [3],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    var gsAttribution = sData;
                                    $(nTd).empty();
                                    switch (gsAttribution) {
                                        case 2:
                                            $(nTd).append('<span class="ctd">CTD</span>');
                                            break;
                                        case 7:
                                            $(nTd).append('<span class="drg">DRG</span>');
                                            break;
                                        case 8:
                                            $(nTd).append('<span class="go">GO</span>');
                                            break;
                                        case 9:
                                            $(nTd).append('<span class="mp">MP</span>');
                                            break;
                                        case 11:
                                            $(nTd).append('<span class="mesh">MeSH</span>');
                                            break;
                                    }
                                }
                            },
                            {
                                "aTargets": [4],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    var gsSize = sData;
                                    $(nTd).empty();
                                    $(nTd).append('<strong>' + gsSize + '</strong>');
                                }
                            },

                            {
                                "aTargets": [5],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    var gsID = sData;
                                    $(nTd).empty();
                                    $(nTd).append('<strong>GS' + gsID + '</span>');
                                }
                            },

                            {
                                "aTargets": [6],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    $(nTd).empty();
                                    $(nTd).append('<p><a href=\"/viewgenesetdetails/' + oData[5] + '\">' + sData + '</a></p>');
                                }
                            },

                            {
                                "aTargets": [7],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {

                                    /* Delete Button */
                                    var b = $('<button class="btn btn-danger" data-placement="top" data-toggle="tooltip" \
                            		        data-rel="tooltip" data-original-title="Delete GeneSet" type="button" title="Delete this GeneSet"\
                                            style="margin: 2px; padding: 0px 2px;">\
                            		        <i class="fa fa-times"></i></button>');
                                    /* Edit Button */
                                    var c = $('<button class="btn btn-success" type="button" data-placement="top" \
										    data-toggle="tooltip" data-rel="tooltip" data-original-total="Edit" \
										    title="Edit Name" style="margin: 2px; padding: 0px 2px;"> \
										    <i class="fa fa-edit"></i></button>');


                                    b.tooltip();
                                    b.click(function () {
                                        var cellData = oData[5];

                                        $('#delModal').modal({
                                            keyboard: true
                                        });

                                        $('#confirmDelete').on('click', function (e) {
                                            $.ajax({
                                                type: "GET",
                                                url: "../deleteGeneset",
                                                data: {"gs_id": cellData, "user_id": user_id},
                                                success: function (data) {
                                                    table.fnClearTable(0);
                                                    table.fnDraw();
                                                }
                                            });
                                        });
                                    });

                                    c.tooltip();
                                    c.click(function () {
                                        var cellData = oData[2];
                                        alert(cellData);
                                    });


                                    $(nTd).empty();
                                    $(nTd).append(b).append(c);
                                }

                            }
                        ]

                    });


                    // Add event listener for opening and closing details
                    $('#mygenesetsViewer tbody').on('click', 'td.details-control', function () {
                        var tr = $(this).closest('tr');
                        var T = table.fnGetData(tr);
                        var row = $(this).parents(tr);

                        if (tr.hasClass('shown')) {
                            tr.next().hide();
                            tr.removeClass('shown');
                        }
                        else {
                            // Open this row
                            var newRow = $(format(T)).animate({
                                height: "100px",
                                opacity: 0.75
                            }, 500);
                            tr.after(newRow);
                            tr.addClass('shown');
                        }
                    });

                    $('#addToProject').on('click', function () {
                        var oTT = TableTools.fnGetInstance('mygenesetsViewer');
                        var aselectedTrs = oTT.fnGetSelectedData();
                        var gsid = [];
                        for (var k in aselectedTrs){
                            gsid.push(aselectedTrs[k][5]);
                        }
                        if (aselectedTrs == 0) {
                           $("#myAlert").modal('show');
                        }
                        else {
                            $("#myModalLabel").html(gsid);
                            $("#addToProjectModal").modal('show');
                        }
                    });


                    $('#mygenesetsViewer tbody').on('click', 'tr', function () {
                        var id = this.id;
                        var index = $.inArray(id, selected);
                        if (index === -1) {
                            selected.push(id);
                        } else {
                            selected.splice(index, 1);
                        }
                        $(this).toggleClass('selected');
                    });


                });

            </script>

            <p>


            <div class="panel panel-default panel-heading bg-gray-light">
                <h3 class="panel-title"><strong>My GeneSets </strong></h3>
            </div>

            <div class="panel panel-default">

                <div class="row">
                    <div class="col-md-4">
                        <button type="button" class="btn btn-success btn-transparent" id="addToProject">
                            Add to Project
                        </button>

                        <button type="button" class="btn btn-warning btn-transparent" id="helpMyGenesets">
                            Help
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12 table-responsive table-red filter-right">

                        <table id="mygenesetsViewer"
                               class="table table-striped table-hover table-dynamic dataTable no-footer table-tools">

                            <thead>
                            <tr>
                                {% for col in headerCols %}
                                    <th style="text-align: left">{{ col.capitalize() }}</th>
                                {% endfor %}
                            </tr>
                            </thead>
                            <tfoot>
                            <tr>
                                {% for col in headerCols %}
                                    <th style="text-align: left">{{ col.capitalize() }}</th>
                                {% endfor %}
                            </tr>
                            </tfoot>
                        </table>

                    </div>
                </div>
            </div>

        </div>


        <div class="modal fade" id="delModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="delLabel">Delete GeneSet</h3>
                    </div>
                    <div class="modal-body">
                        <h4>Are you sure that you want to delete this {{ cellData }}GeneSet?
                            This will permanently remove this GeneSet and may produce concurrency issues in
                            projects.</h4>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-warning" id="confirmDelete" data-dismiss="modal">Delete
                            Results
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editResultName" name="editResultName" method="post" action="#" class="form-horizontal"
                          novalidate="novalidate">
                        <div class="modal-header">
                            <h3 class="modal-title" id="editLabel">Edit Result Name</h3>
                        </div>
                        <div class="modal-body">
                            <div class="form-class">
                                <label for="resultName">New Result Name:</label>
                                <input class="form-control input-lg" name="resultName" id="resultName" type="text">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" data-dismiss="modal" id="editSubmit">Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if g.user is defined %}
            <div class="modal fade" id="addToProjectModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-green">
                            <h3 class="modal-title" style="color: #f5f5f5">Add Selected GeneSets to Projects</h3>
                        </div>
                        <div class="modal-body">
                            <div class="row"><h4>These are the GeneSets you have selected</h4></div>
                            <div><span class="rows" id="myModalLabel"></span></div>
                            <table class="table table-striped">

                                {% for currProj in g.user.projects %}
                                    <tr>
                                        <td>
                                            <input
                                                    type="checkbox"
                                                    {#   class="modal_checkbox_{{ gs.geneset_id }}" #}
                                                    name="{{ currProj.project_id }}">
                                        </td>
                                        <td>
                                            {{ currProj.name }}
                                        </td>
                                    </tr>
                                {% endfor %}

                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-warning" onclick="addToSelected('')"
                                    data-dismiss="modal">Add to selected projects
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="modal fade" id="myAlert">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-green">
                        <h3 class="modal-title" style="color: #f5f5f5">No GeneSets Selected</h3>
                    </div>
                    <div class="modal-body">
                        <h4>You must select at least one GeneSet to add to your projects.</h4>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-error" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>





    {% endblock %}


{% endif %}




{% include 'footer.html' %}
