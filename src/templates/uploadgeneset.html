{% set title="Upload Geneset" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<script>

$(document).ready(function()  {

	$('#upload-geneset-form').submit(function(event) {
		event.preventDefault();
		$('#upload-geneset-button').prop('disabled',function() { return !$(this).prop('disabled') })

		var data = new FormData($(this)[0]);

		var fileSelect = document.getElementById('file_data');
	   	var reader = new FileReader();
		if( !fileSelect.disabled )
		{
		    var file = fileSelect.files;		    
	  	    //formData.append('selected_file', file[0], file[0].name);
		    reader.onload = createReaderHandler(file[0].name);
		    reader.readAsText(file[0]);

		}

		var data = $("#upload-geneset-form").serialize();
		//alert(reader.result);

 		$.ajax({
          		type: "POST",
           		url: "../creategeneset.html",
           		data: data,
			//processData: false,
    			//contentType: false,
			success: function(data)
           		{
			    alert(data);
			    $('#upload-geneset-button').prop('disabled',function() { return !$(this).prop('disabled') })	
           		}
         	    });		   
		
	});

	function createReaderHandler(name) {
  	    return function(ev) {
    		data[name] = ev.target.result;
  	};
}
	$("#pubmed_manual_button").click(function() {
		$("#pubmed_manual").toggle();
		
		//$('#pub_pubmed').prop('disabled',function() { return !$(this).prop('disabled') })
		
		var isHidden = $("#pubmed_manual").is(':hidden');

	        if(isHidden) {
	    	    $("#pubmed_manual :input").attr("disabled", true);
		}
		else {
		    $("#pubmed_manual :input").attr("disabled", false);
		}
	});

	

	
});

//toggles between the file or paste uploaders and toggle's enable/disable on inputs
function toggle_pasting() {
    
    $("#file_uploader").toggle(); 
    $("#paste_uploader").toggle();   
    	
    $('#file_text').prop('disabled',function() { return !$(this).prop('disabled') })
    $('#file_data').prop('disabled',function() { return !$(this).prop('disabled') })
}

</script>



<div class="page-header">
    <h1>Upload Geneset</h1>
</div>
<p>
    Use this page to upload a geneset.<br>A * indicates required fields.
</p>
<form id="upload-geneset-form"  enctype="multipart/form-data" method="POST" >
    <h2>Geneset Metadata</h2>
    <p>
        Please enter some descriptive info about this GeneSet. In order to ensure rapid acceptance by our curation team or, in the case of private data, maximum integration into the existing GeneWeaver dataset, please confirm that your GeneSet Metadata meets the guidlines outlined in our <a href="http://geneweaver.org/wiki/index.php?title=Curation_Standards">Curation Standards</a>
    </p>
    <div class="row">
        <div class="col-md-2">
            GeneSet Name*:
        </div>
        <div class="col-md-4">
            <input type="text" name="gs_name" required value="admin">
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-2">	
            GeneSet Figure Label*:
        </div>
        <div class="col-md-4">
            <input type="text" name="gs_abbreviation" required value="admin"> 
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-2">
            GeneSet Description*:
        </div>
        <div class="col-md-4">
            <input type="text" name="gs_description" required value="admin">
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-2">
            Access Restrictions*:
        </div>
        <div class="col-xs-4">
            <select name="permissions" class="form-control" required>
                <option value="private">Private</option>
                <option value="public">Public</option>
            </select>
        </div>
    </div>
    <br>
    <h2>Reference Info</h2>
    <p>
        If this experiment has been published and listed in PubMed, just enter the Pubmed ID below to automatically fill in the publication info, otherwise you may manually enter publication information. Providing this will allow others to discover and use your data more quickly, provide a means to link here directly from PubMed, and streamline our curation efforts.
    </p>
    <div class="row">
        <div class="col-md-2">
            PubMed ID:
        </div>
        <div class="col-md-4">
            <input id="pub_pubmed" type="text" name="pub_pubmed" size="10">
        </div><br><br>	
	<div id="pubmed_manual" style="display:none">
	   <div class="col-md-2">Title:</div>
	   <div class="col-md-4">	          
              <input type="text" name="pub_title" value size="40"  disabled=""></input>           
           </div><br><br>
	   <div class="col-md-2">Authors:</div>
	   <div class="col-md-4">	          
              <input type="text" name="pub_authors" value size="40"  disabled="" ></input>           
           </div><br><br>	   
	   <div class="col-md-2">Journal:</div>
	    <div class="col-md-4">	          
              <input type="text" name="pub_journal" value size="40"  disabled="" ></input>           
           </div><br><br>
	   <div class="col-md-2">Volume:</div>
 	   <div class="col-md-4">	          
              <input type="text" name="pub_volume" value size="10" maxlength="10"  disabled="" ></input>           
           </div><br><br>
	   <div class="col-md-2">Pages:</div>
	    <div class="col-md-4">	          
              <input type="text" name="pub_pages" value size="15" maxlength="15"  disabled="" ></input>           
           </div><br><br>
	   <div class="col-md-2">Month:</div>
	    <div class="col-md-4">	          
              <input type="text" name="pub_month" value size="3" maxlength="3"  disabled="" ></input>           
           </div><br><br>
	   <div class="col-md-2">Year:</div>
	    <div  class="col-md-4">	          
              <input type="text" name="pub_year" value size="4" maxlength="4"  disabled=""></input>           
           </div><br><br>
	   <div class="col-md-2">Abstract:</div>
	    <div  class="col-md-4">	          
              <textarea name="pub_abstract" id="pub_abstract" cols="40" rows="10"  disabled=""></textarea>           
           </div><br><br>
	</div>
    </div>
    <br>
    <button id="pubmed_manual_button" type="button" class="button">Manual Entry</button><br><br>
    <h2>Gene List</h2>
    <p>
        Provide a list of genes to associate with the descriptive info from above.
    </p>
    <div class="row">
        <div class="col-md-2">
            Species*:
        </div>
        <div class="col-xs-6 col-sm-4">
            <select name="species" class="form-control" name="sp_id">
                {% for spec in all_species %}    
                <option label="{{all_species[spec]}}" value="{{spec}}">{{all_species[spec]}}</option>
                {% endfor %} 
            </select>
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-2">
            Gene Identifiers*:
        </div>
        <div class="col-xs-6 col-sm-4">
            <select name="gene_identifier" class="form-control">
                <option value="0"></option>
                {% for id in gidts %}
                {% if id[0] != "MicroArrays" %}
                <option label="{{id[1]}}" value="{{id[0]}}">{{id[1]}}</option>
                {% else %}
                <optgroup label="MicroArrays">
                    {% for val in id[1] %}
                    <option label="{{val[1]}}" value="{{val[0]}}">{{val[1]}}</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
                {% endfor %}
            </select>
        </div>
    </div>
    <br>
    <div class="row">
        <div class="col-md-2">
            Input Gene List*:
        </div>        	 
        <div id="paste_uploader" class="col-md-4" style="display: block">
            <button class="button" type="button" onclick="toggle_pasting()">Click here to upload a file</button>
            <br>Manually Enter Genes one per line.<br>Format (tab separated): gene	genescore<br>	
            <textarea id="file_text" rows="15" cols="40" name="file_text" placeholder="gene1    0.92" required ></textarea>
        </div>
        <div id="file_uploader" class="col-md-4" style="display: none">
	    <button class="button" type="button" onclick="toggle_pasting()" >Click here to manually enter data</button><br><br>
            Select a Tab-separated Plain Textâ€¦           
            <input id="file_data" type="file" name="selected_file" disabled required></input>           
        </div>
    </div>
    <br>
    <input id="upload-geneset-button" class="btn btn-primary" type="submit" value="Upload Geneset"></input>		
</form>

<body onload="myFunction('{{gidts}}')">

<script>
function myFunction(genes)
{
	genes1 = genes.split("_");
	genes1 = genes1.join("\t1\n");
	genes1 = genes1.concat("\t1");
	document.getElementById("file_text").value= genes1;
}
</script>

{% include 'footer.html' %}
