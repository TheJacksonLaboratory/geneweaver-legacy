{% set title="Upload Geneset" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}


<body onload="myFunction('{{ gidts }}')">


<style type="text/css">

    #clickablePubmed {
        cursor: pointer;
    }

    #clickableGenes {
        cursor: pointer;
    }

    #clickableUpload, #clickableManual {
        cursor: pointer;
        color: #0090D9;
    }

    #pubmed_button_div, #pubmed_button_div_minus {
        cursor: pointer;
        color: #0090D9;
    }

    .panel-underline {
        border-bottom-width: thick;
        border-bottom-color: #006400;
    }

    .btn-file {
        position: relative;
        overflow: hidden;
    }

    .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: inherit;
        display: block;
    }

</style>


{% if user_id == 0 %}

    {% include 'htmlfragments/permissionError.html' %}

{% else %}

    <div class="row" id="result"></div>

    <div class="panel panel-default panel-heading bg-gray-light">
        <h2 class="panel-title"><strong>Upload GeneSet</strong></h2>
    </div>

    <div data-alerts="alerts" data-titles="{'warning': '<em>Warning!</em>'}" data-ids="myid" data-fade="5000"></div>


    <div class="row">
        <div class="col-md-4 pull-left">
            <p>(<strong>*</strong>) = mandatory</p>
        </div>
    </div>

    <form id="upload-geneset-form" enctype="multipart/form-data" method="POST">

        {# Geneset Metadata #}
        <div class="panel-heading panel-underline">
            <h2 class="panel-title">
                GeneSet Metadata
            </h2>
        </div>

        <div style="margin-left: 1em;">
            <br>

            <p>
                Please enter some descriptive info about this GeneSet. please confirm that your GeneSet Metadata meets the
                guidlines outlined in our <a href="http://geneweaver.org/wiki/index.php?title=Curation_Standards" target="_blank">
                <strong>Curation Standards <i class="fa fa-mail-forward"></i></strong></a> to ensure rapid acceptance by
                our curation team, or, in the case of private data, maximum integration into available GeneWeaver datasets.

            </p>
            <br>


            <div class="row">
                <div class="col-md-2">
                    GeneSet Name <strong>*</strong>:
                </div>
                <div class="col-md-8">
                    <input id="genesetName" type="text" name="gs_name" size="50"
                           style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)"
                           required>
                </div>
            </div>

            <br>

            <div class="row">
                <div class="col-md-2">
                    GeneSet Figure Label <strong>*</strong>:
                </div>
                <div class="col-md-8">
                    <input id="genesetLabel" type="text" name="gs_abbreviation" size="50"
                           style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)"
                           required>
                </div>
            </div>

            <br>

            <div class="row">
                <div class="col-md-2">
                    GeneSet Description <strong>*</strong>:
                </div>
                <div class="col-md-8">
                    <textarea id="genesetDescription" rows="10" cols="50" name="gs_description"
                              style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)"
                              required></textarea>
                </div>
            </div>

        </div>


        {# Permissions #}
        <div class="panel-heading panel-underline">
            <h2 class="panel-title">
                Access Permissions
            </h2>
        </div>

        <div style="margin-left: 1em;">
            <br>
            <br>

            <div class="row">
                <div class="col-md-2">
                    Access Restrictions <strong>*</strong>:
                </div>
                <div class="col-xs-2">

                    <select name="permissions" class="form-control" required>
                        <option value="private" selected>Private</option>
                        <option value="public">Public</option>
                    </select>

                </div>
            </div>
        </div>
        <br>


        {# Reference Information #}
        <div class="panel-heading panel-underline">
            <h2 class="panel-title">
                Reference Information
            </h2>
        </div>
        <div style="margin-left: 1em;">
            <br>

            <p>
                If this experiment has been published and listed in PubMed, just enter the Pubmed ID below to
                automatically fill in the publication info, otherwise you may manually enter publication information.
                Providing this will allow others to discover and use your data more quickly, provide a means to link
                here directly from PubMed, and streamline our curation efforts.
            </p>



            <div class="row">
                <div class="col-md-2">
                    PubMed ID:
                </div>
                <div class="col-md-4">
                    <input id="pub_pubmed" type="text" name="pub_pubmed" size="10">&nbsp;
                    <i id="clickablePubmed" class="fa fa-refresh"></i>
                </div>
                <br><br>

                <div id="pubmed_manual" style="display:none">
                    <div class="col-md-2">Title:</div>
                    <div class="col-md-8">
                        <input type="text" name="pub_title" id="pub_title" size="50"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Authors:</div>
                    <div class="col-md-8">
                        <input type="text" name="pub_authors" id="pub_authors" size="50"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Journal:</div>
                    <div class="col-md-8">
                        <input type="text" name="pub_journal" id="pub_journal" size="50"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Volume:</div>
                    <div class="col-md-2">
                        <input type="text" name="pub_volume" id="pub_volume" size="10" maxlength="10"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Pages:</div>
                    <div class="col-md-2">
                        <input type="text" name="pub_pages" id="pub_pages" size="15" maxlength="15"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Month:</div>
                    <div class="col-md-2">
                        <input type="text" name="pub_month" id="pub_month" size="3" maxlength="3"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Year:</div>
                    <div class="col-md-2">
                        <input type="text" name="pub_year" id="pub_year" size="4" maxlength="4"
                               style="color: #808080;" onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">
                    </div>
                    <br><br>

                    <div class="col-md-2">Abstract:</div>
                    <div class="col-md-4">
                    <textarea name="pub_abstract" id="pub_abstract" cols="50" rows="10"
                              style="color: #808080;" onmouseover="formFocus(this)"
                              onmouseout="noFormFocus(this)"></textarea>
                    </div>
                    <br><br>
                </div>
            </div>
            <br>

            <div id="pubmed_button_div">
                <span id="pubmed_manual_button"><b>Manual Entry <i class="fa fa-angle-down"></i></b></span><br>
            </div>
            <div id="pubmed_button_div_minus" style="display: none;">
                <span id="pubmed_manual_button_minus"><b>Less <i class="fa fa-angle-up"></i></b></span><br>
            </div>
        </div>

        <br>

        {# Annotation Information #}
        <div class="panel-heading panel-underline">
            <h2 class="panel-title">
                Annotation Information
            </h2>
        </div>
        <div style="margin-left: 1em;">
            <br>
            {% if onts %}

            {% else %}

                <div class="row">
                    <div class="alert bg-gray-light">No Annotation Information is Associated with this GeneSet</div>
                </div>

            {% endif %}

        </div>

        {# Geneset Gene Information #}
        <div class="panel-heading panel-underline">
            <h2 class="panel-title">
                Gene Information
            </h2>
        </div>

        <div style="margin-left: 1em;">
            <br>

            <div class="row">
                <div class="col-md-2">
                    Species <strong>*</strong>:
                </div>
                <div class="col-xs-6 col-sm-4">
                    <select class="form-control" name="sp_id" required>
                        {% for spec in all_species %}
                            <option label="{{ all_species[spec] }}" value="{{ spec }}">{{ all_species[spec] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <br>

            <div class="row">
                <div class="col-md-2">
                    Gene Identifiers <strong>*</strong>:
                </div>
                <div class="col-xs-6 col-sm-4">
                    <select name="gene_identifier" class="form-control" required>
                        <option value="0"></option>
                        {% for id in gidts %}
                            {% if id[0] != "MicroArrays" %}
                                <option label="{{ id[1] }}" value="{{ id[0] }}">{{ id[1] }}</option>
                            {% else %}
                                <optgroup label="MicroArrays">
                                    {% for val in id[1] %}
                                        <option label="{{ val[1] }}" value="{{ val[0] }}">{{ val[1] }}</option>
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <br>

            <div class="row">
                <div class="col-md-2">
                    Gene List <span id="clickableGenes"><i class="fa fa-info-circle"></i></span>
                </div>
                <div id="paste_uploader" class="col-md-4" style="display: block">
                    <span id="clickableUpload" onclick="toggle_pasting()"><strong> Switch to File Upload <i class="fa fa-upload"></i>
                        </strong></span>
                    <br>
                    {% if genes %}
                        <textarea id="file_text" rows="15" cols="40" name="file_text" style="color: #808080;"
                                  onmouseover="formFocus(this)" onmouseout="noFormFocus(this)">{{ genes }}</textarea>
                    {% else %}
                        <textarea id="file_text" rows="15" cols="40" name="file_text" style="color: #808080;"
                                  onmouseover="formFocus(this)" onmouseout="noFormFocus(this)"
                                  placeholder="gene1[tab]value[newline]"
                                  required></textarea>
                    {% endif %}

                </div>
                <div id="file_uploader" class="col-md-4" style="display: none">
                    <span id="clickableManual" onclick="toggle_pasting()"><strong>Switch to Manual Upload <i class="fa fa-keyboard-o"></i>
                        </strong></span>

                    <br><br>
                    <span class="btn btn-warning btn-file">Select Tab-Delimited Plain Text File...
                        <input id="file_data" type="file" name="selected_file" disabled required accept="text/plain"/>
                    </span>

                </div>


            </div>
                <div class="row">
                    <div class="col-md-2"></div>
                    <div id="fileDisplayArea" class="col-md-4" style="color: grey; padding-top: 2em;"></div>
                </div>

        </div>
        <br>


        <div class="panel-heading" style="border-bottom-width: thick; border-bottom-color: #006400;"></div>

        <div class="panel-heading">
            <div class="pull-right">
                <input id="upload-geneset-button" class="btn btn-warning fa" type="submit" value="Review Geneset Upload &#xf04e;" />
            </div>
        </div>

    </form>



{% endif %}

<script>
    // this script was added to auto-populate the form from Boolean Algebra to make a new geneset

    // grab the current url
    var queryString = window.location.href;

    // process the url to remove the heading, make spaces, and split into an array based on the ? delim. if there is
    // data after the heading
    queryString = queryString.replace("http://127.0.0.1:5000/batchuploadgeneset.html/",'');

    var queryLength = queryString.length

    if (queryLength != 0) {

        queryString = queryString.replace(/%20/g, " ");
        var values = queryString.split('?');
        // grab the length of the array
        var length = values.length;

        // assign the data for the title and description form boxes
        var title = values[0];
        var desc = values[1];

        // generate the string for the gene list
        var tmpGeneName = "";
        var tmpValue = 0;
        var tmpGeneStr = "";
        var i = 0;
        for (i = 2; i < length;) {
            tmpGeneName = values[i];
            i++;
            tmpValue = values[i];
            i++;
            tmpGeneStr += tmpGeneName;
            tmpGeneStr += '\t';
            tmpGeneStr += tmpValue;
            tmpGeneStr += '\n';
        }

        // populate the form
        document.getElementById('genesetName').value = title;
        document.getElementById('genesetDescription').value = desc;
        document.getElementById('file_text').value = tmpGeneStr;
    }
    else{
        // No need to auto populate
    }

</script>


<script>
    $(document).ready(function () {

        // Function to allow tabs in the textarea
        $("textarea").keydown(function (e) {
            if (e.keyCode === 9) { // tab was pressed
                // get caret position/selection
                var start = this.selectionStart;
                end = this.selectionEnd;

                var $this = $(this);

                // set textarea value to: text before caret + tab + text after caret
                $this.val($this.val().substring(0, start)
                        + "\t"
                        + $this.val().substring(end));

                // put caret at right position again
                this.selectionStart = this.selectionEnd = start + 1;

                // prevent the focus lose
                return false;
            }
        });

        //Display uploaded file to page
        var fileInput = document.getElementById('file_data');
		var fileDisplayArea = document.getElementById('fileDisplayArea');

		fileInput.addEventListener('change', function(e) {
			var file = fileInput.files[0];
			var textType = /text.*/;

			if (file.type.match(textType)) {
				var reader = new FileReader();

				reader.onload = function(e) {
					fileDisplayArea.innerText = reader.result;
				};

				reader.readAsText(file);
			} else {
				fileDisplayArea.innerText = "File not supported!"
			}
		});

        //Function to upload genesets
        //Ths AJAX POST loading is not working...leaving me perplexed. I stripped the text from the
        //div and passed it to application via get
        $('#upload-geneset-form').submit(function (event) {
            event.preventDefault();
            var fileDisplayArea = document.getElementById('fileDisplayArea');
            var fileSelect = document.getElementById('file_data');
            //var reader = new FileReader();
            if (!fileSelect.disabled) {
                //var file = fileSelect.files;
                var fileData = fileDisplayArea.innerText;
                //data.append('selected_file', file[0], file[0].name);
                //reader.onload = createReaderHandler(file[0].name);
                //reader.readAsText(file[0]);
                //alert(data['selected_file']);
            }

            var d = $("#upload-geneset-form").serialize();
            var sp_id = $("#upload-geneset-form").find('select[name="sp_id"]').val();
            var gdb_id = $("#upload-geneset-form").find('select[name="gene_identifier"]').val();

            $.ajax({
                type: "GET",
                url: "../createtempgeneset",
                data: {"formData": d, "fileData": fileData, "sp_id": sp_id, "gdb_id": gdb_id },
                success: function (data) {
                    var v = JSON.parse(data);
                    if (v["error"] == 'None') {
                        window.location.href = '../editgenesetgenes/' + v["gs_id"];
                    }
                    else {
                        $('html, body').animate({ scrollTop: 0 }, 'slow');
                        $(document).trigger("add-alerts", [
                            {
                                'message': "An Error Occurred. " + v["error"],
                                'priority': 'danger'
                            }
                        ]);
                    }
                    },
                error: function(){
                    $('html, body').animate({ scrollTop: 0 }, 'slow');
                    $(document).trigger("add-alerts", [
                        {
                            'message': "We could not upload your geneset at this time. Please contact GeneWeaver.",
                            'priority': 'danger'
                        }
                    ]);
                }
            });

        });

        //function createReaderHandler(name) {
        //    return function (ev) {
        //        data[name] = ev.target.result;
        //    };
        //}

    });


    var user_id = {{ user_id }}

            function myFunction(genes) {
                genes1 = genes.split("_");
                genes1 = genes1.join("\t1\n");
                genes1 = genes1.concat("\t1");
                document.getElementById("file_text").value = genes1;
            };


    $(function () {
        $("[data-toggle='tooltip']").tooltip();
    });


    $('#clickableGenes').popover({
        title: 'Gene Information', content: 'Provide a list of genes to associate with this record. ' +
        'A full description of the gene set format can be found ' +
        '<a href="http://www.geneweaver.org/wiki/index.php?title=Upload#Single_Gene_Sets" target="_blank">' +
        '       <strong>here</strong></a>.',
        html: 'true'
    });

    function formFocus($e) {
        $e.style.backgroundColor = "yellow";
    }

    function noFormFocus($e) {
        $e.style.backgroundColor = '';
    }


    //Get Pubmed Data for ID
    $('#clickablePubmed').click(function () {
        var pmid = $("#pub_pubmed").val();
        if (!$.isNumeric(pmid)) {
            $(document).trigger("add-alerts", [
                {
                    'message': "You must enter a valid Pubmed ID.",
                    'priority': 'warning'
                }
            ]);
        }
        else {
            $.ajax({
                type: "GET",
                url: "../getPubmed",
                data: {"pmid": pmid},
                success: function (data) {
                    $(document).trigger("add-alerts", [
                        {
                            'message': "PubMed ID " + pmid + " successfully loaded",
                            'priority': 'success'
                        }
                    ]);
                    if ($('#pubmed_manual').is(":hidden")) {
                        $("#pubmed_manual").toggle();
                    }
                    ;

                    if ($('#pubmed_button_div').is(":visible")) {
                        $('#pubmed_button_div').toggle();
                    }
                    ;

                    var parseData = JSON.parse(data);
                    $('#pub_title').val(parseData[0]);
                    $('#pub_authors').val(parseData[1]);
                    $('#pub_journal').val(parseData[2]);
                    $('#pub_volume').val(parseData[3]);
                    $('#pub_pages').val(parseData[4]);
                    $('#pub_year').val(parseData[5]);
                    $('#pub_month').val(parseData[6]);
                    $('#pub_abstract').val(parseData[7]);

                }
            });
        }
        ;

    });

    $("#pubmed_manual_button").click(function () {
        $("#pubmed_manual").toggle();

        //$('#pub_pubmed').prop('disabled',function() { return !$(this).prop('disabled') })

        var isHidden = $("#pubmed_manual").is(':hidden');

        if (isHidden) {
            $("#pubmed_manual :input").attr("disabled", true);

        }
        else {
            $("#pubmed_manual :input").attr("disabled", false);
            $("#pubmed_button_div_minus").show();
            $("#pubmed_button_div").hide();
        }
    });

    $("#pubmed_manual_button_minus").click(function () {
        $("#pubmed_manual").toggle();

        //$('#pub_pubmed').prop('disabled',function() { return !$(this).prop('disabled') })

        var isHidden = $("#pubmed_manual").is(':hidden');

        if (isHidden) {
            $("#pubmed_manual :input").attr("disabled", true);
            $("#pubmed_button_div_minus").hide();
            $("#pubmed_button_div").show();
        }
        else {
            $("#pubmed_manual :input").attr("disabled", false);
        }
    });


    //toggles between the file or paste uploaders and toggle's enable/disable on inputs
    function toggle_pasting() {

        $("#file_uploader").toggle();
        $("#paste_uploader").toggle();

        $('#file_text').prop('disabled', function () {
            return !$(this).prop('disabled')
        })
        $('#file_data').prop('disabled', function () {
            return !$(this).prop('disabled')
        })
    }

</script>


{% include 'footer.html' %}
