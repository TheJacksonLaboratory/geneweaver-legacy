{% set title="User Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

{% if user_id == 0 %}
	{% include 'permissionError.html' %}
{% else %}



{% block body %}


<div id="maindiv" xmlns="http://www.w3.org/1999/html">

	<script>
	$(function () {$("[data-toggle='tooltip']").tooltip(); });
	var r = false;
	var editor;
    $(document).ready(function()  {

 	 var table = '{{table}}';
 	 var user_id = '{{user_id}}';
	 var columns = {{columns | safe}};
	 var numCols = columns.length;
	 var headerCols = {{headerCols | safe}};
	 var table = $('#resultsViewer').dataTable( {
        	"dom": '<"clear">f<"input-lg"l><"clear">rtip<"col-lg-12 col-md-6"T>',
        	"tableTools": { "sSwfPath": "/static/pixit/admin/assets/plugins/datatables/swf/copy_csv_xls_pdf.swf" },
            "processing": true,
            "serverSide": true,
            "ajax": {
                    'url': "/../getServersideResultsdb",
                    'type': 'GET',
		    		"data": {"table": table, "user_id": user_id}
                },
	    	"columns": columns,
	    	"aoColumnDefs" :[
					{
                        "aTargets": [0],
                        "fnCreatedCell" : function(nTd, sData, oData, iRow, iCol){
                        	var cellData = oData[5];
                        	/* Delete Button */
                            var b = $('<button class="btn btn-danger" data-placement="top" data-toggle="tooltip" \
                            		data-rel="tooltip" data-original-title="Delete Result" type="button" title="Delete this Result"\
                            		style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-times"></i></button>');
							/* Re-Run Button */
                            var d = $('<button class="btn btn-success" data-placement="top" data-toggle="tooltip" \
                            		data-rel="tooltip" data-original-title="Re-run Result" type="button" title="Re-Run this Result"\
                            		style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-refresh"></i></button>');
							/* View Data if not expired */
                            if (sData >= 60) {
                            	var e = $('<button class="btn btn-warning" data-placement="top" data-toggle="tooltip" \
                            			data-rel="tooltip" data-original-title="Results Expired" type="button" \
                            			title="Stored Results Expired" style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-warning"></i></button>');
                            }
                            else {
                            	var e = $('<button class="btn btn-success" data-placement="top" data-toggle="tooltip" \
                            			data-rel="tooltip" data-original-title="View Stored Results" type="button" \
                            			title="View Stored Results" style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-eye"></i></button>');
                            }
                            b.tooltip();
                            b.click(function(){
                            	var cellData = oData[5];

                            	$('#delModal').modal({
                            		keyboard: true
                            	});

								$('#confirmDelete').on('click', function(e){
									$.ajax({
										type: "GET",
										url: "../deleteResults",
										data: {"runHash": cellData, "user_id": user_id},
										success: function(data)
											{
											table.fnClearTable(0);
											table.fnDraw();
											}
									});
            					});
                            });
							d.tooltip();
                            d.click(function(){
                            	var cellData = oData[5];
                                alert(cellData);
                            });
                            e.tooltip();
                            e.click(function(){
                                document.location.href = "http://www.cnn.com";
                                return false;
                            });

                            $(nTd).empty();
                            $(nTd).append(b).append(d).append(e);
                        }
                    },
                    {
                    	"aTargets": [6],
                    	"fnCreatedCell": function(nTd, sData, oData, iRow, iCol){
                    		if (sData == '') {
                    			$(nTd).empty();
                    			$(nTd).append('<span class="badge badge-danger">No Results</span>');
                    		}
                    	}
					},
					 {
                    	"aTargets": [1],
                    	"fnCreatedCell": function(nTd, sData, oData, iRow, iCol){
                    		if (sData != null) {
                    			c = $('<button class="btn btn-success" type="button" data-placement="top" \
										data-toggle="tooltip" data-rel="tooltip" data-original-total="Edit" \
										title="Edit Name" style="margin: 2px; padding: 0px 2px;"> \
										<i class="fa fa-edit"></i></button>');
								c.tooltip();
								c.click(function(){
                            		var cellData = oData[5];

                            		$('#editModal').modal({
                            			keyboard: true
                            		});
									$('#editSubmit').on('click', function(e){

											var editName = $('#resultName').val();
											$.ajax({
												type: "GET",
												url: "../editResults",
												data: {"runHash": cellData, "user_id": user_id, "editName": editName},
												success: function(data)
													{
													table.fnClearTable(0);
													table.fnDraw();
													}
											});

            						});
                            	});
                            	$(nTd).empty();
								$(nTd).append(c);
                            	if (sData.length > 15) {
                            		var modName = sData.substring(0,15);
                            		$(nTd).append(modName);
                            		$(nTd).append('...');
                            	}
                            	else if (sData.length == 0) {
									$(nTd).append('<span class="badge badge-info">No Name</span>');
                            	}
                            	else {
                            		$(nTd).append(sData);
                            	}

                    		}
                    	}
                    }]

        });




    });

	</script>

	<p>



	<div class="panel panel-default panel-heading bg-gray-light">
		<h3 class="panel-title"><strong>Results </strong> management</h3>
	</div>

	<div class="panel panel-default">
		<div class="row">
			<div class="col-md-12 col-sm-12 col-xs-12 table-responsive table-red filter-right">

				<table id="resultsViewer" class="table table-striped table-hover table-dynamic dataTable no-footer table-tools">

    				<thead>
      					<tr>
							{% for col in headerCols %}
	    					<th style="text-align: left">{{col.capitalize()}}</th>
							{% endfor %}
      					</tr>
    				</thead>
    				<tfoot>
      					<tr>
							{% for col in headerCols %}
	    					<th style="text-align: left">{{col.capitalize()}}</th>
							{% endfor %}
      					</tr>
  					</tfoot>
  				</table>

			</div>
		</div>
	</div>

</div>


	<div class="modal fade" id="delModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header bg-green">
					<h3 class="modal-title" id="delLabel" style="color: #f5f5f5">Delete Result</h3>
				</div>
				<div class="modal-body">
					<h4>Are you sure that you want to delete this result?
					This will permanently remove all history of this experimental result.</h4>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="button" class="btn btn-warning" id="confirmDelete" data-dismiss="modal">Delete Results</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="editModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="editResultName" name="editResultName" method="post" action="#" class="form-horizontal" novalidate="novalidate">
				<div class="modal-header bg-green">
					<h3 class="modal-title" id="editLabel" style="color: #f5f5f5">Edit Result Name</h3>
				</div>
				<div class="modal-body">
					<div class="form-class">
							<label for="resultName"><h4>New Result Name:</h4></label>
							<input class="form-control input-lg" name="resultName" id="resultName" type="text">
                    </div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<button type="submit" class="btn btn-warning" data-dismiss="modal" id="editSubmit">Submit</button>
				</div>
				</form>
			</div>
		</div>
	</div>



{% endblock %}


{% endif %}

{% include 'footer.html' %}