{% set title="User Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

{% if user_id == 0 %}
    {% include 'permissionError.html' %}
{% else %}



    {% block body %}


	<style>

		/* 	for some retarded reason data tables wasn't centering text
			properly, so this is here instead.
		*/
		td {
			text-align: center;
		}

	</style>

        <div id="maindiv" xmlns="http://www.w3.org/1999/html">

            <script>
				var checkTool = function(tool) {
					//if (tool === 'Jaccard Similarity')
					//	return '

				};

				// jquery extend function
				$.extend({
					redirectPost: function(location, args) {
						var form = '';
						$.each( args, function( key, value ) {
							form += '<input type="hidden" name="'+key+'" value="'+value+'">';
						});
						$('<form action="'+location+'" method="POST">'+form+'</form>').appendTo('body').submit();
					}
				});

                $(function () {
                    $("[data-toggle='tooltip']").tooltip();
                });
                var r = false;
                var editor;
                $(document).ready(function () {

                    var table = '{{table}}';
                    var user_id = '{{user_id}}';
                    var columns = {{columns | safe}};
                    var numCols = columns.length;
                    var headerCols = {{headerCols | safe}};
                    var table = $('#resultsViewer').dataTable({
                        "dom": '<"clear">f<"input-lg"l><"clear">rtip<"col-lg-12 col-md-6"T>',
                        "iDisplayLength": 15,
                        "tableTools": {"sSwfPath": "/static/pixit/admin/assets/plugins/datatables/swf/copy_csv_xls_pdf.swf"},
                        "processing": true,
                        "serverSide": true,
                        "ajax": {
                            'url': "/../getServersideResultsdb",
                            'type': 'GET',
                            "data": {"table": table, "user_id": user_id}
                        },
                        "columns": columns,
                        "aoColumnDefs": [
                            {
                                "aTargets": [0],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    var cellData = oData[5];
                                    /* Delete Button */
                                    var b = $('<span data-placement="top" data-toggle="tooltip" \
                            		data-rel="tooltip" data-original-title="Delete Result" type="button" title="Delete this Result"\
                            		style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-trash-o"></i></span>');
                                    /* Re-Run Button */
                                    var d = $('<span data-placement="top" data-toggle="tooltip" \
                            		data-rel="tooltip" data-original-title="Re-run Result" type="button" title="Re-Run this Result"\
                            		style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-refresh"></i></span>');
                                    /* View Data if not expired */
                                    if (sData >= 60) {
                                        var e = $('<span data-placement="top" data-toggle="tooltip" \
                            			data-rel="tooltip" data-original-title="Results Expired" type="button" \
                            			title="Stored Results Expired" style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-warning"></i></span>');
                                    }
                                    else {
                                        var e = $('<span data-placement="top" data-toggle="tooltip" \
                            			data-rel="tooltip" data-original-title="View Stored Results" type="button" \
                            			title="View Stored Results" style="margin: 2px; padding: 0px 2px;">\
                            		<i class="fa fa-eye"></i></span>');
                                    }
                                    b.tooltip();
                                    b.click(function () {
                                        var cellData = oData[5];

                                        $('#delModal').modal({
                                            keyboard: true
                                        });

                                        $('#confirmDelete').on('click', function (e) {
                                            $.ajax({
                                                type: "GET",
                                                url: "../deleteResults",
                                                data: {"runHash": cellData, "user_id": user_id},
                                                success: function (data) {
                                                    table.fnClearTable(0);
                                                    table.fnDraw();
                                                }
                                            });
                                        });
                                    });
                                    d.tooltip();
                                    d.click(function () {
                                        var cellData = oData[5];
                                        alert(cellData);
                                    });
                                    e.tooltip();
                                    e.click(function () {
                                        var runhash = oData[4];
										var serial = 'runHash=' + runhash;
										serial += '&user_id=' + user_id;
										var url = 'http://127.0.0.1/viewStoredResults';

										$.redirectPost('/viewStoredResults', 
											{'runHash': runhash, 
											 'user_id': user_id});
										// This is fucking hackish, but I
										// couldn't find a better way...
										// Create a hidden form with our user/
										// runhash data and submit that to the
										// viewStoredResults endpoint so the 
										// page changes and users can see their
										// old results.
										var hform = $('<form action="' + url +
											'" method="post">' +
											'<input type="text" name="runHash"'
											+ ' value="' + runhash + 
											'" />' + 
											'<input type="text" name="user_id"'
											+ ' value="' + user_id + 
											'" />' + '</form>');
										$('body').append(hform).submit();
										console.log('fuck');
                                        //$.ajax({
										//$.get('../viewStoredResults',
										//	  {'runHash': runhash,
										//	  'user_id':user_id});
                                            //type: "GET",
                                            //url: "../viewStoredResults",
                                            //data: {"runHash": runhash, "user_id": user_id}
                                            //success: function (data) {
												//console.log(data);
												//window.location();
											//var data2 = {};
											//data2[data['res_tool']] = true;
											//data2['res_data'] = data['res_data'];
											//console.log(data2);
											//$.post('../viewStoredResults',data2);
                                            //}
                                        //});
                                        //document.location.href = "http://www.cnn.com";
                                        //return false;
                                        return true;
                                    });

                                    $(nTd).empty();
                                    $(nTd).append(b).append(d).append(e);
                                }
                            },
                            {
                                "aTargets": [5],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    if (sData == '') {
                                        $(nTd).empty();
                                        $(nTd).append('<span class="badge badge-danger">No Results</span>');
                                    }
                                }
                            },
                            {
                                "aTargets": [1],
                                "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                                    if (sData != null) {
                                        c = $('<span data-placement="top" \
										data-toggle="tooltip" data-rel="tooltip" data-original-total="Edit" \
										title="Edit Name" style="margin: 2px; padding: 0px 2px;"> \
										<i class="fa fa-edit"></i></span>');
                                        c.tooltip();
                                        c.click(function () {
                                            var cellData = oData[5];

                                            $('#editModal').modal({
                                                keyboard: true
                                            });
                                            $('#editSubmit').on('click', function (e) {

                                                var editName = $('#resultName').val();
                                                $.ajax({
                                                    type: "GET",
                                                    url: "../editResults",
                                                    data: {
                                                        "runHash": cellData,
                                                        "user_id": user_id,
                                                        "editName": editName
                                                    },
                                                    success: function (data) {
                                                        table.fnClearTable(0);
                                                        table.fnDraw();
                                                    }
                                                });

                                            });
                                        });
                                        $(nTd).empty();
                                        $(nTd).append(c);
                                        if (sData.length > 15) {
                                            var modName = sData.substring(0, 15);
                                            d = $('<span data-placement="top" \
										data-toggle="tooltip" data-rel="tooltip" data-original-total="Edit" \
										title="' + sData + '" style="margin: 2px; padding: 0px 2px;"> \
										' + modName + '</span>');
                                            d.tooltip();
                                            $(nTd).append(d);
                                            $(nTd).append('...');
                                            //$(nTd).popover({
                                            //    container: 'body',
                                            //    placement: 'right', // top, bottom, left or right
                                            //    title : 'Result Name',
                                            //    html: 'true',
                                            //    content : '<div id="popOverBox">' + sData + '</div>'
                                            //    });

                                        }
                                        else if (sData.length == 0) {
                                            $(nTd).append('<span class="badge badge-info">No Name</span>');
                                        }
                                        else {
                                            $(nTd).append(sData);
                                        }

                                    }
                                }
                            }]

                    });


                });

            </script>

            <p>


            <div class="panel panel-default panel-heading bg-gray-light">
                <h3 class="panel-title"><strong>Results </strong> management</h3>
            </div>

            <div class="panel panel-default">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12 table-responsive table-red filter-right">

                        <table id="resultsViewer"
                               class="table table-striped table-hover table-dynamic dataTable no-footer table-tools">

                            <thead>
                            <tr>
                                {% for col in headerCols %}
                                    <th style="text-align: center">{{ col.capitalize() }}</th>
                                {% endfor %}
                            </tr>
                            </thead>
                            <tfoot>
                            <tr>
                                {% for col in headerCols %}
                                    <th style="text-align: center">{{ col.capitalize() }}</th>
                                {% endfor %}
                            </tr>
                            </tfoot>
                        </table>

                    </div>
                </div>
            </div>

        </div>


        {% include 'modal/deleteResult.html' %}

        {% include 'modal/editResultName.html' %}





    {% endblock %}


{% endif %}

{% include 'footer.html' %}
