{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<style>

.key > * {
    margin: 5px;
    display: inline-block;
    vertical-align: middle;
}

#panel, #flip {
    padding: 5px;
    text-align: left;
}

#panel {
    display: none;
    background-color: #FFFFFF;
}

#flip {
 height: 50px;
}

#rerunPanel, #rerunFlip {
    padding: 5px;
    text-align: left;
}

#rerunPanel {
    height: 350px;
    text-align: left;
    display: none;
}

#rerunFlip {
   height: 50px;
   text-shadow: none;
}
#rerun{
 float:right;
    display:block;
    margin-right: 585px;
    clear:left;
 }

.left-cell {
  vertical-align: middle;
  width: 200px;
}

.right-cell {
  display: table-cell;
  vertical-align: middle;
  text-align: right;
  right: 0;
}

.middle-cell {
  display: table-cell;
  vertical-align: middle;
  text-align: left;
  padding-left: 320px;
}

.box-header {
  padding-bottom: 5px;
  display: table;
  width: 90%;
}

#addToProject, #exportData {
    float: left;
}

 .divider{
    margin: 5px;
}

#checkall{
    float: left;
}

.bar {
  fill: steelblue;
}

.bar:hover {
  fill: green;
}

.bar > text{
    stroke: ghostwhite;
}

.bar:hover > text{
    stroke: black;
}

body {
    font: 10px sans-serif;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

.axis--x path {
  display: none;
}

.line {
    fill: none;
    stroke: steelblue;
    stroke-width: 1.5px;
}

 div.tooltip {
  position: absolute;
  text-align: center;
  width: 300px;
  height: 60px;
  padding: 2px;
  font: 10px sans-serif;
  background: ghostwhite;
  pointer-events: none;}

</style>
<script>
    var line=true;
    var graph=true;
    var smooth=true;
    var showHideBox=function(){
        graphBar(graph,line,smooth);
    };
</script>
<!--note to future developers: this was done as a group project in undergrad, where we are not taught website development
therefore everything here is a kludge. the intention of the table is to be the same type of checkboxes
as on the previous page, but to get it to work, things that experienced web developer would scoff at have been done.

the checkboxes are supposed to toggle which graphs show up
fix the code to be maintainable and consistent with the rest of the website code if you can-->
</table>
<table>
    <tbody><tr>
        <td>
            <div class="ui-checkbox">

<div class="ui-checkbox"><label for="lineGraphCheckbox" class="ui-btn ui-corner-all ui-checkbox-on ui-btn-inherit ui-btn-icon-left"></label>
    <input type="checkbox" onclick="line=this.checked; showHideBox()" id="lineGraphCheckbox" checked="true"></div>

            </div>
        </td>
        <td>
            <strong>Best Fit Line</strong>
        </td>
    </tr>
    <tr>
        <td>
            <div class="ui-checkbox">


<div class="ui-checkbox"><label for="barGraphCheckbox" class="ui-btn ui-corner-all ui-checkbox-on ui-btn-inherit ui-btn-icon-left"></label>
    <input type="checkbox" onclick="graph=this.checked; showHideBox()" id="barGraphCheckbox" checked="true"></div>
            </div>
        </td>
        <td>
            <strong>Histogram Boxes</strong>
        </td>
    </tr>
    <tr>
        <td>
            <div class="ui-checkbox">


<div class="ui-checkbox"><label for="smoothGraphCheckbox" class="ui-btn ui-corner-all ui-checkbox-on ui-btn-inherit ui-btn-icon-left"></label>
    <input type="checkbox" onclick="smooth=this.checked; showHideBox()"
    id="smoothGraphCheckbox" checked="true"></div>
            </div>
        </td>
        <td>
            <strong>Interpolate Best Fit Line</strong>
        </td>
    </tr>
</tbody></table>

<div id="graphDiv">
<svg id="barGraph" width="960" height="500"></svg>
</div>
<script src="/static/d3/d3.js" charset="utf-8"></script>
<script>


var data = d3.range({{ async_result.datafile['data'][0]['densityPointCount']}}).map(function(i) {

    var value={intersectSize: i , frequency: {{ async_result.datafile['data'][0]['density'] }}[i] };

    console.log(value);
    return value;
});

var margin = {top: 20, right: 20, bottom: 70, left: 40},
    width = +d3.select("#barGraph").attr("width") - margin.left - margin.right,
    height = +d3.select("#barGraph").attr("height") - margin.top - margin.bottom;

var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

var y = d3.scale.linear().range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(10);

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .ticks(10,"%");


  x.domain(data.map(function(d) { return d.intersectSize; }));
  y.domain([0, d3.max(data, function(d) { return d.frequency; })]);

var svg=d3.select("#barGraph").attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");

var graphBar=function(drawBars,drawLine,smooth){

    svg.selectAll("*").remove();

  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
    .selectAll("text")
      .style("text-anchor", "end")
      .attr("dx", ".2em")

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("frequency");

  if(drawBars){
      var bars=svg.selectAll(".bar")
          .data(data)
        .enter().append("g")
          .attr("class", "bar");

    bars.append("rect")
          .attr("x", function(d) { return x(d.intersectSize); })
          .attr("width", x.rangeBand())
          .attr("y", function(d) { return y(d.frequency); })
          .attr("height", function(d) { return height - y(d.frequency); });
    bars.append("text").text(function(d){return ""+d.frequency})
      .attr("x", function(d) { return x(d.intersectSize); })
      .attr("y", function(d) { return y(d.frequency); })
      .attr("dx", ".5em")
      .attr("dy", "-1em")

  }


  var line=d3.svg.line()
      .x(function(d){ return x(d.intersectSize)+(x.rangeBand()/2);})
      .y(function(d){ return y(d.frequency);})
  if(smooth){
    line.interpolate("basis")
  }
  if(drawLine){
    svg.append("g").append("path")
        .attr("d",line(data))
        .style("fill","none")
        .style("stroke","black")
        .style("stroke-width","4-px");
  }

};
graphBar(true,true,true);

</script>


<h3>p-value: {{ async_result.datafile['data'][0]['pValue'] }}<br/>
{{ async_result.datafile['data'][0]['numSamples'] }} simulated results of length {{ async_result.datafile['data'][0]['sampleLength'] }} generated from background<br/>
{{ async_result.datafile['data'][0]['intersectGreaterCount'] }} simulated results of length {{ async_result.datafile['data'][0]['sampleLength'] }} contained at least as many matches to database as the actual expression results.<br/>
{{ async_result.datafile['data'][0]['inTopAndIntersectCount'] }} matches to database found in microarray results</h3>

<script src="/static/d3/d3.min.js" charset="utf-8"></script>

<div class="page-header">
    <h1>{{ title }}
        {{ runhash }} </h1>
</div>

<form id="todo-id" class="form-horizontal" role="form" method="post">
    <div class="panel panel-info" >
        <div class="panel-heading bg-green" style="border-radius:4px;">
			<a data-toggle="collapse" data-parent="#accordion" href="#msetCollapse"style="color:#FFFFFF; width:100%;">
				<div class="panel-title" style="width:100%;">
					Tool Options
					<span class="caret"></span>
				</div>
			</a>
        </div>
        <div id="msetCollapse" class="panel-collapse collapse" style="">
            <div class="panel-body" style="font-size:13px;border-radius:5px; border:1px solid #006400">
                <div class="row">
                    <div class="col-md-4">
                        {{ macros.tool_param_radio(tool.params['MSET_Homology']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['MSET_NumberofSamples']) }}
                    </div>

                </div>
                <div class="row">
                    <div class="col-md-4">
                        <input type="hidden" name="genesets" value="{{ async_result.gs_ids|join(' ') }}"/>
                    </div>
                    <div class="col-md-8">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-primary"
                                type='submit'
                                value='run'
                                onclick='this.form.action="{{ url_for('MSET.run_tool') }}";'>
                            Re-Run Tool
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="panel panel-info" >
	<div class="panel-heading bg-green" style="border-radius:4px;">
		<a data-toggle="collapse" data-parent="#accordion" href="#viz-options"style="color:#FFFFFF; width:100%;">
			<div class="panel-title" style="width:100%;">
				Visualization Options
				<span class="caret"></span>
			</div>
		</a>
	</div>
	<div id="viz-options" class="panel-collapse collapse" style="">
		<div class="panel-body" style="font-size:13px;border-radius:5px; border:1px solid #006400">
            <div class="row">
				<div class="col-md-2">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Download as...
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="download-image" id="dl-pdf">PDF</a></li>
                            <li><a class="download-image" id="dl-png">PNG</a></li>
                            <li><a class="download-image" id="dl-svg">SVG</a></li>
                        </ul>
                    </div>
				</div>

				<div class="col-md-2">
                    <button type="button" value="Update" id="zoomButton" class="btn btn-primary">
                        Reset Zoom
                    </button>
                </div>
            </div>

		</div>
	</div>
</div>

<div class="panel panel-info" >
	<div class="panel-heading bg-green" style="border-radius:4px;">
		<a data-toggle="collapse" data-parent="#accordion" href="#sim-matrix"style="color:#FFFFFF; width:100%;">
			<div class="panel-title" style="width:100%;">
				Similarity Matrix
				<span class="caret"></span>
			</div>
		</a>
	</div>
	<div id="sim-matrix" class="panel-collapse collapse" style="">
		<div align="center" class="panel-body" style="overflow:scroll; font-size:13px; border-radius:5px; border:1px solid #006400; text-align:center;">
            <div id="matrix" align="center">
            </div>
            <br />
            <button align="center" type="button" class="btn btn-block btn-warning" id="addToProject" style="width:270px">
                <i class="fa fa-folder-o pull-left"></i>
                Add GeneSet(s) to Project
            </button>
		</div>
	</div>
</div>

