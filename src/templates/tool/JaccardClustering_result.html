{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<style type="text/css">
    .background {
        fill: #ffffff;
    }

    .d3 {
        width: 100%;
    }

    .key > * {
        margin: 5px;
        display: inline-block;
        vertical-align: middle;
    }

    .panel-heading {
        color: #ffffff !important;
        background-color: #006400 !important;
    }

    .visualControl-container {
        width: 100%;
    }

    .visualControl-container > * {
        margin: 5px;
        display: inline-block;
        vertical-align: middle;
    }

    #d3-container {
        position: relative;
    }

    #d3-visual {
        margin: auto;
        text-align: center;
    }

    #d3-legend {
        position: absolute;
        width: 15%;
    }

    #order
    {
        width: 15%;
    }
</style>

<div class="page-header">
	<h1>{{ title }}</h1>
</div>

<div id="ui-container">
    <form id="todo-id" class="form-horizontal" role="form" method="post">
        <div class="row">
            <div class="col-md-12">
                <div id="show-tool-options" 
                     style="color:#006400; cursor:pointer; font-weight:600; 
                            text-decoration:underline;">
                    Tool Options
                    <i id="tool-options-caret" class="fa fa-caret-left"></i>
                </div>
                <div id="tool-options" 
                     style="display:none; text-align:left; background-color:#ded;
                            border-radius:5px; padding:15px; width:30%">
                        <div >{{ macros.tool_param_radio(tool.params['JaccardClustering_Homology']) }}</div>
                        <div >{{ macros.tool_param_select(tool.params['JaccardClustering_Method']) }}</div>
                        <input type="hidden" name="genesets" value="{{async_result.gs_ids|join(' ') }}" />
                        <button class="btn btn-primary"
                            type='submit'
                            value='run'
                            onclick='this.form.action="{{ url_for('JaccardClustering.run_tool') }}";'>
                            Run
                        </button>
                </div>
            </div>
        </div>
    </form>
    <br />
    <div class="row">
        <div class="col-md-12">
            <div id="show-viz-options" 
                 style="color:#006400; cursor:pointer; font-weight:600; 
                        text-decoration:underline;">
                Visualization Options
                <i id="viz-options-caret" class="fa fa-caret-left"></i>
            </div>
            <div id="viz-options" 
                 style="display:none; text-align:left; background-color:#ded;
                        border-radius:5px; padding:15px; width:30%">
				<div class="row">
					<div class="col-md-4">
						<p style="font-size:13px; font-weight:400;">
							<b>Visualization Type:</b>
						</p>
					</div>
					<div class="col-md-8">
						<form role="form" method="post">
							<select id="visualizationType" name="visualizationType">
							</select>
						</form>
					</div>
				</div>
				<br />
				<div class="row">
					<div class="col-md-3">
						<div class="btn-group">
							<button type="button" 
                                    class="btn btn-primary dropdown-toggle" 
                                    data-toggle="dropdown" aria-haspopup="true" 
                                    aria-expanded="false">
								Download as...
								<span class="caret"></span>
							</button>
							<ul class="dropdown-menu">
								<li><a class="download-image" id="dl-pdf" href="">PDF</a></li>
								<li><a class="download-image" id="dl-png" href="">PNG</a></li>
								<li><a class="download-image" id="dl-svg" href="">SVG</a></li>
							</ul>
						</div>
					</div>
				</div>
            </div>
        </div>
    </div>
    <div id="d3-container" class="d3">
        <div id="d3-legend" class="d3"></div>
        <div id="d3-visual" class="d3"></div>
    </div>
</div>
	<script type="text/javascript" src="../../static/d3/d3.min.js"></script>
    <!--
	<script type="text/javascript" src="../../static/d3/d3.v4.min.js"></script>
    -->
	<script type="text/javascript" src="../../static/tools/ClusteringGraph.js"></script>
	<script type="text/javascript" src="../../static/tools/ClusteringSunburst.js"></script>
    <script type="text/javascript">
        $("select#visualizationType")
            .append('<option label="forceTree" value="forceTree" selected="selected">Directed Force Tree</option>')
            .append('<option label="sunburst" value="sunburst">Partitioned Sunburst</option>')
            ;

		var jsonPath = '{{ cluster_data | safe }}';
        var jsonData = null;

        //$(document).ready(visualize(jsonPath));
        $(document).ready(function() {

            d3.json(jsonPath, function(err, json) {
                jsonData = json;

                var clustering = clusteringGraph()
                    .jsonData(jsonData)
                    .draw()
                    .drawLegend();
            });


        $("select#visualizationType").change(function(event){

            d3.select('#d3-visual').selectAll('*').remove();

            if (event.target.value === 'sunburst') {

                var clustering = clusteringSunburst()
                    .jsonData(jsonData)
                    .draw()
                    .drawLegend()
                    ;

            } else {

                // Has to be re-read from the json file otherwise the tree is
                // generated outside the svg box. It's fucking weird.
                d3.json(jsonPath, function(err, json) {

                    var clustering = clusteringGraph()
                        .jsonData(json)
                        .draw()
                        .drawLegend()
                        ;
                });
            }
        });

        });
    </script>
<script>

    $(document).ready(function() {
        $('#show-tool-options').on('click', function() {

            $('#tool-options').slideToggle();

			var caret = $(this).find('.fa-caret-left');

            // Rotate the caret depending on whether the options bar is toggled
            if (caret.hasClass('fa-rotate-270'))
				caret.attr('class', 'fa fa-caret-left');
            else
				caret.attr('class', 'fa fa-caret-left fa-rotate-270');

        });

        $('#show-viz-options').on('click', function() {

            $('#viz-options').slideToggle();

			var caret = $(this).find('.fa-caret-left');

            // Rotate the caret depending on whether the options bar is toggled
            if (caret.hasClass('fa-rotate-270'))
				caret.attr('class', 'fa fa-caret-left');
            else
				caret.attr('class', 'fa fa-caret-left fa-rotate-270');

        });
    });

    $('.download-image').on('click', function(event) {

        var dlurl = '/downloadResult';
        // Removes 'dl-' from the id string
        var filetype = event.target.id.slice(3);

        // Gives our SVG a white background color prior to conversion.
        // This actually changes the image the user is seeing, but they
        // shouldn't be able to notice.
        d3.select('svg')
                .insert('rect', 'g')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('fill', 'white');

        var html = d3.select("svg")
                .attr("version", 1.1)
                .attr("xmlns", "http://www.w3.org/2000/svg")
                .node().parentNode.innerHTML;

        $.post(dlurl, {svg: html, filetype: filetype}).done(function(data) {

            if (filetype == 'png')
                var png = 'data:image/png;base64,' + data;

            else if (filetype == 'pdf')
                var png = 'data:application/pdf;base64,' + data;

            else
                var png = 'data:xml/svg;base64,' + data;

            var a = document.createElement("a");
            a.download = 'result.' + filetype;
            a.href = png;

            document.body.appendChild(a);

            a.click();
        });
    });
</script>

{% include 'footer.html' %}
