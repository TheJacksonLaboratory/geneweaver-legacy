{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<style type="text/css">
    .background {
        fill: #ffffff;
    }

    .d3 {
        width: 100%;
    }

    .key > * {
        margin: 5px;
        display: inline-block;
        vertical-align: middle;
    }

    .panel-heading {
        color: #ffffff !important;
        background-color: #006400 !important;
    }

    .visualControl-container {
        width: 100%;
    }

    .visualControl-container > * {
        margin: 5px;
        display: inline-block;
        vertical-align: middle;
    }

    #d3-container {
        position: relative;
    }

    #d3-visual {
        margin: auto;
        text-align: center;
    }

    #d3-legend {
        position: absolute;
        width: 15%;
    }

    #order
    {
        width: 15%;
    }

    .node circle {
      cursor: pointer;
    }

    /* mouse nodes */
    .mouse, line .mouse {
        fill: #eeb44f;
        stroke: #eeb44f;
    }

    .mouse:hover {
        fill: #a36d10;
        stroke: #a36d10;
    }

    /* human nodes */
    .human, line .human {
        fill: #d7c000;
        stroke: #d7c000;
    }

    .human:hover {
        fill: #807200;
        stroke: #807200;
    }

    /* rat nodes */
    .rat, line .rat {
        fill: #44fcf7;
        stroke: #44fcf7;
    }

    .rat:hover {
        fill: #03b0ab;
        stroke: #03b0ab;
    }

    /* fly nodes */
    .fly, line .fly {
        fill: #fca5b7;
        stroke: #fca5b7;
    }

    .fly:hover {
        fill: #f95275;
        stroke: #f95275;
    }

    /* zf nodes */
    .zebrafish, line .zebrafish {
        fill: #8fcb0a;
        stroke: #8fcb0a;
    }

    .zebrafish:hover {
        fill: #567a06;
        stroke: #567a06;
    }

    /* monkey nodes */
    .monkey, line .monkey {
        fill: #b4d1fb;
        stroke: #b4d1fb;
    }

    .monkey:hover {
        fill: #5697f6;
        stroke: #5697f6;
    }

    /* gene nodes */
    .gene, line .gene {
        fill: #cc00ff;
        stroke: #cc00ff;
    }

    .gene:hover {
        fill: #8f00b3;
        stroke: #8f00b3;
        opacity: .8;
    }

    /* cluster nodes */
    .cluster, line .cluster{
        fill: #0099ff;
        stroke: #0099ff;
    }

    path{
        stroke: #ffffff !important;
    }


    path[class=cluster]:hover{
        fill: #b3e0ff;
        stroke: #b3e0ff;
    }

    .collapsed-cluster, line .cluster {
        fill: #004d80;
        stroke: #004d80;
    }

    .node text {
      font: 10px sans-serif;
      pointer-events: none;
      text-anchor: middle;
    }

    line.link {
      fill: none;
      stroke-width: 2px;
    }
</style>

<div class="page-header">
	<h1>{{ title }}: {{ async_result.method }}</h1>
</div>
<p>Beta Tool: This tool is still under development, so it is not interactive at this time.</p>

<div id="ui-container">
        <form id="todo-id" class="form-horizontal" role="form" method="post">
        <div class="row">
            <div class="col-md-12">
                    <div class="panel panel-info">
                    <div class="panel-heading">
                        <h2 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#jcCollapse">
                                Tool Options
                            </a>
                        </h2>
                    </div>
                        <div class="">
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary">Download as...</button>
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="caret"></span>
                                    <span class="sr-only">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="download-image" id="dl-pdf">PDF</a></li>
                                    <li><a class="download-image" id="dl-png">PNG</a></li>
                                    <li><a class="download-image" id="dl-svg">SVG</a></li>
                                </ul>
                            </div>
                        </div>
                    <div id="jcCollapse" class="panel-collapse collapse">
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="from-group">{{ macros.tool_param_radio(tool.params['JaccardClustering_Homology']) }}</div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardClustering_Method']) }}</div>
                                </div>
                                <div class="col-md-4">
                                    <input type="hidden" name="genesets" value="{{async_result.gs_ids|join(' ') }}" />
                                    <button class="btn btn-primary"
                                        type='submit'
                                        value='run'
                                        onclick='this.form.action="{{ url_for('JaccardClustering.run_tool') }}";'>
                                        Run
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    <form class="visualControl-container" role="form" method="post">
        <label for="visualizationType">Visualization Type:</label>
        <div>
            <select class="form-control tooltip-enabled" id="visualizationType" name="visualizationType">
            </select>
        </div>
    </form>
    <div id="d3-container" class="d3">
        <div id="d3-legend" class="d3"></div>
        <div id="d3-visual" class="d3"></div>
    </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
        if('{{ async_result.method }}' != 'Heatmap'){
            $("select#visualizationType").append('<option label="forceTree" value="forceTree" selected="selected">Directed Force Tree</option>').append('<option label="sunburst" value="sunburst">Partitioned Sunburst</option>')
        }
        else
        {
            $("select#visualizationType").append('<option label="heatmap" value="heatmap" selected="selected">Jaccard Heatmap</option>')
        }

        $(document).ready(visualize());
        $("select#visualizationType").change(function(){
            console.log('changed!');
            visualize();
        });
        function visualize() {
            $("div#d3-visual").empty();
            var width = document.getElementById("d3-container").offsetWidth,
                height = document.getElementById("d3-container").offsetWidth / 1.5
            if ($("select#visualizationType").val() == "forceTree") {
                var root;

                var svg = d3.select("#d3-visual").append("svg")
                        .attr("width", width)
                        .attr("height", height);

                var link = svg.selectAll(".link"),
                        node = svg.selectAll(".node");

                var force, k;

                d3.json("{{ cluster_data }}", function (error, json) {
                    if (error) throw error;

                    root = json;

                    k = Math.sqrt(root.length / (width * height));

                    force = d3.layout.force()
                            .linkDistance(function (d) {
                                return d.target.level == 0 ? 150 : 50;
                            })
                            .charge(-50)
                            .gravity(.02)
                            .size([width, height])
                            .on("tick", tick);

                    var elements = flatten(root);

                    //Collapse genes into genesets by default
                    for (var n in elements) {
                        if (elements[n].type == "geneset") {
                            collapse(elements[n]);
                        }
                    }

                    update();
                });

                function update() {
                    var nodes = flatten(root),
                            links = d3.layout.tree().links(nodes),
                            treeHeight = root.height;

                    // Restart the force layout.
                    force
                            .nodes(nodes)
                            .links(links)
                            .start();

                    // Update links.
                    link = link.data(links, function (d) {
                        return d.target.id;
                    });

                    link.exit().remove();

                    link.enter().insert("line", ".node")
                            .attr("class", species)
                            .style("opacity", opac);

                    // Update nodes.
                    node = node.data(nodes, function (d) {
                        return d.id;
                    });
                    node.exit().remove();

                    var nodeEnter = node.enter().append("g")
                            .attr("class", "node")
                            .on("click", click)
                            .call(force.drag);

                    nodeEnter.append("circle")
                            .attr("r", radius)
                            .attr("class", species)
                            .style("opacity", opac);

                    nodeEnter.append("text")
                            .attr("dy", dist)
                            .attr("dx", dist)
                            .text(label);

                    node.on("mouseover", mouseover);
                    node.on("mouseout", mouseout);
                    node.on("dblclick", dblclick);
                }

                function tick() {
                    link.attr("x1", function (d) {
                        return d.source.x;
                    })
                            .attr("y1", function (d) {
                                return d.source.y;
                            })
                            .attr("x2", function (d) {
                                return d.target.x;
                            })
                            .attr("y2", function (d) {
                                return d.target.y;
                            });

                    node.attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    });
                }

                function dist(d) {
                    return -1 * (radius(d) + 5)
                }

                function radius(d) {
                    return d.type == 'collapsed-cluster' ? d.size * 2
                            : d.size ? d.size
                            : 0;
                }

                // Toggle children on click.
                function click(d) {
                    if (d3.event.defaultPrevented) return; // ignore drag
                    if (d.genes) {
                        console.log(d.g_index);
                        if (d.g_index >= d.genes.length) {
                            console.log('collapse.');
                            d.children = null;
                            d.g_index = 0;
                        }
                        else if (d.g_index + 10 < d.genes.length) {
                            console.log('expand +10.');
                            d.children = d.genes.slice(d.g_index, d.g_index + 10);
                            d.g_index += 10;
                        }
                        else {
                            console.log('expand remaining.');
                            d.children = d.genes.slice(d.g_index);
                            d.g_index = d.genes.length;
                        }

                    } else {
                        if (d.children) {
                            d.type = 'collapsed-cluster';
                            d._children = d.children;
                            d.children = null;
                        } else {
                            d.type = 'cluster';
                            d.children = d._children;
                            d._children = null;
                        }

                        var nodeSelected = d3.select(this);
                        nodeSelected.select("circle").attr("class", species);
                    }

                    update();
                }

                // Toggle children on click.
                function collapse(d) {
                    if (d.children) {
                        d.genes = d.children;
                        d.g_index = 0;
                        d.children = null;
                    }
                }

                function mouseover(d) {

                    if (d.type == "cluster") {
                        var nodeSelected = d3.select(this);
                        nodeSelected.select("circle").attr("r", d.size + 10);
                        nodeSelected.select("text").attr("dy", "0.5em");
                        nodeSelected.select("text").attr("dx", "0em");
                        nodeSelected.select("text").text(d.jaccard_index.toPrecision(2));
                    }
                    else if (d.type == "geneset") {
                        var nodeSelected = d3.select(this);
                        nodeSelected.select("text").text(d.info);
                    }
                    else {
                        var nodeSelected = d3.select(this);
                        nodeSelected.select("circle").attr("r", d.size * 2);
                        nodeSelected.select("text").text(d.name);
                    }
                }

                function mouseout(d) {

                    var nodeSelected = d3.select(this);
                    nodeSelected.select("circle").attr("r", radius);
                    nodeSelected.select("text").attr("dy", dist);
                    nodeSelected.select("text").attr("dx", dist);
                    nodeSelected.select("text").text(label);
                }

                // Returns a list of all nodes under the root.
                function flatten(root) {
                    var nodes = [], i = 0;

                    function recurse(node) {
                        if (node.children) node.children.forEach(recurse);
                        if (!node.id) node.id = ++i;
                        nodes.push(node);
                    }

                    recurse(root);
                    return nodes;
                }
            } else if ($("select#visualizationType").val() == "sunburst") {
                var radius = Math.min(width, height) / 3;

                var x = d3.scale.linear()
                    .range([0, 2 * Math.PI]);

                var y = d3.scale.linear()
                    .range([0, radius]);

                var color = d3.scale.category20c();

                var svg = d3.select("#d3-visual").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                  .append("g")
                    .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

                var partition = d3.layout.partition()
                    .value(function(d) { return d.size; });

                var arc = d3.svg.arc()
                    .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
                    .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
                    .innerRadius(function(d) { return Math.max(0, y(d.y)); })
                    .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

                d3.json("{{ cluster_data }}", function(error, root) {
                  var g = svg.selectAll("g")
                      .data(partition.nodes(root))
                    .enter().append("g")
                          .on("mouseover", mouseover)
                    .on("mouseout", mouseout);

                  var path = g.append("path")
                          .attr("id", function(d){return d.name})
                    .attr("d", arc)
                    .attr("class", species)
                    .attr("opacity",opac)
                    .on("click", click)
                    .on("dblclick",dblclick);

                  var text = g.append("text")
                    .attr("transform", function(d) { return "rotate(" + computeTextRotation(d) + ")"; })
                    .attr("x", function(d) { return y(d.y + d.dy +.4); })
                    .attr("dx", "6") // margin
                    .attr("dy", ".35em") // vertical-align
                    .text(label);

                  function click(d) {
                    // fade out all text elements
                    text.transition().attr("opacity", 0);

                    path.transition()
                      .duration(750)
                      .attrTween("d", arcTween(d))
                      .each("end", function(e, i) {
                          // check if the animated element's data e lies within the visible angle span given in d
                          if (e.x >= d.x && e.x < (d.x + d.dx)) {
                            // get a selection of the associated text element
                            var arcText = d3.select(this.parentNode).select("text");
                            // fade in the text element and recalculate positions
                            arcText.transition().duration(750)
                              .attr("opacity", 1)
                              .attr("transform", function() { return "rotate(" + computeTextRotation(e) + ")" })
                              .attr("x", function(d) { return y(d.y +.25); });
                          }
                      });
                  }
                });

                d3.select(self.frameElement).style("height", height + "px");

                // Interpolate the scales!
                function arcTween(d) {
                  var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
                      yd = d3.interpolate(y.domain(), [d.y, 1]),
                      yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
                  return function(d, i) {
                    return i
                        ? function(t) { return arc(d); }
                        : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
                  };
                }

                function computeTextRotation(d) {
                  return (x(d.x + d.dx / 2) - Math.PI / 2) / Math.PI * 180;
                }

                function mouseover(d) {
                    if (d.type == "cluster") {
                        var nodeSelected = d3.select(this);
                        nodeSelected.select("text")
                                .attr("x", function(d) { return y(d.y-.01); })
                                .text(d.jaccard_index.toPrecision(2));
                    }
                    else if (d.type == "geneset") {
                        var nodeSelected = d3.select(this);
                        var nodeName = d.name;
                        svg.selectAll("text").transition().attr("opacity",function(d){return d.name != nodeName ? .2 : 1});
                    }
                    else if(d.type == "gene"){
                        var nodeSelected = d3.select(this);
                        var nodeName = d.name;
                        nodeSelected.select("text").text(d.name);
                        svg.selectAll("text").transition().attr("opacity",function(d){return d.name != nodeName ? .2 : 1});
                    }
                }

                function mouseout(d) {
                    var nodeSelected = d3.select(this);
                    nodeSelected.select("text").text(label);
                    svg.selectAll("text").transition().attr("opacity",1);
                }
            } else {
                var margin = {top: 80, right: 0, bottom: 10, left: 80},
                        width = height;

                var x = d3.scale.ordinal().rangeBands([0, width]),
                    z = d3.scale.linear().domain([0, 4]).clamp(true),
                    c = d3.scale.category10().domain(d3.range(10));

                var svg = d3.select("#d3-visual").append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .style("margin-left", -margin.left + "px")
                  .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                $(".visualControl-container").append('<label for="order">Sort by:</label>')
                        .append('<select id="order" class="form-control tooltip-enabled"><select>');
                $("#order").append('<option id="name" value="name">Alphabetic Order</option>')
                        .append('<option id="count" value="count" selected="selected">Jaccard Similarity</option>');

                d3.json("{{ cluster_data }}", function(miserables) {
                  var matrix = [],
                      nodes = miserables.nodes,
                      n = nodes.length;

                  // Compute index per node.
                  nodes.forEach(function(node, i) {
                    node.index = i;
                    node.count = 0;
                    matrix[i] = d3.range(n).map(function(j) { return {x: j, y: i, z: 0}; });
                  });

                  // Convert links to matrix; count character occurrences.
                  miserables.links.forEach(function(link) {
                    matrix[link.source][link.target].z += link.value;
                    matrix[link.target][link.source].z += link.value;
                    matrix[link.source][link.source].z += link.value;
                    matrix[link.target][link.target].z += link.value;
                    nodes[link.source].count += link.value;
                    nodes[link.target].count += link.value;
                  });

                  // Precompute the orders.
                  var orders = {
                    name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].name, nodes[b].name); }),
                    count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; }),
                    group: d3.range(n).sort(function(a, b) { return nodes[b].group - nodes[a].group; })
                  };

                  // The default sort order.
                  x.domain(orders.name);

                  svg.append("rect")
                      .attr("class", "background")
                      .attr("width", height)
                      .attr("height", height);

                  var row = svg.selectAll(".row")
                      .data(matrix)
                    .enter().append("g")
                      .attr("class", "row")
                      .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
                      .each(row);

                  row.append("line")
                      .attr("x2", width);

                  row.append("text")
                      .attr("x", -6)
                      .attr("y", x.rangeBand() / 2)
                      .attr("dy", ".32em")
                      .attr("text-anchor", "end")
                      .text(function(d, i) { return nodes[i].name; });

                  var column = svg.selectAll(".column")
                      .data(matrix)
                    .enter().append("g")
                      .attr("class", "column")
                      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

                  column.append("line")
                      .attr("x1", -width);

                  column.append("text")
                      .attr("x", 6)
                      .attr("y", x.rangeBand() / 2)
                      .attr("dy", ".32em")
                      .attr("text-anchor", "start")
                      .text(function(d, i) { return nodes[i].name; });

                  function row(row) {
                    var cell = d3.select(this).selectAll(".cell")
                        .data(row.filter(function(d) { return d.z; }))
                        .enter().append("g")
                            .attr("id","label")
                        .append("rect")
                        .attr("class", "cell")
                        .attr("x", function(d) { return x(d.x); })
                        .attr("width", x.rangeBand())
                        .attr("height", x.rangeBand())
                        .style("fill-opacity", function(d) { return z(d.z); })
                        .style("fill", function(d) { return nodes[d.x].group == nodes[d.y].group ? c(nodes[d.x].group) : null; })
                        .on("mouseover", mouseover)
                        .on("mouseout", mouseout);
                  }



                  function mouseover(p) {
                    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
                    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
                  }

                  function mouseout() {
                    d3.selectAll("text").classed("active", false);
                  }

                    function showLabel(d) {
                        var nodeSelected = d3.select(this);
                        nodeSelected.select("text").text(d.value);
                    }

                  d3.select("#order").on("change", function() {
                    clearTimeout(timeout);
                    order(this.value);
                  });

                  function order(value) {
                    x.domain(orders[value]);

                    var t = svg.transition().duration(2500);

                    t.selectAll(".row")
                        .delay(function(d, i) { return x(i) * 4; })
                        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
                      .selectAll(".cell")
                        .delay(function(d) { return x(d.x) * 4; })
                        .attr("x", function(d) { return x(d.x); });

                    t.selectAll(".column")
                        .delay(function(d, i) { return x(i) * 4; })
                        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
                  }

                  var timeout = setTimeout(function() {
                    order("count");
                    d3.select("#order").property("selectedIndex", 1).node().focus();
                  }, 5000);
                });

            }
        }

        function label(d) {
            return d.type == "geneset" ? d.name : '';
        }

        function opac(d) {
            if (d.name) {
                return d.name == "root" ? "0"
                        : d.type == "geneset" ? 1
                        : d.type == "gene" ? .4
                        : d.jaccard_index + .08;
            }
            return d.source.name == "root" ? "0"
                    : d.source.type == "geneset" ? .2
                    : d.source.jaccard_index + .08;

        }

        function species(d) {
            if (d.species) {
                var _species;

                if (d.species == "Macaca mulatta") {
                    _species = "monkey"
                }
                else if (d.species == "Canis familiaris") {
                    _species = "dog"
                }
                else if (d.species == "Mus musculus") {
                    _species = "mouse"
                }
                else if (d.species == "Rattus norvegicus") {
                    _species = "rat"
                }
                else if (d.species == "Drosophila melanogaster") {
                    _species = "fly"
                }
                else if (d.species == "Danio rerio") {
                    _species = "zebrafish"
                }
                else if (d.species == "Caenorhabditis elegans") {
                    _species = "nematode"
                }
                else if (d.species == "Gallus gallus") {
                    _species = "chicken"
                }
                else if (d.species == "Saccharomyces cerevisiae") {
                    _species = "yeast"
                }
                else if (d.species == "Homo sapiens") {
                    _species = "human"
                }

                if (!$("#" + _species + "_key").length) {
                    var key = d3.select("#d3-legend").append("div")
                            .attr("id", _species + "_key")
                            .attr("class", "key");

                    key.append("rect")
                            .attr("class", _species)
                            .style("width", "20px")
                            .style("height", "20px");

                    key.append("p").text(_species);
                }

                return _species
            }
            else if (d.type) {
                return d.type;
            }
            else if (d.source.type == "geneset") {
                return "link " + species(d.source);
            }
            else {
                return "link " + d.source.type;
            }
        }

        function dblclick(d) {
            if (d.type == 'geneset') {
                window.open("/viewgenesetdetails/" + d.id);
            }
        }
    </script>
<script>
    $('.download-image').on('click', function(event) {

        var dlurl = '/downloadResult';
        // Removes 'dl-' from the id string
        var filetype = event.target.id.slice(3);

        // Gives our SVG a white background color prior to conversion.
        // This actually changes the image the user is seeing, but they
        // shouldn't be able to notice.
        d3.select('svg')
                .insert('rect', 'g')
                .attr('width', '100%')
                .attr('height', '100%')
                .attr('fill', 'white');

        var html = d3.select("svg")
                .attr("version", 1.1)
                .attr("xmlns", "http://www.w3.org/2000/svg")
                .node().parentNode.innerHTML;

        $.post(dlurl, {svg: html, filetype: filetype}).done(function(data) {

            if (filetype == 'png')
                var png = 'data:image/png;base64,' + data;

            else if (filetype == 'pdf')
                var png = 'data:application/pdf;base64,' + data;

            else
                var png = 'data:xml/svg;base64,' + data;

            var a = document.createElement("a");
            a.download = 'result.' + filetype;
            a.href = png;

            document.body.appendChild(a);

            a.click();
        });
    });
</script>

{% include 'footer.html' %}