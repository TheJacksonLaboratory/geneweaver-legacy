{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<style>


#panel, #flip {
    padding: 5px;
    text-align: left;
}

#panel {
    display: none;
    background-color: #FFFFFF;
}

#flip {
 height: 50px;
}

#rerunPanel, #rerunFlip {
    padding: 5px;
    text-align: left;
}

#rerunPanel {
    height: 350px;
    text-align: left;
    display: none;
}

#rerunFlip {
   height: 50px;
   text-shadow: none;
}
#rerun{
 float:right;
    display:block;
    margin-right: 585px;
    clear:left;
 }

.left-cell {
  vertical-align: middle;
  width: 200px;
}

.right-cell {
  display: table-cell;
  vertical-align: middle;
  text-align: right;
  right: 0;
}

.middle-cell {
  display: table-cell;
  vertical-align: middle;
  text-align: left;
  padding-left: 320px;
}

.box-header {
  padding-bottom: 5px;
  display: table;
  width: 90%;
}
.form-group{
 padding-right: 300px;
 }

#addToProject, #exportData {
    float: left;
}

 .divider{
    margin: 5px;
}

#checkall{
    float: left;
}

.page-header {
    border-bottom-width: thick;
    border-bottom-color: #006400;
}

.axis path,
.axis line {
    fill: none;
}

</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/static/d3/d3.min.js" charset="utf-8"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>


{% if g.user is defined %}
    {% include 'modal/addGenesetsToProjects.html' %}
{% endif %}
{% include 'modal/addGenesetsToProjectsAlert.html' %}


<div class="panel panel-default panel-heading bg-gray-light">
    <h3 class="panel-title"><strong>{{ title }} </strong> <span id="what" data-toggle="tooltip"><i class="fa fa-info-circle"></i></span></h3>
</div>

<div id="rerunFlip" style="font-size: 1.25em" class="ui-btn ui-btn-inline  ui-corner-all header project-link "><i class="fa fa-plus">  Rerun Tool Options</i></div>

<div id="rerunPanel" >
    <form id="todo-id" class="form-horizontal" role="form" method="post">
        <div class="form-group" >{{ macros.tool_param_radio(tool.params['JaccardSimilarity_Homology']) }}</div>
        <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardSimilarity_PairwiseDeletion']) }}</div>
        <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardSimilarity_p-Value']) }}</div>
        <input type="hidden" name="genesets" value="{{async_result.gs_ids|join(' ') }}" />
        <button id="rerun" class="btn btn-primary"
           type='submit'x
           value='run'
           onclick='this.form.action="{{ url_for('JaccardSimilarity.run_tool') }}";'>
           Run
        </button>
     </form>
</div>
<br>

<div id="flip" style="font-size: 1.25em" class="ui-btn ui-btn-inline ui-corner-all project-link header "> <i class="fa fa-plus">Geneset Table Panel</i></div>
<div id="panel" class="badger-left">

<button type="button" value="Update" id="zoomButtonChart" class="ui-btn ui-btn-inline ui-corner-all ui-shadow ui-btn-b  ui-icon-check header" onclick="updateZoom()">Reset Chart</button>
<div id="chart"></div>
    <div><form action="#" method="post" id="myform">
        <div class=" pull-left"><input type="checkbox" onClick="toggle(this)" name="checkall" id="checkall" style="font-weight: 300"> <label for="checkall">Select all</label></div>
         </form></div>
         <p></p><br><br><br>
         <button type="button" class="btn btn-lg btn-warning divider" id="addToProject">
            <i class="fa fa-folder-o pull-left"></i> Add to Project
         </button>

        <button type="button" class="btn btn-lg btn-warning divider" id="exportData">
            <i class="fa fa-download pull-left"></i> Export Genes
        </button>
</div>

<div class="page-header"> </div>
<p>
<div class="box-header clearfix">
      <div class = "left-cell">
         <h4>Venn Diagram view:</h4>
      </div>
      <p style="font-size: 1em; font-weight: normal;">
      <div class="container middle-cell">
         <div class="dropdown middle-cell">
             <button class="btn btn-primary dropdown-toggle" id="menu1" type="button" data-toggle="dropdown"><i class="fa fa-download pull-left">   Download as</i>
             <span class="caret"></span></button>
              <ul class="dropdown-menu dropdown-menu-right" id="menudrop" role="menu" aria-labelledby="menu1" onChange="download(this.value)">
                  <li role="presentation"><a role="menuitem" tabindex="-1" value="a_file.svg">SVG</a></li>
                  <li role="presentation"><a role="menuitem" tabindex="-1" value="a_file.pdf" >PDF</a></li>
                  <li role="presentation"><a role="menuitem" tabindex="-1"  value="a_file.png"  href="https://www.google.com">PNG</a></li>
              </ul>
         </div>
      </div>
            <div class="right-cell">
         <button type="button" value="Update" id="zoomButton" class="ui-btn ui-btn-inline ui-corner-all ui-shadow ui-btn-b  ui-icon-check header">Reset Zoom</button>
      </div>
</div>


<div id="xaxisLeg"><img src="/static/images/lavenderdot.png" > = X-Axis Geneset</div>
<div id="yaxisLeg"><img src="/static/images/pinkreddot.png" > = Y-Axis Geneset</div>
<div id="genesetLeg"> <img src="/static/images/cyandot.png" > = Same Geneset</div>
<div id="empLeg"> <img src="/static/images/chartreusedot.png" > = Contains Emphasis Gene
<div id="pvalLeg"> <img src="/static/images/whitedot.png" > = Geneset Did Not Meet Threshold</div></p></div>


{#Location for where the d3 is appended to in the html#}
<div id="jaccard">
    <div id=divError class="alert alert-danger fade in">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
        The p-value threshold is too high, please run the tool again at a lower threshold.
    </div>
</div>


  <label for="nOpacity">
{#         style="display: inline-block; width: 240px; text-align: left">#}
        <h2 id="pthresh">P-Value Threshold (0.05 increments):
      <label  style="font-weight: bold" id="nOpacity-value">â€¦</label></h2>
  </label>

  <input type="range" min="0" max="1" step = "0.05" id="nOpacity">
</p>
<br>
<br>





{# Start of script#}
<script type="text/javascript">
 function isIn(arr, x) {
    for(var i = 0; i < arr.length; i++) {
        if(arr[i] === x) return true;
    }
    return false;
}

// function to reduce matrix based on pValues and threshold
function reduceMatrix() {
    // create pMatrix
    var pMatrix = []; // Array of Arrays (Matrix data structure)
    var row = [];     // Each Array element of pMatrix
    var elim = [];    // Array of rows (and columns) git to be removed

    for(var i = 0; i < count; i++) {
        var str = "-1";
        if(i % num_sets === 0 && i > 2) {
            pMatrix.push(row);
            row = [];
        }
        count_text = 0;
        for(var key in d.venn_diagrams[i].text) {
            if(d.venn_diagrams[i].text.hasOwnProperty(key)) {
                ++count_text;
            }
        }
        if(count_text >= 3) {
            str = d.venn_diagrams[i].text[2].text;
            str = str.replace("p =", "");
            str = str.replace(/^\s+|\s+$/g, '');
            str === "" ? str = "-1" : str = str;
            if(parseFloat(str) < d.JaccardSimilarity_p_Value) {
              console.log(str + " is less than " + d.JaccardSimilarity_p_Value.toString())
              str = "-1";
            }
            row.push(str);
        } else {
            row.push("-1");
        }
    }

    pMatrix.push(row);
    console.log(pMatrix);
    var counter = 0;
    for(var h = 0; h < pMatrix.length; h++) {
        var isNull = true;
        for(var j = 0; j < pMatrix[h].length; j++) {
            if(pMatrix[h][j].localeCompare("-1") != 0 && pMatrix[h][j].localeCompare("1") != 0) {
                isNull = false;
                break;
            }
        }
        if(isNull == true) {
            elim.push(counter);
        }
        counter++;
    }
   return elim;
}



   var d = {{ data | safe }}; //Declaration of data as d variable

   {# Checks number of objects venn_diagram has#}
   var count = 0;
   for (var key in d.venn_diagrams)
       if (d.venn_diagrams.hasOwnProperty(key))
           count++;

   var count_text = 0; // Counts number of text objects in venn_diagrams text set
   var check = 0; // Used to keep track of label id for gene sets that are overlapping with themselves
   var gene_lab_coor = []; // Array used to define the coordinates of the graph
   var circleData = []; // Array for all elements of each venn_diagram circle object
   var num_sets = Math.sqrt(count); // Finds the length and width of entire chart (object wise)

   var x_coord = 0, y_coord = 0; // Sets the graph coordinates to 0,0

   var gene_sets = []; //Array to hold the value for gene_sets set in jSon data
   gene_sets = d.geneset_table;

   var gene_ids = []; //Array to hold individual gene set ids (w/o the GS) to get the url
   var gid= "";

   var str = ""; // Create string to hold titles
   var row = -1; // Create variable to store row number

   {# Intializes gene_ids array for click url functionality#}
   for (i= 0; i<gene_sets.length; i++){
       gene_ids[i] = gid;
   }

   {# Gets URLs for click function#}
   var gene_url = [];
   var geneurl_text = "";
   gene_url = d.genesets;

    {# Intializes gene_ids array for click url functionality#}
   for (i= 0; i<gene_url.length; i++){
       geneurl_text = gene_url[i].substring(2);
       gene_url[i] = geneurl_text;
   }

   var threshold = false;
   var pValues = [];
   var pValueCount = 0;
   var isPVal = "p = ";

   for (i = 0; i < count; i++) {

       count_text = 0;

       for (var key in d.venn_diagrams[i].text) {
           if (d.venn_diagrams[i].text.hasOwnProperty(key)) {
               ++count_text;
           }
       }

       for (k = 0; k < count_text; k++) {

           var str = d.venn_diagrams[i].text[k].text;

           if(str.search(isPVal) != -1){
               str = str.replace("p =", "");
               str=str.replace(/^\s+|\s+$/g,'');
               pValues[pValueCount] =  str;
               pValueCount += 1;
           }
       }
   }


   console.log("count", count);
   var elim = reduceMatrix();
   console.log(elim);
   var row_count = 0;
   var first_run = true;

   {# Plots the graph in a correct fashion by incrementing differently for different items in the set#}
   var xVal = -1;
   var yVal = -1;
   var skipMe = false;
   for (i = 0; i < count; i++) {
       var str = "-1";

       xVal++;

       if (i % num_sets === 0) {

           row_count++;
           x_coord = 150;
           yVal++;
           xVal = 0;
           console.log("xVal = " + xVal);

           if (first_run) {
               y_coord = 50;
               first_run = false;
               row_count = 0;
           }

           if(isIn(elim, row_count)) { // Skip a row
               console.log("row " + row_count + " is in elim");
               i += num_sets-1;
               console.log("i = " + i);
               continue;
           }
           else if(isIn(elim, i % num_sets)) {  // Skip a column
               console.log("first col")
               console.log("element " + i + " (modulo " + num_sets + " = " + i % num_sets +") is in elim");
               i++;
               xVal++;
               console.log("else xVal = " + xVal);
               console.log("i = " + i);
               y_coord += 150;
               continue;
           }

           y_coord += 150;
       }
       else {
          
           if(isIn(elim, i % num_sets)) {  // Skip a column
               console.log("column")
               console.log("element " + i + " (modulo " + num_sets + " = " + i % num_sets +") is in elim");
               console.log("else xVal = " + xVal);
               console.log("i = " + i);
               if(i % num_sets === 0) {
                  i--;
                  xVal = -1;
               }
              continue;
           }
       }

       x_coord += 200;

       if(i >= count) {
           console.log("i was " + i );
           break;
       }

       console.log("row count: " + row_count + ", num sets: " + num_sets);

       if(elim.length === num_sets){
    Â Â Â Â Â Â Â $('#nOpacity-value').hide();
    Â Â Â Â Â Â Â $('#nOpacity').hide();
    Â Â Â Â Â Â Â $('#thresholdMsg').hide();
    Â Â Â Â Â Â Â $('#zoomButton').hide();
    Â Â Â Â Â Â Â $('#menu1').hide();
    Â Â Â Â Â Â Â $('#empLeg').hide();
           $('#pvalLeg').hide();
    Â Â Â Â Â Â Â $('#genesetLeg').hide();
    Â Â Â Â Â Â Â $('#yaxisLeg').hide();
    Â Â Â Â Â Â Â $('#xaxisLeg').hide();
           $('#pthresh').hide();
           $('#jaccard').hide();
      }
      else{
      Â Â Â Â Â $('#divError').hide();
      }

      {# Pushes the coordinates of tx and ty into the gene_lab_coord array #}
       gene_lab_coor.push([d.venn_diagrams[i].tx, d.venn_diagrams[i].ty]);

       {# Resets the count_text value to 0 #}
       count_text = 0;

        {# Counts the number of objects in venn_diagram's text set #}
       for (var key in d.venn_diagrams[i].text) {
          if (d.venn_diagrams[i].text.hasOwnProperty(key)) {
             ++count_text;
          }
       }

       {#  Read through k times and create text labels based upon k's value  #}
       for (k = 0; k < count_text; k++) {
          var isPVal = "p = ";

             if (k === 2) {
                str = d.venn_diagrams[i].text[k].text;
                str = str.replace("p =", "");
                str = str.replace(/^\s+|\s+$/g, '');
             }

            {#  When values of c1,c2 are the same then make turquoise circle with initialized objects in json #}
            if (d.venn_diagrams[i].r1 === d.venn_diagrams[i].r2) {
              if((d.venn_diagrams[i].emphasis1 == "False" ) && (d.venn_diagrams[i].emphasis2 == "False")){
                circleData.push({
                    "cx": d.venn_diagrams[i].c2x,
                    "cy": d.venn_diagrams[i].c2y,
                    "radius": d.venn_diagrams[i].r2,
                    "fill": "#99FFFF",
                    "opacity": d.venn_diagrams[i].opacity,
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "des": d.venn_diagrams[i].desc1,
                     "url":   '/viewgenesetdetails/' + gene_url[xVal],
                    "title" : d.venn_diagrams[i].title1,
                    "pvalue" : str,
                    "show" : threshold,
                    "row" : xVal, 
                    "col" : yVal


                });
              }
              else{
                circleData.push({
                    "cx": d.venn_diagrams[i].c2x,
                    "cy": d.venn_diagrams[i].c2y,
                    "radius": d.venn_diagrams[i].r2,
                    "fill": "chartreuse",
                    "opacity": d.venn_diagrams[i].opacity,
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "des": d.venn_diagrams[i].desc1,
                     "url":   '/viewgenesetdetails/' + gene_url[xVal],
                    "title" : d.venn_diagrams[i].title1,
                    "pvalue" : str,
                    "show" : threshold,
                    "row" : xVal, 
                    "col" : yVal


                });
              }
                 row +=1;

                {# When the object number i is 0 and its text value is k then read in the text for jaccard and p-value with appropriate coordinates#}
                if((i === 0) && (k === 0)) {



                     circleData.push({
                            "gene_id": d.venn_diagrams[i].text[k].text,
                            "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 27,
                            "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 40,
                            "label": d.geneset_table[xVal].text.substring(0, 25), //d.geneset_table[check].text.replace(/\.(?=[A-Z])/g, '<br /><br />'),
                            "label1": d.geneset_table[xVal].text.substring(25, 50),
                            "labelx": x_coord,
                            "labely": y_coord,
                            "pvalue" : str,
                            "show" : threshold

                        });
                        check += 1;
                }

                {# Else (FIXES OVERLAP) object is not i = 0, text k is 0, and is a diagonal then intializes jaccard, p and coordinate values#}
                else if ( (k===0) && (i !== 0) && (i%(num_sets+1) ===0)){
                        circleData.push({
                            "gene_id": d.venn_diagrams[i].text[k].text,
                            "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 27,
                            "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 40,
                            "label":  d.geneset_table[xVal].text.substring(0, 25),
                            "label1": d.geneset_table[xVal].text.substring(25, 50),
                            "labelx": x_coord,
                            "labely": y_coord,
                            "pvalue" : str,
                            "show" : threshold

                        });
                        check += 1;
                }

                {# If k or i is different push the label onto the circledata array #}
                else {
                    circleData.push({
                        "gene_id": d.venn_diagrams[i].text[k].text,
                        "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 18,
                        "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 24,
                        "pvalue" : str,
                        "show" : threshold
                    });
                }

            }

{#  Else make circles for orange and blue with appropriate json values #}
            else {

                  if (d.venn_diagrams[i].r2 > d.venn_diagrams[i].r1) {

                    if (d.venn_diagrams[i].emphasis1 == "False"){
                      circleData.push({
                          "cx": d.venn_diagrams[i].c1x,
                          "cy": d.venn_diagrams[i].c1y,
                          "radius": d.venn_diagrams[i].r1,
                          "fill": "#FF6666",
                          "opacity": d.venn_diagrams[i].opacity,
                          "cxshift": x_coord,
                          "cyshift": y_coord,
                          "gene_id": d.venn_diagrams[i].text[k].text,
                          "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                          "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                          "des": d.venn_diagrams[i].desc1,
                          "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                          "title" : d.venn_diagrams[i].title1,
                          "pvalue" : str,
                          "show" : threshold,
                          "url1":   d.venn_diagrams[i].url,
                          "row" : xVal, 
                          "col" : yVal
                      });
                    }
                    else{
                      circleData.push({
                          "cx": d.venn_diagrams[i].c1x,
                          "cy": d.venn_diagrams[i].c1y,
                          "radius": d.venn_diagrams[i].r1,
                          "fill": "chartreuse",
                          "opacity": d.venn_diagrams[i].opacity,
                          "cxshift": x_coord,
                          "cyshift": y_coord,
                          "gene_id": d.venn_diagrams[i].text[k].text,
                          "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                          "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                          "des": d.venn_diagrams[i].desc1,
                          "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                          "title" : d.venn_diagrams[i].title1,
                          "pvalue" : str,
                          "show" : threshold,
                          "url1":   d.venn_diagrams[i].url,
                          "row" : xVal, 
                          "col" : yVal
                      });
                    }

                    if (d.venn_diagrams[i].emphasis2 == "False"){
                      circleData.push({
                          "cx": d.venn_diagrams[i].c2x,
                          "cy": d.venn_diagrams[i].c2y,
                          "radius": d.venn_diagrams[i].r2,
                          "fill": "#DD99FF",
                          "opacity": d.venn_diagrams[i].opacity,
                          "cxshift": x_coord,
                          "cyshift": y_coord,
                          "gene_id": d.venn_diagrams[i].text[k].text,
                          "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                          "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                          "des": d.venn_diagrams[i].desc1,
                          "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                          "title" : d.venn_diagrams[i].title1,
                          "pvalue" : str,
                          "show" : threshold,
                          "url1":   d.venn_diagrams[i].url,
                          "row" : xVal, 
                          "col" : yVal
                      });
                    }
                    else{
                      circleData.push({
                          "cx": d.venn_diagrams[i].c2x,
                          "cy": d.venn_diagrams[i].c2y,
                          "radius": d.venn_diagrams[i].r2,
                          "fill": "chartreuse",
                          "opacity": d.venn_diagrams[i].opacity,
                          "cxshift": x_coord,
                          "cyshift": y_coord,
                          "gene_id": d.venn_diagrams[i].text[k].text,
                          "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                          "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                          "des": d.venn_diagrams[i].desc1,
                          "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                          "title" : d.venn_diagrams[i].title1,
                          "pvalue" : str,
                          "show" : threshold,
                          "url1":   d.venn_diagrams[i].url,
                          "row" : xVal, 
                          "col" : yVal
                      });
                    }

                }
                  
              else{

                     if (d.venn_diagrams[i].emphasis2 == "False"){
                      circleData.push({
                          "cx": d.venn_diagrams[i].c2x,
                          "cy": d.venn_diagrams[i].c2y,
                          "radius": d.venn_diagrams[i].r2,
                          "fill": "#DD99FF",
                          "opacity": d.venn_diagrams[i].opacity,
                          "cxshift": x_coord,
                          "cyshift": y_coord,
                          "gene_id": d.venn_diagrams[i].text[k].text,
                          "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                          "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                          "des": d.venn_diagrams[i].desc1,
                          "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                          "title" : d.venn_diagrams[i].title1,
                          "pvalue" : str,
                          "show" : threshold,
                          "url1":   d.venn_diagrams[i].url,
                          "row" : xVal, 
                          "col" : yVal
                     });
                  }
                  else{
                    circleData.push({
                        "cx": d.venn_diagrams[i].c2x,
                        "cy": d.venn_diagrams[i].c2y,
                        "radius": d.venn_diagrams[i].r2,
                        "fill": "chartreuse",
                        "opacity": d.venn_diagrams[i].opacity,
                        "cxshift": x_coord,
                        "cyshift": y_coord,
                        "gene_id": d.venn_diagrams[i].text[k].text,
                        "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                        "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                        "des": d.venn_diagrams[i].desc1,
                        "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                        "title" : d.venn_diagrams[i].title1,
                        "pvalue" : str,
                        "show" : threshold,
                        "url1":   d.venn_diagrams[i].url,
                        "row" : xVal, 
                        "col" : yVal


                    });
                  }

                 if (d.venn_diagrams[i].emphasis1 == "False"){
                    circleData.push({
                        "cx": d.venn_diagrams[i].c1x,
                        "cy": d.venn_diagrams[i].c1y,
                        "radius": d.venn_diagrams[i].r1,
                        "fill": "#FF6666",
                        "opacity": d.venn_diagrams[i].opacity,
                        "cxshift": x_coord,
                        "cyshift": y_coord,
                        "gene_id": d.venn_diagrams[i].text[k].text,
                        "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                        "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                        "des": d.venn_diagrams[i].desc1,
                        "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                        "title" : d.venn_diagrams[i].title1,
                        "pvalue" : str,
                        "show" : threshold,
                        "url1":   d.venn_diagrams[i].url,
                        "row" : xVal, 
                        "col" : yVal


                    });
                  }
                  else{
                    circleData.push({
                        "cx": d.venn_diagrams[i].c1x,
                        "cy": d.venn_diagrams[i].c1y,
                        "radius": d.venn_diagrams[i].r1,
                        "fill": "chartreuse",
                        "opacity": d.venn_diagrams[i].opacity,
                        "cxshift": x_coord,
                        "cyshift": y_coord,
                        "gene_id": d.venn_diagrams[i].text[k].text,
                        "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                        "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                        "des": d.venn_diagrams[i].desc1,
                        "url":  '/viewgenesetoverlap/' + gene_url[xVal]+'/'+ gene_url[yVal],
                        "title" : d.venn_diagrams[i].title1,
                        "pvalue" : str,
                        "show" : threshold,
                        "url1":   d.venn_diagrams[i].url,
                        "row" : xVal, 
                        "col" : yVal


                    });
                  }

              }
              
            }
        }

    }


{# Intializes border for circles#}
    var border = 1;
    var bordercolor = 'black';

    var margin = {top: -5, right: -5, bottom: -5, left: -5},
    width = 1100 - margin.left - margin.right,
    height = 900 - margin.top - margin.bottom;
    var counter = 0;

    //Create the SVG Viewport
    var svgContainer = d3.select("#jaccard").append("svg")
            .attr("width", width )
            .attr("height", height)
            .call(d3.behavior.zoom()
                .on("zoom", function () {
                    svgContainer.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
                }))
            .append("g");


       //Button to reset zoom
       $("#zoomButton").on("click", function () {
                    counter++;
                    svgContainer
                          .transition()
                        .duration(1000)
                         .attr('transform', "translate(0,0)");
                           zoom.scale(1);
                          zoom.translate([0, 0]);
                  });

    var div = d3.select("#jaccard").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    //Add circles to the svgContainer
    var circles = svgContainer.selectAll("circle")
            .data(circleData)
            .enter()
            .append("circle");


    //Add the circle attributes
    var circleAttributes = circles
            .attr("cx", function (d) { return d.cx + d.cxshift + 50; })
            .attr("cy", function (d) {return d.cy + d.cyshift + 50; })
            .attr("r", function (d) {return d.radius; })
            .style("fill", function (d) { return d.fill; })
            .style("fill-opacity", function (d) {return d.opacity})
            .attr("cxshift", function (d) {   return d.cxshift; })
            .attr("cyshift", function (d) {  return d.cyshift; })
            .attr("label", function (d) { return d.label; })
            .attr("pValue", function (d) { return d.pvalue; })
            .style("stroke", 'black')
            .style("stroke-width", 1)

    .on("click", function(d){
          if(d3.event.shiftKey){
                  var row = d.row;
                  var col = d.col;

                  console.log(row + " " + col)

                  svgContainer.selectAll("circle")
                    .filter(function (d) {if ((d.row == row) || (d.col == col)) return true;})
                    .style('stroke', 'yellow')
                     .style("stroke-width", 3)
                  svgContainer.selectAll("circle")  
                    .filter(function (d) {if (!((d.row == row) || (d.col == col))) return true;})
                    .style('stroke', 'black')
                    .style("stroke-width", 1);
                }
            

  
          if(d3.event.altKey){
                  svgContainer.selectAll("circle")
                    .style('stroke', 'black')
                     .style("stroke-width", 1);
                }
            })

     // When mouse is over object html output styling of label will display
    .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", .9);
            div .html((d.title)+ "<br/>" + (d.des))
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY) + "px");

            })
     // When mouse leaves change opacity to 0 so not displayed
        .on("mouseout", function(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);   })

    // When mouse click open new page to designated url (of geneset id view results) NEED TO MODIFY LATER!
        .on("dblclick", function(d) {
           window.open(
                   d.url)});

               //    return i == 0 ? "circle1" : "circle2";});

        


    //Add the SVG Text Element to the svgContainer
    var text = svgContainer.selectAll("text")
            .data(circleData)
            .enter();

    // X Gene_Set labels added to d3
    text.append("text")
            .text(function (d) { return d.label;})
            .attr("x", function (d) {return d.labelx + 50; })
            .attr("y", function (d) {return 50; })
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // Y Gene_Set labels added to d3
    text.append("text")
            .text(function (d) {return d.label;})
            .attr("x", function (d) {return 25;})
            .attr("y", function (d) {return d.labely + 100;})
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // X Gene_Set labels added to d3
    text.append("text")
            .text(function (d) { return d.label1;})
            .attr("x", function (d) {return d.labelx + 50; })
            .attr("y", function (d) {return 60; })
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // Y Gene_Set labels added to d3
    text.append("text")
            .text(function (d) {return d.label1;})
            .attr("x", function (d) {return 25;})
            .attr("y", function (d) {return d.labely + 110;})
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // Jaccard, p-value, and overlap display added to d3
    text.append("text")
            .text(function (d) { return d.gene_id;})
            .attr("x", function (d) { return d.txshift; })
            .attr("y", function (d) { return d.tyshift;  })
            .attr("font-size", "11px");



    // when the input range changes update the circle
    d3.select("#nOpacity").on("input", function() {
        updateOpacity(+this.value);
    });


    // Initial starting radius of the circle
    updateOpacity(d.JaccardSimilarity_p_Value);

    // update the elements
    function updateOpacity(nOpacity) {

      // adjust the text on the range slider
      d3.select("#nOpacity-value").text(nOpacity);
      d3.select("#nOpacity").property("value", nOpacity);


        svgContainer.selectAll("circle")
            .filter(function (d) {if (d.pvalue < nOpacity ) return true;})
            .style("fill-opacity",0);
        svgContainer.selectAll("circle")
            .filter(function (d) {if (d.pvalue >= nOpacity ) return true;})
            .style("fill-opacity",1);
       }


   

    // Download types function and selection - not made by KRISTEN, in prior to working on
    function changeImg(sel, dl) {

        if (sel.value == 'svg') {
            document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}";
        }
        else if (sel.value == 'png') {
            document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.png') }}";
        }
        else if (sel.value == 'pdf') {
            document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}";
        }
    }

    
    // Checkbox for selecting a geneset
    function genesetCheckboxChanged(projCheckbox, genesetCheckboxes) {
        var allChecked = true;
        genesetCheckboxes.each(function (i, gsCheckbox) {
            gsCheckbox = $(gsCheckbox);
            if (!gsCheckbox.prop('checked')) {
                allChecked = false;
                return false;
            }
        });

        projCheckbox.prop('checked', allChecked);
    }


{#Script for the slider to control the jaccard similarity threshold.#}


$(document).ready(function(){
    $("#rerunFlip").click(function(){
        $("#rerunPanel").slideToggle("slow");
    });



     $('.project-link').on('click', function (event) {

      // Change chevron when project info is displayed
      var chev = $(this).children('.fa-plus').length ?
             $(this).children('.fa-plus') :
             $(this).children('.fa-minus');

      chev.toggleClass('fa-minus');
      chev.toggleClass('fa-plus') });

});







// function getSVG() {
//     var html = d3.select("svg")
//             .attr("title", "test2")
//             .attr("version", 1.1)
//             .attr("xmlns", "http://www.w3.org/2000/svg")
//             .node().parentNode.innerHTML;


//     d3.select("body")
//             .append("div")
//             .attr("id", "download")
//             .html("Right-click on this preview and choose Save as<br />Left-Click to dismiss<br />")
//             .append("img")
//             .attr("src", "data:image/svg+xml;base64," + btoa(html));
// }
// getSVG();
</script>



<script>
//Button to reset zoom
       $("#zoomButtonChart").on("click", function () {
                    svg.selectAll(".rectangles")
                       .transition()
                       .duration(1000)
                        .attr("transform", "translate(300," + (h-338) + ")")
                            .call(zm).call(xAxis);
                  });
//This allows the user to view the chart or not
$(document).ready(function() {
            $("#flip").click(function(){
                $("#panel").slideToggle("slow");
            });
    });
    // var w =  width + margin.left + margin.right; //, h = height + margin.top + margin.bottom;
    var border = 0.5;
    var bordercolor = 'black';
    var d = {{ data | safe }};
    var count = 0;

    var entry= 0;
    var ent_len = 0;
    var genesettble = 0;

    for (var key in d.genesets) {
        if (d.genesets.hasOwnProperty(key)) {
            ++count;
        }

    }
    var h= (count * 90) + 150;
    var w = (count * 110) + 100;



    function addStyle(h,w) {
        $('<style>.badger-left:after { height: ' + h + ';</style>').appendTo('#panel');
        $('<style>.badger-left:after { width: ' + w + ';</style>').appendTo('#panel');
    }

    function toggle(source) {
        checkboxes = document.getElementsByName('foo');
        for (var i = 0, n = checkboxes.length; i < n; i++) {
            checkboxes[i].checked = source.checked;
        }
    }



    var margin = {top: 30, right: 0, bottom: 20, left: 60},
      width = 960 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

    var xMax = 34,
      xMin = 0,
      yMax = 840,
      yMin = 0;

    //Define scales
    var x = d3.scale.linear()
      .domain([xMin, xMax])
      .range([0, width-100]);

    var y = d3.scale.linear()
      .domain([yMin, yMax])
      .range([height+20, 0]);


    //Define X axis
    var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom")
      .tickSize(-height)
      .tickFormat(d3.format("s"));

    //Define Y axis


        var zm = d3.behavior.zoom().x(x).scaleExtent([1, 8]).on("zoom", zoom);

    var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right + 90)
      .attr("height", h-100)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      .call(zm);



    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + h + ")")
      .call(xAxis);




    var addOnX = 0;
    var addOnY = -520;
    var addOnYLast = 0;
    var c = 0;
    var offset = 0;
    var textX = 30;
    var textY = -390;
    var xcoord = 60;


    for(i = 0; i < count; i++) {
        for (var k = 0; k < count; k++) {
            addOnX += 110;
            if (c % count == 0) {
                addOnY += 90;
                addOnX = 0;
            }

             if(k == offset) {

                       svg.append("rect")
                             .attr("class", "rectangles")
                            .attr("x", addOnX)
                            .attr("y", addOnY)
                            .attr("width", 110)
                            .attr("height", 90)
                            .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                      })
                            .style("stroke", "#ffffff")
                            .style("fill", "#ffa076")
                            .attr("border", 1);
                            //  console.log("Salmon: (" + addOnX + ", " + addOnY + ")");

             } else {
                       svg.append("rect")
                             .attr("class", "rectangles")
                            .attr("x", addOnX)
                            .attr("y", addOnY)
                            .attr("width", 110)
                            .attr("height", 90)
                              .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                       })
                            .style("stroke", "#ffffff")
                               .style("fill", function() {
                                   if (k % 2) {
                                       return "#b9d9cf";
                                   }
                                   else {
                                       return "#d7ede6";
                                   }
                               })
                            .attr("border", 1);
                            // console.log("Blue: (" + addOnX + ", " + addOnY + ")");
            }


            c++;
        }
       entry = 0;
       for (var key in d.geneset_table[i].entries) {
           if (d.geneset_table[i].entries.hasOwnProperty(key)) {
               ++entry;
           }
           //console.log("Entry length: " + Object.keys(d.geneset_table[i].entries[entry-1]).length);
           if(Object.keys(d.geneset_table[i].entries[entry-1]).length == 3){

                 svg.append("a")
                  .attr("xlink:href", d.geneset_table[i].entries[entry - 1].url)
                  .append("text")
                   .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                       })
                   .attr("class", "rectangles")
                 .attr("x", textX)
                 .attr("y", textY)
                 .style("font-weight",  "bold")
                 .text( d.geneset_table[i].entries[entry-1].jval)
                 .attr("font-family", "sans-serif")
                 .attr("font-size", "12px")
                 .attr("fill", "blue");

                 if((d.geneset_table[i].entries[entry-1].pval).length > 8){
                      svg.append("a")
                                .attr("xlink:href", d.geneset_table[i].entries[entry - 1].url)
                                .append("text")
                                 .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                           })
                                .attr("class", "rectangles")
                                .attr("x", textX )
                                .attr("y", textY + 12)
                                .style("font-weight", "bold")
                                .text(d.geneset_table[i].entries[entry - 1].pval)
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "12px")
                                .attr("fill", "blue");
                                //.on("click", function() { window.open("http://127.0.0.1:5000" + d3.select(this).geneset_table[i].entries[entry - 1].url)});

                  }else{
                    svg.append("a")
                                 .attr("xlink:href", d.geneset_table[i].entries[entry - 1].url)
                                 .append("text")
                                 .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                           })
                                  .attr("class", "rectangles")
                                .attr("x", textX + 4)
                                .attr("y", textY + 12)
                                .style("font-weight", "bold")
                                .text(d.geneset_table[i].entries[entry - 1].pval)
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "12px")
                                .attr("fill", "blue");
                                // .on("click", function(){ window.open("http://www.google.com")});
                                 //.on("click",  window.open("http://127.0.0.1:5000" + d.url), console.log (d.url));
                  }
            }
            if(Object.keys(d.geneset_table[i].entries[entry-1]).length == 1){
                 svg.append("text")
                  .attr("class", "rectangles")
                  .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                           })
                 .attr("x", textX)
                 .attr("y", textY)
                 .style("font-weight",  "bold")
                 .text( d.geneset_table[i].entries[entry-1].jval)
                 .attr("font-family", "sans-serif")
                 .attr("font-size", "12px");
            }
            textX += 110;
       }
       textX -= ((count) * 110);
        textY += 90;

         offset++;
    }


    var xCoordinate = 30;

    var gs_ids = d.genesets;

    for (i = 0; i < count; i++){
        var text = svg.append("text")
                .attr("class", "rectangles")
               .attr("x", xCoordinate - 10)
               .attr("y",  - 435)
               .text(d.genesets[i])
               .attr("transform", function(d, i) {
                            return "translate("+x(14)+","+y(50)+")";
                       })
               .attr("font-family", "sans-serif")
               .attr("font-size", "15px")
                .style("font-weight",  "bold")
               .attr("fill", "#fc9e54");

        xCoordinate += 110;
    }


    svg.append("rect")
            .attr("x", -80)
             .attr("y", -30)
           .attr("width", 370)
         .attr("height", h)
        .style("fill","white");

       for(i = 0; i < count; i++){

         svg.append("foreignObject")
              .attr("width", 285)
              .attr("height", 0)
              .attr("x", 13)
              .attr("y", xcoord - 37)
              .append("xhtml:body")
           .html( "<input type=checkbox name=foo value=bar id=" + d.geneset_table[i].text.replace(/\s/g, '').replace(":","_") + ">");

           str.replace(/\s/g, '');
          console.log(d.geneset_table[i].text);

            result = (d.geneset_table[i].text).replace(/.{30}\S*\s+/g, "$&@").split(/\s+@/);
            //console.log(result);
            var nextLine = 0;
           for(j = 0; j < result.length; j++) {
               svg .append("a")
                       .attr("xlink:href", d.geneset_table[i].url).append("text")
                       .attr("x", -13)
                        .style("font-weight",  "bold")
                       .attr("y", xcoord  + nextLine)
                       .text(result[j]);
               nextLine += 14;
           }

             xcoord +=90;
       }




    function zoom() {
      svg.select(".x.axis").call(xAxis);
          svg.selectAll(".rectangles")
            .attr("transform", function(d, i) {
        return "translate("+x(14)+","+y(50)+")";
      })

    }

    $('#addToProject').on('click', function () {
            //get all checked gene sets
            //also split off the name from the number
            console.log("inside")
            var gsname = [];
            var gsid = [];
            jQuery("input[type=checkbox]:checked").each(function () {
                console.log("inside jQuery");
                var v = ($(this).attr("id"));
                console.log("v = " + v);
                gsid.push(v.split('_')[0]);
                gsname.push('GS'+ v.split('_')[1]);
                if(gsid.indexOf('checkall') != -1){
                  gsid.pop()
                }
                console.log(gsid);
            });
            //display error if no genesets are selected
            if (gsname.length == 0) {
                $(document).trigger("add-alerts", [
                    {
                        'message': "No Gene Sets were selected for combining into the same project.",
                        'priority': 'danger'
                    }
                ]);
            }
            // send the list to the modal.
            else{
              console.log("In else")
                var n = gsname.join(", ");
                var i = gsid.join(",");
                console.log(n)
                $("#myModalLabel").html(i);
                $("#myModalValue").val(i);
                $("#addToProjectModal").modal('show');

            }
        });

  $('#addNewProject').on('click', function () {
            $('#reveal-if-active').html('<label for="newProjName"><h4>New Project Name: </h4></label>' +
                    '<input type="text" id="newProjName" name="newProjName" class="form-control input-lg">')
    });

  $('#addGenesetsToProjects').on('click', function (e) {
            var checked = [];
            $("input[name='options[]']:checked").each(function () {
                checked.push(parseInt($(this).val()));
            });
            var option = JSON.stringify(checked);
            var g = $('#myCombineGSValue').val();
            var npn = $('#newProjName').val();
            if ($.isEmptyObject(checked) && $.isEmptyObject(npn)) {
                $(document).trigger("add-alerts", [
                    {
                        'message': "No Projects were selected.",
                        'priority': 'danger'
                    }
                ]);
            }
            else {
              // console.log(g.user );
              console.log("npn " + npn);
              console.log("g" + g);
              console.log("option" + option);
                $.ajax({
                    type: "GET",
                    url: "../addGenesetsToProjects",
                    data: {"user_id": 0, "npn": npn, "gs_id": g, "option": option},
                    success: function (data) {
                        $(document).trigger("add-alerts", [
                            {
                                'message': "Genesets Successfully Added to Selected Projects.",
                                'priority': 'success'
                            }
                        ]);
                        window.location.reload();
                    }
                });
            }
        });




</script>

<script>
$(document).ready(function(){
Â Â Â Â $('[data-toggle="tooltip"]').tooltip();
var imgAltKey = '<img src="{{url_for('static', filename='images/altkey.png')}}">';
var imgShiftKey = '<img src="{{url_for('static', filename='images/shiftkey.png')}}">';
var wikiIcon = '<img src="{{url_for('static', filename='images/wikiIcon.png')}}">';
var wikiImg = '<a href="http://geneweaver.org/wiki/index.php?title=Jaccard_Similarity">' + wikiIcon +'</i></a>';

 $('#what').popover({
Â Â Â Â Â Â Â Â Â Â Â Â title: 'How to Use', content: 'Scroll up or down to zoom in/out respectively ' +
Â Â Â Â Â Â Â Â Â Â Â 'within the Venn Diagram View. Click and drag to pan. Hover for labels and double click' +
Â Â Â Â Â Â Â Â Â Â Â Â ' to navigate to intersection details. <br>' +
Â Â Â Â Â Â Â Â Â Â Â Â imgShiftKey + "+Click: Highlight a row for a certain geneset. <br>" +
Â Â Â Â Â Â Â Â Â Â Â Â imgAltKey + "+Click: Remove highlighting." + "<br> Wiki for further questions:" + wikiImg , html: true
Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â });

</script>




{% include 'footer.html' %}
