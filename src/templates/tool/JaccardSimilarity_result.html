{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<style>

    div.tooltip {
  position: absolute;
  text-align: center;
  width: 300px;
  height: 60px;
  padding: 2px;
  font: 10px sans-serif;
  background: ghostwhite;
  pointer-events: none;}
{#        font-weight: bold;#}

#slider {
  margin-top: 50px;
  margin-left: 50px;
  margin-bottom: 50px;
  width: auto;
  height: auto;
}

.ui-slider-handle {
    border-radius: 10px;
    background: none !important;
    background-color: #efefef !important;
}

.tooltip-inner {
    background-color: #E74937 !important;
    border-radius: 0px;
}

.tooltip-arrow {
    border-top-color: #E74937 !important;
}

#clickableFontAwesome {
    cursor: pointer;
}

#panel, #flip {
    padding: 5px;
    text-align: left;
}

#panel {
{#    padding: 50px;#}
    display: none;
    background-color: #FFFFFF;
}
.badger-left:after {
}


#flip {
 height: 50px;
}



#rerunPanel, #rerunFlip {
    padding: 5px;
    text-align: left;
}

#rerunPanel {
    height: 350px;
    text-align: left;
    display: none;
}

#rerunFlip {
   height: 50px;
   text-shadow: none;
}
#rerun{
 float:right;
    display:block;
    margin-right: 585px;
    clear:left;
 }

.left-cell {
  vertical-align: middle;
  width: 200px;

}
.right-cell {
  display: table-cell;
  vertical-align: middle;
  text-align: right;
  right: 0;
}

.middle-cell {
  display: table-cell;
  vertical-align: middle;
  text-align: right;
  padding-left: 320px;
}


.box-header {
  padding-bottom: 5px;
  display: table;
  width: 90%;
}
.form-group{
 padding-right: 300px;
 }

#addToProject, #exportData {
    float: left;
}

 .divider{
    margin: 5px;
}


#checkall{
    float: left;

}

  .page-header {
        border-bottom-width: thick;
        border-bottom-color: #006400;
    }

input#checkall[type='checkbox'] {
    -webkit-checkbox: none;
    width:3px;
    height:3px;
    background:white;
    border-radius:5px;
    border:2px solid #555;
}
{#input#checkall[type='checkbox']:checked {#}
{#    background: #006b00;#}
{#}#}


input[type="checkbox"] {
 -webkit-appearance:none;/* Hides the default checkbox style */
 height:1.32em;
 width:1.32em;
 cursor:pointer;
 position:relative;
 -webkit-transition: .15s;
 border-radius: 4px;
 background-color: rgba(221, 221, 221, 0.87);

}

input[type="checkbox"]:hover {
 background: rgba(143, 151, 105, 0.67);
}
input[type="checkbox"]:checked {
 background-color:green;
}

input[type="checkbox"]:before, input[type="checkbox"]:checked:before {
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 line-height:1.32em;
 text-align:center;
 color:#fff;

}

input[type="checkbox"]:checked:before {
 content: '✔';
}

input[type="checkbox"]:hover:before {
 background:rgba(255,255,255,0.3);
}

</style>



<script src="/static/d3/d3.min.js" charset="utf-8"></script>
 <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
{#<link rel="stylesheet" href="/resources/demos/style.css">#}

<div class="panel panel-default panel-heading bg-gray-light">
    <h3 class="panel-title"><strong>{{ title }} </strong></h3>
</div>



<div id="rerunFlip" style="font-size: 1.25em" class="ui-btn ui-btn-inline  ui-corner-all header project-link "><i class="fa fa-plus">  Rerun Tool Options</i></div>

<div id="rerunPanel" >
    <form id="todo-id" class="form-horizontal" role="form" method="post">
        <div class="form-group" >{{ macros.tool_param_radio(tool.params['JaccardSimilarity_Homology']) }}</div>
        <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardSimilarity_PairwiseDeletion']) }}</div>
        <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardSimilarity_p-Value']) }}</div>
        <input type="hidden" name="genesets" value="{{async_result.gs_ids|join(' ') }}" />
        <button id="rerun" class="btn btn-primary"
           type='submit'
           value='run'
           onclick='this.form.action="{{ url_for('JaccardSimilarity.run_tool') }}";'>
           Run
        </button>
     </form>
</div>


<br>
<div id="flip" style="font-size: 1.25em" class="ui-btn ui-btn-inline ui-corner-all project-link header "> <i class="fa fa-plus">    Geneset Table Panel</i></div>
<div id="panel" class="badger-left">
<div id="chart"></div>


                        <div><form action="#" method="post" id="myform">
                            <div class=" pull-left"><input type="checkbox" onClick="toggle(this)" name="checkall" id="checkall" style="font-weight: 300"> <label for="checkall">Select all</label></div>
                        </form></div> <p></p><br><br><br>


                        <button type="button" class="btn btn-lg btn-warning divider" id="addToProject">
                            <i class="fa fa-folder-o pull-left"></i> Add to Project
                        </button>

                        <button type="button" class="btn btn-lg btn-warning divider" id="exportData">
                            <i class="fa fa-download pull-left"></i> Export Genes
                        </button>
</div>
<br>
   <div class="page-header"> </div>
<p>
  <div class="box-header clearfix">
      <div class = "left-cell">
         <h4>Venn Diagram view:</h4>
      </div>
      <div class="container middle-cell">
         <div class="dropdown middle-cell">
             <button class="btn btn-primary dropdown-toggle" id="menu1" type="button" data-toggle="dropdown"><i class="fa fa-download pull-left">   Download as</i>
             <span class="caret"></span></button>
              <ul class="dropdown-menu" id="menudrop" role="menu" aria-labelledby="menu1" onChange="download(this.value)">
                  <li role="presentation"><a role="menuitem" tabindex="-1" value="a_file.svg">SVG</a></li>
                  <li role="presentation"><a role="menuitem" tabindex="-1" value="a_file.pdf" >PDF</a></li>
                  <li role="presentation"><a role="menuitem" tabindex="-1"  value="a_file.png"  href="https://www.google.com">PNG</a></li>
              </ul>
         </div>
      </div>
            <div class="right-cell">
         <button type="button" value="Update" id="zoomButton" class="ui-btn ui-btn-inline ui-corner-all ui-shadow ui-btn-b  ui-icon-check header" onclick="updateZoom()">Reset Zoom</button>
      </div>
</div>


<script>

$(document).ready(function(){
    $(".dropdown").on("show.bs.dropdown", function(event){
        var x = $(event.relatedTarget).text(); // Get the button text

    });
});

</script>



{#Location for where the d3 is appended to in the html#}
<div id="jaccard"></div>


  <label for="nRadius">
{#         style="display: inline-block; width: 240px; text-align: left">#}
        <h2>P-Value Threshold (0.05 increments):
      <label  style="font-weight: bold" id="nRadius-value">…</label></h2>
  </label>

  <input type="range" min="0" max="1" step = "0.05" id="nRadius">
</p>


<br>




<br>

<select name="downloadType" id="downloadType">
   <option value="null">Select file type...</option>
   <option value="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}">SVG</option>
   <option value="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}">PDF</option>
   <option value="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.png') }}">PNG</option>
</select>






{# Start of script#}
<script type="text/javascript">

{#  Declaration of data as d variable#}
    var d = {{ data | safe }};

{# Checks number of objects venn_diagram has#}
    var count = 0;
    for (var key in d.venn_diagrams)
        if (d.venn_diagrams.hasOwnProperty(key))
            count++;

{# Counts number of text objects in venn_diagrams text set#}
    var count_text = 0;

{# Used to keep track of label id for gene sets that are overlapping with themselves#}
    var check = 0;

{# Array used to define the coordinates of the graph#}
    var gene_lab_coor = [];

{# Array for all elements of each venn_diagram circle object#}
    var circleData = [];

{# Finds the length and width of entire chart (object wise) #}
    var num_sets = Math.sqrt(count);

{# Sets the graph coordinates to 0,0#}
    var x_coord = 0;
    var y_coord = 0;

{# Array to hold the value for gene_sets set in jSon data#}
    var gene_sets = [];
    gene_sets = d.geneset_table;

{# Arrau to hold individual gene set ids (w/o the GS) to get the url#}
    var gene_ids = [];
    var gid= "";

{#Create string to hold titles#}
    var str = "";
{#Create varaible to store row number#}
    var row = -1;
{# Intializes gene_ids array for click url functionality#}
    for (i= 0; i<gene_sets.length; i++){
        gene_ids[i] = gid;
    }

{# Gets URLs for click function#}
    var gene_url = [];
    var geneurl_text = "";
    gene_url = d.genesets;
{# Intializes gene_ids array for click url functionality#}
    for (i= 0; i<gene_url.length; i++){
        geneurl_text = gene_url[i].substring(2);
        gene_url[i] = geneurl_text;
    }

{# var compare_threshold = d.JaccardSimilarity_p-Value;#}
{#console.log(compare_threshold);#}
var threshold = false;
 var pValues = [];
 var pValueCount = 0;
 var isPVal = "p = ";
  for (i = 0; i < count; i++) {

        count_text = 0;
        for (var key in d.venn_diagrams[i].text) {
            if (d.venn_diagrams[i].text.hasOwnProperty(key)) {
                ++count_text;
            }
        }
      for (k = 0; k < count_text; k++) {
          var str = d.venn_diagrams[i].text[k].text;
          if(str.search(isPVal) != -1){
              //alert(str.replace("p =  ",""));
              str = str.replace("p =", "");
              str=str.replace(/^\s+|\s+$/g,'');
              pValues[pValueCount] =  str;
              pValueCount += 1;
         }
      }
  }



{# Plots the graph in a correct fashion by incrementing differently for different items in the set#}
    for (i = 0; i < count; i++) {
        var str = "-1";
        if (i % num_sets === 0) {
            x_coord = 150;
            y_coord += 150;
            if (i === 0) {
                y_coord = 50;
            }
        }
        else {
            x_coord += 200;
        }

{# Pushes the coordinates of tx and ty into the gene_lab_coord array #}
        gene_lab_coor.push([d.venn_diagrams[i].tx, d.venn_diagrams[i].ty]);

{# Resets the count_text value to 0 #}
        count_text = 0;

{# Counts the number of objects in venn_diagram's text set #}
        for (var key in d.venn_diagrams[i].text) {
            if (d.venn_diagrams[i].text.hasOwnProperty(key)) {
                ++count_text;
            }
        }

{#  Read through k times and create text labels based upon k's value  #}
        for (k = 0; k < count_text; k++) {
            var isPVal = "p = ";

            if (k === 2) {
                str = d.venn_diagrams[i].text[k].text;
                str = str.replace("p =", "");
                str = str.replace(/^\s+|\s+$/g, '')

            }


{#  When values of c1,c2 are the same then make turquoise circle with initialized objects in json #}
            if (d.venn_diagrams[i].c1x === d.venn_diagrams[i].c2x) {
{#                str = d.venn_diagrams[i].title1;#}
{#                str= str.substring(0,32);#}
{#                if (str >= d.JaccardSimilarity_p-Value){#}
{#                    threshold = true;}#}
{#                else{#}
{#                    threshold = false}#}
                circleData.push({
                    "cx": d.venn_diagrams[i].c2x,
                    "cy": d.venn_diagrams[i].c2y,
                    "radius": d.venn_diagrams[i].r2,
                    "fill": "#66FFFF",
                    "opacity": d.venn_diagrams[i].opacity,
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "des": d.venn_diagrams[i].desc1,
                     "url":   gene_url[check-1] +'/' + gene_url[check-1],
                    "title" : d.venn_diagrams[i].title1,
                    "pvalue" : str,
                    "show" : threshold


                });
                 row +=1;

                {# When the object number i is 0 and its text value is k then read in the text for jaccard and p-value with appropriate coordinates#}
                if((i === 0) && (k === 0)) {
{#                    if (str >= d.JaccardSimilarity_p - Value) {#}
{##}
{#                    threshold = true;#}
{#                }#}
{#                    else {#}
{#                        threshold = false;#}
{#                    }#}
                     circleData.push({
                            "gene_id": d.venn_diagrams[i].text[k].text,
                            "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 27,
                            "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 40,
                            "label": d.geneset_table[check].text.substring(0,25),
                            "label1": d.geneset_table[check].text.substring(25,50),
                            "labelx": x_coord,
                            "labely": y_coord,
                            "pvalue" : str,
                            "show" : threshold

                        });
                        check += 1;
                }

                {# Else (FIXES OVERLAP) object is not i = 0, text k is 0, and is a diagonal then intializes jaccard, p and coordinate values#}
                else if ( (k===0) && (i !== 0) && (i%(num_sets+1) ===0)){
{#                    if (str >= d.JaccardSimilarity_p-Value){#}
{#                        threshold = true;}#}
{#                    else {#}
{#                        threshold = false;#}
{#                    }#}
                        circleData.push({
                            "gene_id": d.venn_diagrams[i].text[k].text,
                            "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 27,
                            "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 40,
                            "label": d.geneset_table[check].text.substring(0,25),
                            "label1": d.geneset_table[check].text.substring(25,50),
                            "labelx": x_coord,
                            "labely": y_coord,
                            "pvalue" : str,
                            "show" : threshold

                        });
                        check += 1;
                }

                {# If k or i is different push the label onto the circledata array #}
                else {
{#                     if (str >= d.JaccardSimilarity_p-Value){#}
{#                        threshold = true;}#}
{#                    else{#}
{#                        threshold = false;}#}
                    circleData.push({
                        "gene_id": d.venn_diagrams[i].text[k].text,
                        "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 18,
                        "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 24,
                        "pvalue" : str,
                        "show" : threshold
                    });
                }

            }

{#  Else make circles for orange and blue with appropriate json values #}
            else {
{#                str = d.venn_diagrams[i].title1;#}
{#                str = str.substring(0,32);#}
{#                if (str >= d.JaccardSimilarity_p-Value){#}
{#                        threshold = true;}#}
{#                else{#}
{#                        threshold = false;}#}
                circleData.push({
                    "cx": d.venn_diagrams[i].c2x,
                    "cy": d.venn_diagrams[i].c2y,
                    "radius": d.venn_diagrams[i].r2,
                    "fill": "#0000FF",
                    "opacity": d.venn_diagrams[i].opacity,
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "gene_id": d.venn_diagrams[i].text[k].text,
                    "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                    "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                    "des": d.venn_diagrams[i].desc1,
                    "url":  gene_url[check]+'/'+ gene_url[check-1],
                    "title" : d.venn_diagrams[i].title1,
                    "pvalue" : str,
                    "show" : threshold,
                    "url1":   d.venn_diagrams[i].url


                });
                circleData.push({

                    "cx": d.venn_diagrams[i].c1x,
                    "cy": d.venn_diagrams[i].c1y,
                    "radius": d.venn_diagrams[i].r1,
                    "fill": "#FF8000",
                    "opacity": ".5",
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "des": d.venn_diagrams[i].desc1,
                    "url": gene_url[check]+'/'+ gene_url[check-1],
                    "title" : d.venn_diagrams[i].title1,
                    "pvalue" : str,
                    "show" : threshold
                });
{#                console.log(row);#}
{#                console.log(gene_url[check], d.venn_diagrams[row].url);#}
            }

        }


    }


{# Intializes border for circles#}
    var border = 1;
    var bordercolor = 'black';

    var margin = {top: -5, right: -5, bottom: -5, left: -5},
    width = 1100 - margin.left - margin.right,
    height = 900 - margin.top - margin.bottom;
    var counter = 0;

    //Create the SVG Viewport
    var svgContainer = d3.select("#jaccard").append("svg")
            .attr("width", width )
            .attr("height", height)
            .call(d3.behavior.zoom()
                .on("zoom", function () {
                    svgContainer.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
                }))
            .append("g");


       //Button to reset zoom
       $("#zoomButton").on("click", function () {
                    counter++;
                    svgContainer
                          .transition()
                        .duration(1000)
                         .attr('transform', "translate(0,0)");
                           zoom.scale(1);
                          zoom.translate([0, 0]);
                  });

    var div = d3.select("#jaccard").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    //Add circles to the svgContainer
    var circles = svgContainer.selectAll("circle")
            .data(circleData)
            .enter()
            .append("circle");


    //Add the circle attributes
    var circleAttributes = circles
            .attr("cx", function (d) { return d.cx + d.cxshift + 50; })
            .attr("cy", function (d) {return d.cy + d.cyshift + 50; })
            .attr("r", function (d) {return d.radius; })
            .style("fill", function (d) { return d.fill; })
            .style("fill-opacity", function (d) {return d.opacity - .2})
            .attr("cxshift", function (d) {   return d.cxshift; })
            .attr("cyshift", function (d) {  return d.cyshift; })
            .attr("label", function (d) { return d.label; })
            .attr("pValue", function (d) { return d.pvalue; })
            .style("stroke", bordercolor)
            .attr("border", border)

     // When mouse is over object html output styling of label will display
    .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", .9);
            div .html((d.title)+ "<br/>" + (d.des))
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY) + "px");

            })
     // When mouse leaves change opacity to 0 so not displayed
        .on("mouseout", function(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);   })

    // When mouse click open new page to designated url (of geneset id view results) NEED TO MODIFY LATER!
        .on("dblclick", function(d) {
           window.open(
                   "/viewgenesetoverlap/" + d.url)});

               //    return i == 0 ? "circle1" : "circle2";});


    //Add the SVG Text Element to the svgContainer
    var text = svgContainer.selectAll("text")
            .data(circleData)
            .enter();

    // X Gene_Set labels added to d3
    text.append("text")
            .text(function (d) { return d.label;})
            .attr("x", function (d) {return d.labelx + 50; })
            .attr("y", function (d) {return 50; })
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // Y Gene_Set labels added to d3
    text.append("text")
            .text(function (d) {return d.label;})
            .attr("x", function (d) {return 25;})
            .attr("y", function (d) {return d.labely + 100;})
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // X Gene_Set labels added to d3
    text.append("text")
            .text(function (d) { return d.label1;})
            .attr("x", function (d) {return d.labelx + 50; })
            .attr("y", function (d) {return 60; })
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // Y Gene_Set labels added to d3
    text.append("text")
            .text(function (d) {return d.label1;})
            .attr("x", function (d) {return 25;})
            .attr("y", function (d) {return d.labely + 110;})
            .style("font-weight", "bold")
            .attr("font-size", "10px");

    // Jaccard, p-value, and overlap display added to d3
    text.append("text")
            .text(function (d) { return d.gene_id;})
            .attr("x", function (d) { return d.txshift; })
            .attr("y", function (d) { return d.tyshift;  })
            .attr("font-size", "11px");



    // when the input range changes update the circle
    d3.select("#nRadius").on("input", function() {
        updateOpacity(+this.value);
    });


    // Initial starting radius of the circle
    updateOpacity(0);

    // update the elements
    function updateOpacity(nRadius) {

      // adjust the text on the range slider
      d3.select("#nRadius-value").text(nRadius);
      d3.select("#nRadius").property("value", nRadius);


        svgContainer.selectAll("circle")
            .filter(function (d) {if (d.pvalue < nRadius ) return true;})
            .style("fill-opacity",0);
        svgContainer.selectAll("circle")
            .filter(function (d) {if (d.pvalue >= nRadius ) return true;})
            .style("fill-opacity",1);
       }


    // Changes on Url menu to select different download types
    var urlMenu = document.getElementById("downloadType");
    urlMenu.onchange = function () {
        if (this.value != 'null') {
            window.open(this.options[this.selectedIndex].value, '_blank');
        }
    }

    // Download types function and selection - not made by KRISTEN, in prior to working on
    function changeImg(sel, dl) {

        if (sel.value == 'svg') {
            document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}";
        }
        else if (sel.value == 'png') {
            document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.png') }}";
        }
        else if (sel.value == 'pdf') {
            document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}";
        }
    }

    // Checkbox for selecting a geneset
    function genesetCheckboxChanged(projCheckbox, genesetCheckboxes) {
        var allChecked = true;
        genesetCheckboxes.each(function (i, gsCheckbox) {
            gsCheckbox = $(gsCheckbox);
            if (!gsCheckbox.prop('checked')) {
                allChecked = false;
                return false;
            }
        });

        projCheckbox.prop('checked', allChecked);
    }


{#Script for the slider to control the jaccard similarity threshold.#}

//This allows the user to view the chart or not
$(document).ready(function() {
            $("#flip").click(function(){
                $("#panel").slideToggle("slow");
            });
    });
$(document).ready(function(){
    $("#rerunFlip").click(function(){
        $("#rerunPanel").slideToggle("slow");
    });



     $('.project-link').on('click', function (event) {

			// Change chevron when project info is displayed
			var chev = $(this).children('.fa-plus').length ?
					   $(this).children('.fa-plus') :
					   $(this).children('.fa-minus');

			chev.toggleClass('fa-minus');
			chev.toggleClass('fa-plus') });

});


  $(function () {
        $("[data-toggle='tooltip']").tooltip();
    });
          $('#clickableFontAwesome').popover({
            title: 'Venn Diagram Instructions', content: 'Scroll up or down to zoom in/out respectively ' +
            'within the Venn Diagram View. Click and drag to pan. Hover for labels and double click' +
            'to navigate to intersection details.'
        });


{#var html = d3.select("svg")#}
{#        .attr("title", "test2")#}
{#        .attr("version", 1.1)#}
{#        .attr("xmlns", "http://www.w3.org/2000/svg")#}
{#        .node().parentNode.innerHTML;#}
{#d3.select("#chart").append("div")#}
{#        .attr("id", "download")#}
{#        .html("Right-click on this preview and choose Save as<br />Left-Click to dismiss<br />")#}
{#        .append("img")#}
{#        .attr("src", "data:image/svg+xml;base64,"+ btoa(html));#}
</script>



<script type="text/javascript">

   // var w =  width + margin.left + margin.right; //, h = height + margin.top + margin.bottom;
    var border = 0.5;
    var bordercolor = 'black';
    var d = {{ data | safe }};
    var count = 0;

    var entry= 0;
    var ent_len = 0;
    var genesettble = 0;

    for (var key in d.genesets) {
        if (d.genesets.hasOwnProperty(key)) {
            ++count;
        }

    }



    var h= (count * 90) + 150;
    var w = (count * 110) + 100;

    function addStyle(h,w) {
        $('<style>.badger-left:after { height: ' + h + ';</style>').appendTo('#panel');
        $('<style>.badger-left:after { width: ' + w + ';</style>').appendTo('#panel');
    }

    function toggle(source) {
        checkboxes = document.getElementsByName('foo');
        for (var i = 0, n = checkboxes.length; i < n; i++) {
            checkboxes[i].checked = source.checked;
        }
    }

    var svg = d3.select("#chart").append("svg:svg")
        .attr("width",  width + margin.left + margin.right)
        .attr("height", h-100);

    var xcoord = 90;





       for(i = 0; i < count; i++){

         svg.append("foreignObject")
              .attr("width", 325)
              .attr("height", 0)
              .attr("x", 3)
              .attr("y", xcoord - 70)
            .append("xhtml:body")
           .html( "<input type=checkbox name=foo value=bar id=check>");




            result = (d.geneset_table[i].text).replace(/.{34}\S*\s+/g, "$&@").split(/\s+@/);
            console.log(result);
            var nextLine = 0;
           for(j = 0; j < result.length; j++) {
               svg .append("a")
                       .attr("xlink:href", d.geneset_table[i].url).append("text")
                       .attr("x", 40)
                        .style("font-weight",  "bold")
                       .attr("y", xcoord - 6 + nextLine)
                       .text(result[j]);
               nextLine += 14;
           }

             xcoord +=90;
        }


    var addOnX = 0;
    var addOnY = 0;
    var addOnYLast = 0;
    var c = 0;
    var offset = 0;
    var textX = 370;
    var textY = 90;


    for(i = 0; i < count; i++) {
      for(var k = 0; k < count; k++) {
        addOnX += 110;
        if(c % count == 0) {
          addOnY += 90;
          addOnX = 0;
        }

        if(k == offset) {

           svg.append("rect")
                .attr("x", addOnX + 340)
                .attr("y", addOnY - 50)
                .attr("width", 110)
                .attr("height", 90)
                .style("stroke", "#ffffff")
                .style("fill", "#ffa076")
                .attr("border", 1);

        } else {
           svg.append("rect")
                .attr("x", addOnX + 340)
                .attr("y", addOnY - 50)
                .attr("width", 110)
                .attr("height", 90)
                .style("stroke", "#ffffff")
                   .style("fill", function(d) {
                       if (k % 2) {
                           return "#b9d9cf";
                       }
                       else {
                           return "#d7ede6";
                       }
                   })
                .attr("border", 1);
        }


        c++;
      }







       entry = 0;
       for (var key in d.geneset_table[i].entries) {
           if (d.geneset_table[i].entries.hasOwnProperty(key)) {
               ++entry;
           }
           console.log("Entry length: " + Object.keys(d.geneset_table[i].entries[entry-1]).length);
           if(Object.keys(d.geneset_table[i].entries[entry-1]).length == 3){

                 svg.append("a")
                  .attr("xlink:href", d.geneset_table[i].entries[entry - 1].url)
                  .append("text")
                 .attr("x", textX)
                 .attr("y", textY)
                 .style("font-weight",  "bold")
                 .text( d.geneset_table[i].entries[entry-1].jval)
                 .attr("font-family", "sans-serif")
                 .attr("font-size", "12px")
                 .attr("fill", "blue");

                 if((d.geneset_table[i].entries[entry-1].pval).length > 8){
                      svg.append("a")
                                .attr("xlink:href", d.geneset_table[i].entries[entry - 1].url)
                                .append("text")
                                .attr("x", textX - 10)
                                .attr("y", textY + 12)
                                .style("font-weight", "bold")
                                .text(d.geneset_table[i].entries[entry - 1].pval)
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "12px")
                                .attr("fill", "blue");
                                //.on("click", function() { window.open("http://127.0.0.1:5000" + d3.select(this).geneset_table[i].entries[entry - 1].url)});

                  }else{
                    svg.append("a")
                                 .attr("xlink:href", d.geneset_table[i].entries[entry - 1].url)
                                 .append("text")
                                .attr("x", textX + 4)
                                .attr("y", textY + 12)
                                .style("font-weight", "bold")
                                .text(d.geneset_table[i].entries[entry - 1].pval)
                                .attr("font-family", "sans-serif")
                                .attr("font-size", "12px")
                                .attr("fill", "blue");
                                // .on("click", function(){ window.open("http://www.google.com")});
                                 //.on("click",  window.open("http://127.0.0.1:5000" + d.url), console.log (d.url));
                  }
            }
            if(Object.keys(d.geneset_table[i].entries[entry-1]).length == 1){
                 svg.append("text")
                 .attr("x", textX)
                 .attr("y", textY)
                 .style("font-weight",  "bold")
                 .text( d.geneset_table[i].entries[entry-1].jval)
                 .attr("font-family", "sans-serif")
                 .attr("font-size", "12px");
            }
            textX += 110;
       }
       textX -= ((count) * 110);
        textY += 90;
      offset++;
    }




    var xCoordinate = 360;

    for (i = 0; i < count; i++){
        var text = svg.append("text")
               .attr("x", xCoordinate)
               .attr("y",  30)
               .text(d.genesets[i])
               .attr("font-family", "sans-serif")
               .attr("font-size", "15px")
                .style("font-weight",  "bold")
               .attr("fill", "#fc9e54");

        xCoordinate += 110;
    }

</script>









