
{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<style>

    div.tooltip {
  position: absolute;
  text-align: center;
  width: 300px;
  height: 60px;
  padding: 2px;
  font: 10px sans-serif;
  background: ghostwhite;
  pointer-events: none;}
{#        font-weight: bold;#}

    #slider {
  margin-top: 50px;
  margin-left: 50px;
  margin-bottom: 50px;
  width: auto;
  height: auto;
}

.ui-slider-handle {
    border-radius: 10px;
    background: none !important;
    background-color: #efefef !important;
}

.tooltip-inner {
    background-color: #E74937 !important;
    border-radius: 0px;
}

.tooltip-arrow {
    border-top-color: #E74937 !important;
}
</style>

<script src="/static/d3/d3.min.js" charset="utf-8"></script>
{#<script src="/static/d3/radar.js" charset="utf-8"></script>#}

<div class="page-header">
    <h1>{{ title }}</h1>
</div>

<form id="todo-id" class="form-horizontal" role="form" method="post">
    <div class="row">
        <div class="col-md-12">
                <div class="panel panel-info">
            <div class="panel-heading">
               <h2 class="panel-title">
                  <a data-toggle="collapse" data-parent="#accordion" href="#jcCollapse">
                     Rerun Tool Options
                  </a>
               </h2>
            </div>
            <div id="jcCollapse" class="panel-collapse collapse">
               <div class="panel-body">
                  <div class="row">
                     <div class="col-md-4">
                        <div class="form-group">{{ macros.tool_param_radio(tool.params['JaccardSimilarity_Homology']) }}</div>
                     </div>
                     <div class="col-md-4">
                        <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardSimilarity_PairwiseDeletion']) }}</div>
                     </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['JaccardSimilarity_p-Value']) }}</div>
                            </div>

                     <div class="col-md-4">
                        <input type="hidden" name="genesets" value="{{async_result.gs_ids|join(' ') }}" />

                        <button class="btn btn-primary"
                           type='submit'
                           value='run'
                           onclick='this.form.action="{{ url_for('JaccardSimilarity.run_tool') }}";'>
                           Run
                        </button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
        </div>
    </div>
</form>

<br /><h4>Table View:</h4>

<br clear="all" /><div class="floatGeneList">
<form name="listform" id="listform">
<table cellspacing="0" style="font-size: 0.75em; "><tr><th valign="bottom" align="left" style=" border-bottom: thin solid #ccc;"> &nbsp;

{% for item in async_result.geneset_table %}
  </th><th style="border-top: 4px solid #000; border-right: 4px solid #000; border-left: 4px solid #000; border-bottom: 4px solid #000; {cycle values=",background-color: #fff;"}">
  <a href="{{ item.url }}">{{ item.gsID }}</a>
{% endfor %}
</th></tr>

{% set j = 0 %}
{% for item in async_result.geneset_table %}
    {% set i = 0 %}
<tr><td style="border-bottom: none; white-space:nowrap;" align="left">
<input style="margin-top: 2px" type="checkbox" name="gs_id[]" value="{{ item.gsID[2:] }}">
<a style="margin-left:30px; font-size:18px;" href="{{ item.url }}">{{ item.text }}</a> &nbsp;
    {% for jac in item.entries %}
   <td align="center" style=" padding: 0.5em; border-left: thin solid #000; {{ jac.background }}">
    {% if jac.url == "0" %}
        <a href="/geneset_intersection/{{item.gsID}}/{{async_result.genesets[i]}}/{{i+j*async_result.genesets|length}}.html">{{ jac.text | safe }}</a>
    {% elif jac.url == "1" %}
        <a href="/geneset_intersection/{{item.gsID}}/{{async_result.genesets[i]}}/{{i+j*async_result.genesets|length}}.html">{{ jac.text | safe }}</a>
    {% elif jac.url %}
      <a href="{{ jac.url }}">{{ jac.text | safe }}</a>
    {% else %}
      <span style="font-size: 0.75em;">{{ jac.text | safe }}</span>
    {% endif %}
    </td>
    {% set i = i + 1 %}
   {% endfor %}
    {%set j = j + 1 %}
<td style="width: 25em;">&nbsp;</td></tr>
{% endfor %}

<tr><td colspan="4" style="border-bottom: none;">
<div id="project_selector">
<input style="margin-top: 2px" type="checkbox" value="all" onclick="ODE.select_all(this.checked, 'gs_id[]');">
    <p style="margin-left:30px; font-size: 15px;"> Select All
    <select name="addToProject" onchange="javascript:handleSelect(this);">
        <option value="-1">Add selected to project...</option>
        {% for project in list %}
            <option value="{{project.project_id}}">{{project.name}} ({{project.count}})</option>
        {% endfor %}
        <option value="-2">+ Create new project...</option></select></p>
</div>
   <script type="text/javascript">
      function handleSelect(elm)
      {
         var genesets = [];
            if (elm.value != "-1") {
                if (elm.value == "-2") {
                    var name = prompt("Enter a name for the new project:");
                    $.get("/create_project/" + name + ".html", function (data, status) {
                        $('input:checkbox[name="gs_id[]"]').each(function () {
                            if (this.checked) {
                                genesets.push(this.value);
                            }
                        });
                        if (genesets.length != 0) {
                            for (var i = 0; i < genesets.length; i++) {
                                $.get("/add_geneset_to_project/" + data + "/" + genesets[i] + ".html");
                            }
                        }
                        else {
                            window.alert("Please select gene set(s) to add first!")
                        }
                    });
                }
                else {
                    $('input:checkbox[name="gs_id[]"]').each(function () {
                        if (this.checked) {
                            genesets.push(this.value);
                        }
                    });
                    if (genesets.length != 0) {
                        for (var i = 0; i < genesets.length; i++) {
                            $.get("/add_geneset_to_project/" + elm.value + "/" + genesets[i] + ".html", function (data, status) {
                            });
                        }
                    }
                    else {
                         window.alert("Please select gene set(s) to add first!")
                    }
                }
            }
      }
</script>
</td></tr>
</table>


<br /><br /><h4>Venn Diagram view:</h4>

{#Location for where the d3 is appended to in the html#}
<div id="jaccard"></div>

{# Displays output to a new window if selected #}
<a target="_blank" href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}">Open in New Window</a>

{# Style sheet and calls for slider code from other websites#}
 <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<link rel="stylesheet" href="/resources/demos/style.css">
{{ data | safe }}
{# Start of script#}
<script type="text/javascript">

{#  Declaration of data as d variable#}
    var d = {{ data | safe }};

{# Checks number of objects venn_diagram has#}
    var count = 0;
    for (var key in d.venn_diagrams)
        if (d.venn_diagrams.hasOwnProperty(key))
            count++;

{# Counts number of text objects in venn_diagrams text set#}
    var count_text = 0;

{# Used to keep track of label id for gene sets that are overlapping with themselves#}
    var check = 0;

{# Array used to define the coordinates of the graph#}
    var gene_lab_coor = [];

{# Array for all elements of each venn_diagram circle object#}
    var circleData = [];

{# Finds the length and width of entire chart (object wise) #}
    var num_sets = Math.sqrt(count);

{# Sets the graph coordinates to 0,0#}
    var x_coord = 0;
    var y_coord = 0;

{# Array to hold the value for gene_sets set in jSon data#}
    var gene_sets = [];
    gene_sets = d.geneset_table;

{# Arrau to hold individual gene set ids (w/o the GS) to get the url#}
    var gene_ids = [];
    var gid= "";

{#Create string to hold titles#}
    var str = "";


{# Intializes gene_ids array for click url functionality#}
    for (i= 0; i<gene_sets.length; i++){
        gene_ids[i] = gid;
    }

{# Intializes gene_ids array for click url functionality#}
{#    for (i= 0; i<geneset_table.length; i++){#}
{#        gid = gene_sets[i].substring(2);#}
{#        gene_ids[i] = gid;#}
{#    }#}

{# Plots the graph in a correct fashion by incrementing differently for different items in the set#}
    for (i = 0; i < count; i++) {
        if (i % num_sets === 0) {
            x_coord = 150;
            y_coord += 150;
            if (i === 0) {
                y_coord = 50;
            }
        }
        else {
            x_coord += 200;
        }

{# Pushes the coordinates of tx and ty into the gene_lab_coord array #}
        gene_lab_coor.push([d.venn_diagrams[i].tx, d.venn_diagrams[i].ty]);

{# Resets the count_text value to 0 #}
        count_text = 0;

{# Counts the number of objects in venn_diagram's text set #}
        for (var key in d.venn_diagrams[i].text) {
            if (d.venn_diagrams[i].text.hasOwnProperty(key)) {
                ++count_text;
            }
        }

{#  Read through k times and create text labels based upon k's value  #}
        for (k = 0; k < count_text; k++) {

{#  When values of c1,c2 are the same then make turquoise circle with initialized objects in json #}
            if (d.venn_diagrams[i].c1x === d.venn_diagrams[i].c2x) {
                str = d.venn_diagrams[i].title1;
                str= str.substring(0,32);
                circleData.push({
                    "cx": d.venn_diagrams[i].c2x,
                    "cy": d.venn_diagrams[i].c2y,
                    "radius": d.venn_diagrams[i].r2,
                    "fill": "#66FFFF",
                    "opacity": d.venn_diagrams[i].opacity,
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "des": d.venn_diagrams[i].desc1,
                     "url":  d.venn_diagrams[i].url,
                    "title" : str

                });

                {# When the object number i is 0 and its text value is k then read in the text for jaccard and p-value with appropriate coordinates#}
                if((i === 0) && (k === 0)){
                     circleData.push({
                            "gene_id": d.venn_diagrams[i].text[k].text,
                            "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 27,
                            "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 40,
                            "label": gene_sets[check].text,
                            "labelx": x_coord,
                            "labely": y_coord

                        });
                        check += 1;
                }

                {# Else (FIXES OVERLAP) object is not i = 0, text k is 0, and is a diagonal then intializes jaccard, p and coordinate values#}
                else if ( (k===0) && (i !== 0) && (i%(num_sets+1) ===0)){
                        circleData.push({
                            "gene_id": d.venn_diagrams[i].text[k].text,
                            "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 27,
                            "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 40,
                            "label": gene_sets[check].text,
                            "labelx": x_coord,
                            "labely": y_coord

                        });
                        check += 1;
                }

                {# If k or i is different push the label onto the circledata array #}
                else {
                    circleData.push({
                        "gene_id": d.venn_diagrams[i].text[k].text,
                        "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 18,
                        "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 24
                    });
                }

            }

{#  Else make circles for orange and blue with appropriate json values #}
            else {
                str = d.venn_diagrams[i].title1;
                str = str.substring(0,32);
                circleData.push({
                    "cx": d.venn_diagrams[i].c2x,
                    "cy": d.venn_diagrams[i].c2y,
                    "radius": d.venn_diagrams[i].r2,
                    "fill": "#0000FF",
                    "opacity": d.venn_diagrams[i].opacity,
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "gene_id": d.venn_diagrams[i].text[k].text,
                    "txshift": x_coord + d.venn_diagrams[i].text[k].tx + 20,
                    "tyshift": y_coord + d.venn_diagrams[i].text[k].ty + 30,
                    "des": d.venn_diagrams[i].desc1,
                    "url": "/viewgenesetdetails/" + gene_ids[check],
                    "title" : str


                });
                circleData.push({
                    "cx": d.venn_diagrams[i].c1x,
                    "cy": d.venn_diagrams[i].c1y,
                    "radius": d.venn_diagrams[i].r1,
                    "fill": "#FF8000",
                    "opacity": ".5",
                    "cxshift": x_coord,
                    "cyshift": y_coord,
                    "des": d.venn_diagrams[i].desc1,
                    "url": "/viewgenesetdetails/" + gene_ids[check-1],
                    "title" : str
                });

            }

        }


    }

{# Intializes border for circles#}
    var border = 1;
    var bordercolor = 'black';

    var margin = {top: -5, right: -5, bottom: -5, left: -5},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;


    //Create the SVG Viewport
    var svgContainer = d3.select("#jaccard").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .call(d3.behavior.zoom().on("zoom", function () {
                svgContainer.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
              }))
              .append("g");

    var div = d3.select("#jaccard").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
//Add circles to the svgContainer
    var circles = svgContainer.selectAll("circle")
            .data(circleData)
            .enter()
            .append("circle");


//Add the circle attributes
    var circleAttributes = circles
            .attr("cx", function (d) { return d.cx + d.cxshift + 50; })
            .attr("cy", function (d) {return d.cy + d.cyshift + 50; })
            .attr("r", function (d) {return d.radius; })
            .style("fill", function (d) { return d.fill; })
            .style("fill-opacity", function (d) {return d.opacity - .2})
            .attr("cxshift", function (d) {   return d.cxshift; })
            .attr("cyshift", function (d) {  return d.cyshift; })
            .attr("label", function (d) { return d.label; })
            .style("stroke", bordercolor)
            .attr("border", border)

     // When mouse is over object html output styling of label will display
    .on("mouseover", function(d) {
            div.transition()
                .duration(200)
                .style("opacity", .9);
            div .html((d.title)+ "<br/>" + (d.des))
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY) + "px");

            })
     // When mouse leaves change opacity to 0 so not displayed
        .on("mouseout", function(d) {
            div.transition()
                .duration(500)
                .style("opacity", 0);   })

    // When mouse click open new page to designated url (of geneset id view results) NEED TO MODIFY LATER!
        .on("click", function(d) {
           window.open(
                   "http://127.0.0.1:5000" + d.url, console.log(d.url))});

//Add the SVG Text Element to the svgContainer
    var text = svgContainer.selectAll("text")
            .data(circleData)
            .enter();

// X Gene_Set labels added to d3
    text.append("text")
            .text(function (d) {return d.label;})
            .attr("x", function (d) {return d.labelx + 70; })
            .attr("y", function (d) {return 25; })
{#            .style("font-weight", "bold")#}
            .attr("font-size", "10px");

// Y Gene_Set labels added to d3
    text.append("text")
            .text(function (d) {return d.label;})
            .attr("x", function (d) {return 25;})
            .attr("y", function (d) {return d.labely + 100;})
{#            .style("font-weight", "bold");#}
            .attr("font-size", "10px");

// Jaccard, p-value, and overlap display added to d3
    text.append("text")
            .text(function (d) { return d.gene_id;})
            .attr("x", function (d) { return d.txshift; })
            .attr("y", function (d) { return d.tyshift;  })
            .attr("font-size", "11px");

// ATTEMPT TO CHANGE SIZE OF DISPLAY OUTPUT BASED ON NUMBER OF OBJECTS (scale down function being used)--- DOES NOT WORK
     function sizeChange() {
	    d3.select("g").attr("transform", "scale(" + svgContainer.width()/900 + ")");
         d3.select("g").attr("transform", "scale(" + svgContainer.height()/900 + ")");
	}
// Gives attributes to the text
    var textLabels = text
            .attr("font-family", "sans-serif")
            .attr("font-size", "12px")
            .attr("fill", "black");


    // Changes on Url menu to select different download types
    var urlMenu = document.getElementById("downloadType");
    urlMenu.onchange = function () {
        if (this.value != 'null') {
            window.open(this.options[this.selectedIndex].value, '_blank');
        }
    }

// Download types function and selection - not made by KRISTEN, in prior to working on
function changeImg(sel, dl) {

    if (sel.value == 'svg') {
        document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}";
    }
    else if (sel.value == 'png') {
        document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.png') }}";
    }
    else if (sel.value == 'pdf') {
        document.getElementById("svgFrame").src = "{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}";
    }
}

// Checkbox for selecting a geneset
function genesetCheckboxChanged(projCheckbox, genesetCheckboxes) {
    var allChecked = true;
    genesetCheckboxes.each(function (i, gsCheckbox) {
        gsCheckbox = $(gsCheckbox);
        if (!gsCheckbox.prop('checked')) {
            allChecked = false;
            return false;
        }
    });

    projCheckbox.prop('checked', allChecked);
}


 </script>



<p><br></p>
{# Label for slider in html, input is text currently#}
<h4> Jaccard Threshold (0.05 increments):<input type="text" id="amount" readonly ></h4>

{# Placement of slider in html#}
<div id="jaccard">

    <div id="slider"></div>

    </div>

<script type="text/javascript">

    // Function for changing opacity of entire container
    function repositionTooltip( e, ui ){
    // where opacity of jaccard div changes
    $("#jaccard").css("opacity",ui.value);
    // Functionality of moving and displaying sider vlaue to input
    var div = $(ui.handle).data("tooltip").$tip[0];
    var pos = $.extend({}, $(ui.handle).offset(), { width: $(ui.handle).get(0).offsetWidth,height: $(ui.handle).get(0).offsetHeight
    });

    var actualWidth = div.offsetWidth;

    tp = {left: pos.left + pos.width / 2 - actualWidth / 2};
    $(div).offset(tp);

    $(div).find(".tooltip-inner").text( ui.value );
}
// Slider defined in script
$("#slider").slider({
    range: "min",
    min: 0,
    max: 1,
    step: 0.01,
    value: 0.5,

    // Slide calls function for reposition and stop is when person stops moving slider and opacity is then displayed
    stop: repositionTooltip,
    slide: function( event, ui ) {
        $( "#amount" ).val( ui.value );
      }
});

</script>
<br>


View As:</r>
<form>
   <label>SVG<input type="radio" name="view" value="svg" onclick="changeImg(this, false);" checked></label>
   <label>PNG<input type="radio" name="view" value="png" onclick="changeImg(this, false);"></label>
    <label>PDF<input type="radio" name="view" value="pdf" onclick="changeImg(this, false);"></label>
</form>

<br>
Download As:
<select name="downloadType" id="downloadType">
   <option value="null">Select file type...</option>
   <option value="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}">SVG</option>
   <option value="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}">PDF</option>
   <option value="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.png') }}">PNG</option>
</select>
<br><br><br>




{% include 'footer.html' %}