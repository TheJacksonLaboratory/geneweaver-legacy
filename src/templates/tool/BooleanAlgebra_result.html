{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<style>
    .venntooltip {
        position: absolute;
        text-align: center;
        vertical-align: middle;
        width: 128px;
        height: 26px;
        background: #333;
        color: #ddd;
        padding: 3px;
        border: 0px;
        border-radius: 8px;
        opacity: 0;
    }

    .geneBox {
        padding: 7px;
        display: inline-block;
        border: 1px solid #000;
        vertical-align: middle;
    }

    th, td {
        text-align: center;
    }
</style>


<div class="loader"></div>

<div class="row" id="result"></div>

<div class="panel panel-default panel-heading bg-gray-light">
    <h2 class="panel-title"><strong>Boolean Algebra</strong></h2>
</div>

<div class="panel panel-default">


    <div class="row">
        <div class="col-xs-12 col-md-9">
            <div class="row">
            </div>
        </div>
        <div class="col-xs-6 col-md-3">
            <button type="button" class="btn btn-block btn-warning" onclick="addNewGS()" id="addToNewGeneset"
                    style="margin-bottom: 10px;">
                <i class="fa fa-list-ul pull-left"></i> Add Genes to GeneSet
            </button>
        </div>
    </div>


    {# Relation type and Number of Genesets used Title #}
    <div class="panel-heading" style="border-bottom-width: thick; border-bottom-color: #006400;">
        <h6 class="panel-title">{{ async_result.type }} of {{ async_result.numGS }} GeneSets</h6>
    </div>

    {#     {{ async_result }}#}
    {# div for venn diagram #}
    {% if async_result.numGS < 11 %}
        <div class="vis" style="margin-left: auto; margin-right: auto;"></div>
    {% else %}
        <div class="row">
            <div class="alert alert-warning fade in">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">Ã—</button>
                <strong>Warning!</strong> Too many GeneSets to display graph representation. Please select 10 or fewer
                to display overlaps.
            </div>
        </div>
    {% endif %}

    {# Check to see if there are results to display #}
    {% if async_result.bool_results | length == 0 %}
        <div class="row">
            <div class="alert alert-info fade in">
                No results were found in the {{ async_result.type }} of your GeneSets
            </div>
        </div>

        {# Display the results if there are any. #}
    {% else %}



        {% if async_result.type == 'Union' %}
            {% set i = 1 %}
            {% set results = async_result.bool_results %}

            <div class="row">
                <div class="col-md-10">
                    <h6 class="panel-title">{{ results | length }} Distinct Genes found in the Union
                        of {{ async_result.numGS }} GeneSets</h6>
                </div>
                <div class="col-md-2" align="right" style="text-align:right">
                    <div class="ui-checkbox group-checkbox" id="group-{{ i }}-allcheck"
                         style="padding:0; border:0; margin:0">
                        <label for="group-{{ i }}" style="padding:0 0 0 40px; margin:0">
                            Select All
                            <input type="checkbox"
                                   name="group-{{ i }}"
                            />
                        </label>
                    </div>
                </div>
            </div>

            <div class="row" id="group-{{ async_result.numGS }}">
                <table class="table table-hover">
                    <tbody>
                    <tr>
                        <th>Genes</th>
                        {#                <th>Species</th>#}
                        <th>Homology</th>
                        <th>In GeneSets</th>
                        <th>Emphasis</th>
                        <th></th>
                    </tr>
                    {% for g in results | sort(attribute=0) %}
                        {% set cluster = results[g] %}
                        <tr>
                            <td style="text-align: left;">
                                {% for gene in cluster %}
                                    {% if previous != gene[2]|string + gene[1] %}
                                        {% if not loop.first %}<i class="fa fa-arrows-h"></i>{% endif %}
                                        <span style="margin-left: 5px;">
                                            <span class="group_name" style="font: italic 10px/14px Georgia, serif;
                                        background-color: {{ async_result.bg[(gene[2]|int-1)] }};
                                        border:1px solid {{ async_result.borders[(gene[2]|int-1)] }}">
                                                {{ async_result.all_species[gene[2]|string] }}.
                                            </span>
                                        </span>
                                        <strong>
                                            <a href="/search/?searchbar={{ gene[1] }}&pagination_page=1&searchGenes=yes">{{ gene[1] }}</a>
                                        </strong>
                                    {% endif %}
                                    {% set previous = gene[2]|string + gene[1] %}
                                {% endfor %}
                            </td>

                            {#                    <td>#}
                            {# Make boxes for homology blocks #}
                            {# see tools repor boolean algebra for the list of species and colors #}
                            {#
                        {% for i in range(1,12) %}
                            {# skip elements that are empty #}
                            {#
                            {% if async_result.tt[(i-1)] != 'empty' %}
                                <span data-placement="top" data-toggle="tooltip" data-rel="tooltip"
                                      data-original-title="{{ async_result.tt[(i-1)] }}"
                                      title="{{ async_result.tt[(i-1)] }}">
                                            {% set exists = ['1'] %}
{#                                            {{ async_result.grid[async_result.odeLookup[gene]|string] }}#}
                            {#
                                    {% for h in async_result.resids[g|string]|sort %}
                                        {% if h == i %}
                                            <div class="geneBox"
                                                 style="background-color: {{ async_result.colors[(i-1)] }};"></div>
                                            {% if exists.append('1') %}{% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if exists|length == 1 %}
                                        <div class="geneBox"></div>
                                    {% endif %}
                                </span>
                            {% endif %}
                        {% endfor %}
                    #}
                            {#                    </td>#}

                            {# homoology #}
                            <td>
                                {% if cluster | length == 1 %}
                                    <span class="label label-default">No Mapping</span>
                                {% else %}
                                    <span class="label label-info">Homologene</span>
                                {% endif %}
                            </td>

                            {# In Gene Sets #}
                            <td>
                                {% for gene in cluster %}
                                    <span id="{{ gene[3] }}">
                                <span data-placement="top" data-toggle="tooltip" data-rel="tooltip"
                                      data-original-title="{{ gene[4] }}" title="{{ gene[4] }}">
                                <a href="/viewgenesetdetails/{{ gene[4] }}">
                                <strong>GS{{ gene[3] }}</strong>
                                </a>
                                    {% if not loop.last %},{% endif %}
                                </span>
                            </span>
                                {% endfor %}

                            </td>
                            {# Emphasize #}
                            <td nowrap>
                                <input type="checkbox" name="g_id[]" id="{{ cluster[0] }}"
                                       onchange="emphasize('{{ cluster[0] }}');"
                                       class="switch" data-size="mini"
                                       style="padding: 0px; vertical-align: middle;">
                            </td>
                            {# Checkbox #}
                            <td>
                                <div class="ui-checkbox" style="padding: 0; border: 0; margin: 0;">
                                    <label for="addGeneset"
                                           style="margin: -6px; padding-right: 0;">
                                        <input type="checkbox" name="gsoptions[]"
                                               id="addGeneset{{ cluster[0] }}"
                                               value="{{ cluster[0] }}"/>
                                    </label>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}

        {% if async_result.type == 'Intersect' or async_result.type == 'Except' %}
            {% if async_result.type == 'Intersect' %}
                {% set results = async_result.intersect_results %}
                {% set union = 'Intersection' %}
            {% elif async_result.type == 'Except' %}
                {% set results = async_result.bool_except %}
                {% set union = 'Except Clause' %}
            {% endif %}

            <div class="row">
                <div class="col-md-12">
                    <h6 class="panel-title">{{ async_result.intersect_results | length }} Distinct Sets found in the
                        {{ union }}
                        of {{ async_result.numGS }} GeneSets where each gene is found in a minimum
                        of {{ async_result.at_least }}
                        Gene Sets</h6>
                </div>
            </div>

            {% for gs_group in results | sort %}
                <div class="row">
                    <div class="col-md-2 pull-right" align="right" style="text-align:right">
                        <div class="ui-checkbox group-checkbox" id="group-{{ i }}-allcheck"
                             style="padding:0; border:0; margin:0">
                            <label for="group-{{ i }}" style="padding:0 0 0 40px; margin:0">
                                Select Set
                                <input type="checkbox" name="group-{{ i }}"/>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="row" id="group-{{ async_result.numGS }}">
                    <table class="table table-hover">
                        <tbody>
                        <tr>
                            <th>Genes</th>
                            {#                <th>Species</th>#}
                            <th>Homology</th>
                            <th>In GeneSets</th>
                            <th>Emphasis</th>
                            <th></th>
                        </tr>
                        {% for g in results[gs_group] %}

                            {% set cluster = results[gs_group][g] %}
                            <tr>

                                <td style="text-align: left; width: 30%;">
                                    {% for gene in cluster %}
                                        {% if previous != gene[2]|string + gene[1] %}
                                            {% if not loop.first %}<i class="fa fa-arrows-h"></i>{% endif %}
                                            <span style="margin-left: 5px;">
                                                <span class="group_name" style="font: italic 10px/14px Georgia, serif;
                                                    background-color: {{ async_result.bg[(gene[2]|int-1)] }};
                                                    border:1px solid {{ async_result.borders[(gene[2]|int-1)] }}">
                                                    {{ async_result.all_species[gene[2]|string] }}.
                                                </span>
                                            </span>
                                            <strong>
                                                <a href="/search/?searchbar={{ gene[1] }}&pagination_page=1&searchGenes=yes">{{ gene[1] }}</a>
                                            </strong>
                                        {% endif %}
                                        {% set previous = gene[2]|string + gene[1] %}
                                    {% endfor %}

                                </td>

                                {#                    <td>#}
                                {# Make boxes for homology blocks #}
                                {# see tools repor boolean algebra for the list of species and colors #}
                                {#
                    {% for i in range(1,12) %}
                        {# skip elements that are empty #}
                                {#
                        {% if async_result.tt[(i-1)] != 'empty' %}
                            <span data-placement="top" data-toggle="tooltip" data-rel="tooltip"
                                  data-original-title="{{ async_result.tt[(i-1)] }}"
                                  title="{{ async_result.tt[(i-1)] }}">
                                        {% set exists = ['1'] %}
{#                                            {{ async_result.grid[async_result.odeLookup[gene]|string] }}#}
                                {#
                                {% for h in async_result.resids[g|string]|sort %}
                                    {% if h == i %}
                                        <div class="geneBox"
                                             style="background-color: {{ async_result.colors[(i-1)] }};"></div>
                                        {% if exists.append('1') %}{% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if exists|length == 1 %}
                                    <div class="geneBox"></div>
                                {% endif %}
                            </span>
                        {% endif %}
                    {% endfor %}
                #}
                                {#                    </td>#}

                                {# homoology #}
                                <td style="width: 10%;">
                                    {% if cluster | length == 1 %}
                                        <span class="label label-default">No Mapping</span>
                                    {% else %}
                                        <span class="label label-info">Homologene</span>
                                    {% endif %}
                                </td>

                                {# In Gene Sets #}
                                <td>
                                    {% for gene in cluster %}
                                        <span id="{{ gene[3] }}">
                            <span data-placement="top" data-toggle="tooltip" data-rel="tooltip"
                                  data-original-title="{{ gene[4] }}" title="{{ gene[4] }}">
                            <a href="/viewgenesetdetails/{{ gene[3] }}">
                            <strong>GS{{ gene[3] }}</strong>
                            </a>
                                {% if not loop.last %},{% endif %}
                            </span>
                        </span>
                                    {% endfor %}
                                </td>
                                {# Emphasize #}
                                <td nowrap>
                                    <input type="checkbox" name="g_id[]" id="{{ cluster[0] }}"
                                           onchange="emphasize('{{ cluster[0] }}');"
                                           class="switch" data-size="mini"
                                           style="padding: 0px; vertical-align: middle;">
                                </td>
                                {# Checkbox #}
                                <td>
                                    <div class="ui-checkbox" style="padding: 0; border: 0; margin: 0;">
                                        <label for="addGeneset"
                                               style="margin: -6px; padding-right: 0;">
                                            <input type="checkbox" name="gsoptions[]"
                                                   id="addGeneset{{ cluster[0] }}"
                                                   value="{{ cluster[0] }}"/>
                                        </label>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        {% endif %}


    {% endif %}

</div>


{# Grab the list of emphgeneids. It is an environment variable set in the blueprint. #}
{% for gene in emphgeneids %}
    <script>
        document.getElementById("{{gene}}").checked = true;
    </script>
{% endfor %}


<script type="text/javascript">

    $(document).ready(function () {

        $('.group-checkbox').on('click', function (event) {

            // Grabs the group ID for this checkbox. Format: group-#-checkbox
            var groupId = $(this).attr('id').split('-')[1];
            var groupCheck = $(this).find('input[type=checkbox]');
            // Id for checkbox grouping
            var groupCheckboxes = '#group-' + groupId;
            var checks = $(groupCheckboxes).find('input[type=checkbox]');
            // Even when we mark the checkbox as checked the stupid UI doesn't
            // get updated because of these weird ui button things
            var btns = $(groupCheckboxes).find('.ui-btn');

            // Opposite because by the time this code executes, the box is
            // already checked
            if (!groupCheck.attr('checked')) {

                checks.each(function (index) {
                    $(this).attr('checked', false);
                });

                btns.each(function (index) {
                    $(this).removeClass('ui-checkbox-on');
                    $(this).addClass('ui-checkbox-off');
                });

            } else {

                checks.each(function (index) {
                    $(this).attr('checked', true);
                });

                btns.each(function (index) {
                    $(this).removeClass('ui-checkbox-off');
                    $(this).addClass('ui-checkbox-on');
                });
            }
        });

        /**
         * Ever since we added the select all checkbox, we now have to hook
         * into these stupid ui-checkbox clicks otherwise the actual checkbox
         * which lies underneath all the ui crap doesn't get (de)selected.
         */
        $('.ui-checkbox').on('click', function (event) {

            var check = $(this).find('input[type=checkbox]');

            if (check.attr('checked'))
                check.attr('checked', false);
            else
                check.attr('checked', true);
        });
    });
</script>

{# To update the ephasize genes. #}
<script type="text/javascript">
    $("[name='g_id[]']").bootstrapSwitch();

    $(function () {
        $("[data-toggle='tooltip']").tooltip();
    });


    function emphasize(id) {
        if (document.getElementById(id).checked) {
            $.get("/emphasize/" + id + ".html", function (data, status) {
            });
        }
        else {
            $.get("/deemphasize/" + id + ".html", function (data, status) {
            });
        }
    }

    {# Functionality for the "Add to New GeneSets Button.
       All the checked checkboxes are loaded and sent with a Query String
       to the 'Batch Upload Geneset' Page #}
    function addNewGS() {

        var checkedArray = [];
        $("input:checkbox[name='gsoptions[]']:checked").each(function () {
            checkedArray.push($(this).val());
        });

        if (typeof checkedArray != "undefined" && checkedArray != null && checkedArray.length > 0) {

            var as = {{ async_result | tojson | safe}};
            var sets = Object.keys(as['genesets']);

            var numGS = 0;
            numGS = {{ async_result.numGS}};

            // The 1? is added so the entire string will appear in
            // window.location.search. Without the 1? The string is
            // truncated and missing the first sentence.
            var getStr = '1?algebra?' +
                'The {{ async_result.type }} of {{ async_result.numGS }}' +
                ' GeneSets.?' +
                'The Boolean Algebra tool was used to find the ' +
                '{{ async_result.type }} of ' + numGS + ' sets: ' +
                sets.join(', ');

            // add in all the checked boxes gene names
            checkedArray.forEach(function (entry) {
                getStr += "?";
                getStr += entry;
                getStr += "?";

                // grab the value
                var tmpString = "{{ async_result.valueLookup }}";
                // conver the string to an array by looping
                var values = [];
                var t_length = tmpString.length;
                for (var i = 0; i < t_length; i++) {
                    var tmpName = "";
                    var tmpValue = "";
                    while (tmpString[i] !== '?' && i < t_length) {
                        tmpName += tmpString[i];
                        i++;
                    }
                    tmpName = String(tmpName);
                    values.push(tmpName);
                    // skip over '?'
                    i++;
                    while (tmpString[i] !== '?' && i < t_length) {
                        tmpValue += tmpString[i];
                        i++;
                    }
                    tmpValue = parseInt(tmpValue);
                    values.push(tmpValue);
                }
                var currVal = 1;
                // find the current value we need
                var arrayLen = values.length;
                for (var j = 0; j < arrayLen;) {
                    if (values[j] === entry) {
                        j = (j + 1);
                        currVal = values[j];
                    }
                    j = (j + 1);
                }
                // assign the current value for the gene name
                getStr += currVal;

            });

            // Load the new page with the extra url bit
            window.open('/uploadgeneset/' + getStr, '_blank');
        }
        else {
            window.alert("No checkboxes selected.")
        }

    }


</script>

{# script for d3 Eularean diagrams #}
<script type="text/javascript" src="../../static/d3/d3.v4.min.js"></script>
{# <script type="text/javascript" src="../../static/d3/numeric-1.2.4.js"></script>  #}
<script type="text/javascript" src="../../static/d3/venn.js"></script>

<script type="text/javascript">
    // script to make the Euler circles
    //variables


    var sets = {};
    var data = [];
    var results = {{ async_result | tojson | safe }};
    var groups = [];

    if (results['numGS'] < 11) {

        // This initializes data by creating variables for each of the gs_ids
        for (var i = 0; i < results['gsids'].length; i++) {
            groups.push('GS' + results['gsids'][i]);
        }

        // Initialize the data array with the power set included in groups
        function powerSet(arr) {
            var len = arr.length;
            for (var i = 0; i < Math.pow(2, len); i++) {
                var aux = [];
                for (var j = 0; j < len; j++) {
                    //console.log(j +':'+((1<<j) & j));
                    if (i & (1 << j)) {
                        if (arr[j] !== '') {
                            aux.push(arr[j]);
                        }
                    }
                }
                sets = {};
                // initialize variables
                if (aux[0] !== undefined) {
                    sets.sets = aux;
                    sets.size = 0;
                    if (aux.length === 1) {

                        for (var key in results['bool_results']) {
                            for (var k = 0; k < results['bool_results'][key].length; k++) {
                                if (results['bool_results'][key][k][3] == aux[0].substring(2)) {
                                    sets.abbr = results['bool_results'][key][k][4]
                                }
                            }
                        }
                    }
                    else {
                        sets.abbr = '';
                    }
                    data.push(sets);
                }
            }
        }

        powerSet(groups);


//Go through the data array and add counts to the appropriate set size elements
        for (var key in results['groups']) {
            if (results['groups'].hasOwnProperty(key)) {
                var list = [];
                for (var k = 0; k < results['groups'][key].length; k++) {
                    list.push('GS' + results['groups'][key][k])
                }
                //loop through data and add/update values
                for (var j = 0; j < data.length; j++) {
                    if (data[j]['sets'] == list.join()) {
                        data[j]['size'] = data[j]['size'] + 1;
                    }
                }
            }
        }


// draw venn diagram
        var div = d3.select(".vis");
        div.datum(data).call(venn.VennDiagram());

// add a tooltip
        var tooltip = d3.select("body").append("div")
            .attr("class", "venntooltip");

// add listeners to all the groups to display tooltip on mouseover
        div.selectAll("g")
            .on("mouseover", function (d, i) {
                // sort all the areas relative to the current item
                venn.sortAreas(div, d);

                // Display a tooltip with the current size
                tooltip.transition().duration(400).style("opacity", .9);
                tooltip.text(d.size + " genes.");

                // highlight the current path
                var selection = d3.select(this).transition("tooltip").duration(400);
                selection.select("path")
                    .style("stroke-width", 3)
                    .style("fill-opacity", d.sets.length == 1 ? .4 : .1)
                    .style("stroke-opacity", 1);
            })

            .on("mousemove", function () {
                tooltip.style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })

            .on("mouseout", function (d, i) {
                tooltip.transition().duration(400).style("opacity", 0);
                var selection = d3.select(this).transition("tooltip").duration(400);
                selection.select("path")
                    .style("stroke-width", 0)
                    .style("fill-opacity", d.sets.length == 1 ? .25 : .0)
                    .style("stroke-opacity", 0);
            });


    }

</script>

{% include 'footer.html' %}
