{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<head xmlns="http://www.w3.org/1999/html">
    <meta charset="utf-8">
    <style>
        .node circle {
            cursor: pointer;
            stroke: #3182bd;
            stroke-width: 3px;
        }

        .found {
            fill: #ff4136;
            stroke: #ff4136;
        }

        .node text {
            /*font: 12px sans-serif;*/
            font-size: 12px;
            font-family: "Arial", sans-serif;
            pointer-events: none;
            text-shadow: -1px -1px 0 #FFF,
            1px -1px 0 #FFF,
            -1px 1px 0 #FFF,
            1px 1px 0 #FFF;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        /*Just making sure the select2 box is glued to the top*/
        .search {
            width: 100%;
            border-radius: 4px;
        }

        a.d3-slider-handle {
            background: #00A2D9;
            border-radius: 4px;
            border: 0px;
        }

        .d3-slider {
            background: #2B3647;
            border-radius: 4px;
            width: 720px;
            position: absolute;
        }

        a.btn-success {
            color: #fff;
            background-color: #006400;
            border-color: #004C74;
        }
    </style>

</head>
<!-- Styling for d3 sliders -->
<link rel="stylesheet" type="text/css" href="../../static/css/d3.slider.css"> </link>
<!-- Styling for select2 search bar -->
<link rel="stylesheet" type="text/css" href="../../static/select2/select2.min.css"> </link>
<!-- Library for standard d3 functions -->
<script type="text/javascript" src="../../static/d3/d3.min.js"></script>
<!-- Library for select2 search bar -->
<script type="text/javascript" src="../../static/select2/select2.min.js"></script>
<!-- Additional d3 library for d3 sliders -->
<script type="text/javascript" src="../../static/d3/d3.slider.js"></script>


<div class="page-header">
    <h1>{{ title }}
        {{ runhash }} </h1>
</div>


{#
	Checks to see if runhash is defined. If it is, that means we're
	viewing a stored result and PhenomeMap.js won't work properly without
	the extra $.get() call below.
#}


{% if runhash %}
    <script type="text/javascript">

        var graph_url = '/results/' + '{{async_result.result_image}}';
        var xml = '';
        $.get(graph_url, function (data) {
            xml = data;
            load_cytoscape();
        });

    </script>
{% endif %}


{#
{% if state == 'FAILURE' %}
 #}
{% if async_result.error %}
    <div class="panel-body bg-red p-15" style="text-align:center">
        <strong>
            {{ async_result.error }}
        </strong>
    </div>
    <br />
{% endif %}

<div class="">
    <div class="btn-group">
        <button type="button" class="btn btn-primary">Download as...</button>
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
            <li><a class="download-image" id="dl-pdf">PDF</a></li>
            <li><a class="download-image" id="dl-png">PNG</a></li>
            <li><a class="download-image" id="dl-svg">SVG</a></li>
            <li role="separator" class="divider"></li>
            <li><a class="download-image" id="ol-png">PNG (Old HiSim)</a></li>
        </ul>
    </div>
    <!--
    <button type="button" id="old-hisim" class="btn btn-primary">View Old HiSim Graph</button>
    -->
</div>

<form id="todo-id" class="form-horizontal" role="form" method="post">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h2 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#jcCollapse">
                            Rerun Tool Options
                        </a>
                    </h2>
                </div>
                <div id="jcCollapse" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_DisableBootstrap']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_NodeCutoff']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_radio(tool.params['PhenomeMap_Homology']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_GenesInNode']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_UseFDR']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_HideUnEmphasized']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_p-Value']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MinOverlap']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MinGenes']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_PermutationTimeLimit']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MaxInNode']) }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_Permutations']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MaxLevel']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <input type="hidden" name="genesets" value="{{ async_result.gs_ids|join(' ') }}"/>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary"
                                        type='submit'
                                        value='run'
                                        onclick='this.form.action="{{ url_for('PhenomeMap.run_tool') }}";'>
                                    Run
                                </button>
                            </div>
                            <div class="span12">
                                <a class="btn btn-success"
                                   href='/PhenomeMap-result/{{ async_result.parameters.output_prefix }}.csv'>
                                    Download csv</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


{#
    TEAM HISIM GRAPH NOTES:
        We left this section commented out and didn't use it at all in testing our page, however it appears that there
        is some important error handling happening here. We're leaving the code here commented out instead of
        either uncommenting it to be used or deleting it outright, so that it might be used and tested by someone
        working on this file in the future.
    END TEAM HISIM GRAPH NOTES

	A hack, since for some reason the tools return SUCCESS even when
	they fail. Checks to see if the results have a key, 'failed', which
	contains the error message for the failure.
#}
{#{% if not async_result.failed %}
<div id="PhenomeMap_cyt" style="position: relative; margin: 10px auto; height: 600px; width: 95%; border-style: solid;">
    <br/>
    <br/>
    Loading Hierarchical Similarity Graph...<br/>
    <br/>
    <br/>
</div>
<!-- js file for heatmap color interpolations -->
 <!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<a href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}">Export Graph as a PDF</a> |
<a target="_blank" href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}">Open in Static View</a>

{% else %}
	<div class="panel-body bg-red p-15" style="text-align:center">
		<strong>
			No bicliques were found during the analysis. Try running the
			tool again using different parameters.
		</strong>
	</div>
{% endif %}
#}

<div id="search"></div>

<div id="viz2">
    {#
     Script for handling download of .bmp file. Doesn't work yet. Feel free to scrap this part entirely, we just left it
     in case you can use it. Sam wrote it, so we're not sure what it does either.
    #}

    {#
    <script type="text/javascript">
        /*
         populates the form above with the svg data from the graph
         and the requested output and submits the form
         */
        console.log("IN THE SECOND SCRIPT TAG");
        $('#bmp_download').click(submit_download_form());
        console.log("AFTER THE CLICK ASSIGNMENT");
        function submit_download_form() {
            console.log("IN THE FUNCTION");
            //get the d3js svg element
            var tmp = document.getElementById("viz2");
            var svg = tmp.getElementsByTagName("svg")[0];

            //extract the data as svg text string
            var svg_xml = (new XMLSerializer).serializeToString(svg);
            console.log(svg_xml);
            //submit the form to the server with the result as an attachment to download
            var form = document.getElementById("bmp_download");
            form.href += '?svg=' + svg_xml;
            //form['output_format'].value = output_format;
            //form['data'].value = svg_xml;
            //form.submit();
        }
    </script>
    #}
</div>
<div id="viz-clone" style="display: none;">
</div>

<div id="stats" align="left" style="float: left; margin: 10px;">
    <h3>Stats</h3>
</div>
<div id="shortcuts" align="left" style="float: left; margin: 10px;">
    <h3>Shortcuts</h3>
    <table>
        <tr>
            <td><b>Zoom in: </b></td>
            <td>hover over the graph and scroll up</td>
        </tr>
        <tr>
            <td><b>Zoom out: </b></td>
            <td>hover over the graph and scroll down</td>
        </tr>
        <tr>
            <td><b>Panning mode: </b></td>
            <td>drag background</td>
        </tr>
        <tr>
            <td><b>Collapsing nodes: </b></td>
            <td>click on a circle on the graph</td>
        </tr>
        <tr>
            <td><b>Moving nodes: </b></td>
            <td>click and hold a circle to drag</td>
        </tr>
        <tr>
            <td><b>Emphasis genes: </b></td>
            <td>indicated with red text</td>
        </tr>
    </table>
</div>
<div id="legend" style="float: right; margin: 10px;">
    <h3>Legend</h3>
</div>
<canvas id="save-canvas" width="1000" height="1000" style="display:none;">
</canvas>
<div id="pngdataurl" style="display:none;"></div>
<div id="svgdataurl" style="display:none;" class="svg-saver">
</div>

<script>

    //$('#dl').on('click', function(event) {

</script>

<div class="slider slider-horizontal">


</div>
<h4>
    Repulsion:
</h4>
<div id="charge_slider"></div>

<h4>
    Max repulsion distance:
</h4>
<div id="cd_slider"></div>

<h4>
    Link Strength:
</h4>
<div id="ls_slider"></div>


<h4>
    Link Distance:
</h4>
<div id="ld_slider"></div>


<h4>
    Gravitation towards center:
</h4>
<div id="gravity_slider"></div>



<script>

    //global variable containing the JSON data and the d3.force object
    var g = {
        data: null,
        force: null
    };

    //randomly generated prefix for the output file produced by Phenomemap.py
    var OUTPUT_PREFIX = "{{async_result.parameters.output_prefix}}";
    g.data = {{data | safe}};

    //dictionary of species & colors. Multiple Species defaults to gray.
    var color_dict = {};
    color_dict["Multiple Species"] = "#636363";

    //color palette for the nodes
    var colors_g = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477",
        "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300",
        "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac"];

    //initialization
    $(function () {

        var width = '900',
                height = '700',
                select2_data;

        var r = 6,
                fill = d3.scale.category20();


        //Create a sized SVG surface within viz, with zooming and panning capability:
        var svg = d3.select("#viz2")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr('viewBox', function() {return '0 0 ' + width + ' ' + height;})
                .call(d3.behavior.zoom()
                        .on("zoom", function () {
                            svg.attr("transform", "translate(" + d3.event.translate + ")" + "scale(" + d3.event.scale + ")")
                        }))
                .append("g");

        g.link = svg.selectAll("path.link"),
                g.node = svg.selectAll(".node");


        //d3 sliders for charge, charge distance, link strength, link distance, and gravity, respectively.
        var charge_slider = d3.slider()
                .axis(true)
                .min(0)
                .max(100)
                .step(.1)
                .value(40)
                .on('slide', function (e, v) {
                    g.force.start();
                });

        var cd_slider = d3.slider()
                .axis(true)
                .min(0)
                .max(100)
                .step(.1)
                .value(30)
                .on('slide', function (e, v) {
                    g.force.chargeDistance(v / .1);
                    g.force.start();
                });


        var ls_slider = d3.slider()
                .axis(true)
                .min(1)
                .max(100)
                .step(.1)
                .value(30)
                .on('slide', function (e, v) {
                    g.force.start();
                });

        var ld_slider = d3.slider()
                .axis(true)
                .min(1)
                .max(100)
                .step(.1)
                .value(40)
                .on('slide', function (e, v) {
                    g.force.start();
                });

        var gravity_slider = d3.slider()
                .axis(true)
                .min(0)
                .max(100)
                .step(.1)
                .value(20)
                .on('slide', function (e, v) {
                    g.force.gravity(Math.pow((v / 10), 2) / 100)
                    g.force.start();
                });

        d3.select("#charge_slider")
                .call(charge_slider);

        d3.select("#ls_slider")
                .call(ls_slider);

        d3.select("#ld_slider")
                .call(ld_slider);

        d3.select("#gravity_slider")
                .call(gravity_slider);

        d3.select("#cd_slider")
                .call(cd_slider)


        //Create a graph layout engine:
        g.force = d3.layout.force()
                .nodes(g.data.nodes)
                .links(getLinks(g.data.nodes))
                //linkDistance proportional to difference in depths to prevent crowding
                .linkDistance(function (link) {
                    return ((link.target.depth - link.source.depth) * ld_slider.value());
                })
                //linkStrength also proportional to distance
                .linkStrength(function (link) {
                    return 1 / ((link.target.depth - link.source.depth) * ls_slider.value() / 20);
                })
                //Deeper nodes have a stronger charge to force a more spread-out, triangular tree shape
                .charge(function (d) {
                    return (-charge_slider.value() * ((d.depth + 1) * 10));
                })
                .size([width, height])
                .on("tick", tick);


        //Initialize positions of tree elements to reduce tangling caused by random initialization
        var nodes = flatten(g.data.nodes);
        initialize_layout(nodes);

        //Data to search on
        select2_data = extract_select2_data();


        //Populate search bar
        $("#search").select2({
            data: select2_data,
            containerCssClass: "search"
        });


        //Draw the graph:
        //Note that this method is invoked again
        //when clicking nodes:
        update();

        //Create a svg legend
        var legend = d3.select("#legend")
                .append("svg")
                .attr("width", "300")
                .attr("height", function () {

                    return ((Object.keys(color_dict).length) * 20 + 10);
                })

                .selectAll("circle")
                .data(Object.keys(color_dict))
                .enter()
                .append("g")
                .attr("class", "node");

        //Color the legend circles
        legend.append("circle")
                .attr("r", 4.5)
                .style("fill", function (d) {
                    return color_dict[d];
                })
                .style("stroke", function (d) {
                    return color_dict[d];
                })
                .style("stroke-width", "3")
                .style("fill-opacity", ".5")
                .attr("cy", function (d) {
                    return 10 + 20 * Object.keys(color_dict).indexOf(d);
                })
                .attr("cx", 20);

        //Write the legend text
        legend.append("text")
                .text(function (d) {
                    return d;
                })
                .attr("dy", function (d) {
                    return 14 + 20 * Object.keys(color_dict).indexOf(d);
                })
                .attr("dx", "30")
                .attr("text-anchor", "start")
                .style("font", "12px sans-serif")
                .style("fill", "black");
    });


    //invoked once at the start,
    //and again when from 'click' method
    //which expands and collapses a node.
    function update() {
        var width = 960,
                height = 500,
                padding = 15;

        //iterate through original nested data, and get one dimensional array of nodes.
        var nodes = flatten(g.data.nodes);


        //Each node extracted above has an array of children id's.
        //from them, we can use a custom getLinks() layout function in order
        //to build a links selection.
        var links = getLinks(nodes);


        // pass both of those sets to the graph layout engine, and restart it
        g.force.nodes(nodes)
                .links(links)
                .start();

        //-------------------
        // create a subselection, wiring up data, using a function to define
        //how it's supposed to know what is appended/updated/exited
        g.link = g.link.data(links);

        //Build new links by adding new svg lines:
        g.link
                .enter()
                .insert("line", ".node")
                .attr("class", "link");

        // create a subselection, wiring up data, using a function to define
        //how it's suppossed to know what is appended/updated/exited
        g.node = g.node.data(nodes, function (d) {
            return d.id;
        });
        //Get rid of old nodes:
        g.node.exit().remove();
        g.link.exit().remove();
        //-------------------
        //create new nodes by making grouped elements that contain circles and text:
        var nodeEnter = g.node.enter()
                .append("g")
                .attr("class", "node")
                .on("click", click)
                .on("mousedown", function (d) {
                    d3.event.stopPropagation();
                })
                .call(g.force.drag);

        //circle within the single node group:
        nodeEnter.append("circle")
                .attr("r", 4.5);

        //Set link color based on search results
        g.link.style("stroke", function (d) {
            if (d.source.found && d.target.found) {
                return "red";
            }
            else {
                return "#ccc";
            }
        });

        //text within the single node group:
        nodeEnter.append("text")
                .style('font-family', 'Helvetica, Arial, sans-serif')
                .style('font-size', '12px')
                .attr("dy", "-.2em")
                .attr("dx", "1em")
                .attr("text-anchor", "start")
                .text(function (d) {
                    if (d.children.length > 0 || d._children) {
                        return;
                    }
                    else {
                        return d.Genesets.length <= 3 ? d.Genesets : d.Genesets.length + " sets...";
                    }
                });
        nodeEnter.append("text")
                .style('font-family', 'Helvetica, Arial, sans-serif')
                .style('font-size', '12px')
                .attr("dy", "1em")
                .attr("dx", function (d) {
                    return (d.children.length > 0) ? "-1em" : "1em";
                })
                .attr("text-anchor", function (d) {
                    return (d.children.length > 0) ? "end" : "start";
                })
                .text(function (d) {
                    if (d.children.length > 0 || d._children) {
                        return;
                    }
                    else {
                        return d.Genes.length <= 3 ? d.Genes : d.Genes.length + " genes...";
                    }
                });
        //mouseover information for each node
        nodeEnter.select("circle")
                .append("svg:title")
                .text(function (d) {
                    return d.tooltip;
                });

        //All nodes, do the following:
        g.node.select("circle")
                .style("fill", function (d) {
                    return colors_google(d);
                })
                .style("stroke", function (d) {
                    return colors_google(d);
                })
                .style("fill-opacity", opacity);
        //-------------------

        g.node.selectAll("text").attr("fill", textColor);

        g.force.start();
        var circles = d3.selectAll("circle");
        circles.attr("r", function (d) {
            return (d.weight >= 3 ? 4.5 * Math.sqrt(d.weight) : 4.5);
        });
    }

    //used for assigning colors to nodes
    function colors_google(d) {
        //console.log("Species: " + d.species + "Species Length:" + d.species.length);

        if (d.species.length > 1) {
            return "#636363";
        }

        else if (!(d.species in color_dict)) {
            color_dict[d.species] = colors_g[(Object.keys(color_dict).length % colors_g.length)];
        }

        return color_dict[d.species];
    }

    //Change opacity based on number of children
    function opacity(d) {
        return d._children ? "1" // collapsed package
                :
                d.children.length > 0 ? ".55" // expanded package
                        :
                        "0"; // leaf node
    }

    //Changes text color for emphasis
    function textColor(d) {
        if (d.emphasis) {
            return '#CC0000';
        }
        else return 'default';
    }

    // $("#tooltip").mousemove(function (e) {
    //find X & Y coordinates
    //   x = e.clientX,
    //         y = e.clientY;

    //Set tooltip position according to mouse position
    // tooltipSpan.style.top = (y + 20) + 'px';
    // tooltipSpan.style.left = (x + 20) + 'px';
    // });


    // Invoked from 'update'.
    // The original source data is not the usual nodes + edge list,
    // but rather an adjacency list of nodes and their children.
    // We need a list of nodes + links for the force layout engine.
    // So returns a list of all nodes under the root.
    function flatten(data) {
        var nodes = [];
        //checks to see which nodes have no parents. these are the only nodes we will recurse on,
        //to make sure we cover the entire tree with minimum redundancy. Worth a O(n) operation once
        //to save up to n extra recursive calls, and prevents collapsed children from showing up when they
        //shouldn't
        for (var i = 0, len = data.length; i < len; i++) {
            data[i].orphan = true;
        }
        for (var i = 0, len = data.length; i < len; i++) {
            if (data[i]._children) {
                for (var j = 0, jlen = data[i]._children.length; j < jlen; j++) {
                    getNodeByID(data, data[i]._children[j]).orphan = false;
                }
            }
            else {
                for (var j = 0, jlen = data[i].children.length; j < jlen; j++) {
                    getNodeByID(data, data[i].children[j]).orphan = false;
                }
            }
        }

        //recursively get each node's children and it's children's children. does not
        //look at collapsed children or their children.
        function recurse(node) {
            if (!getNodeByID(nodes, node.id)) {
                nodes.push(node);
            }
            if (node.children.length > 0) {
                for (var i = 0, count = node.children.length; i < count; i++) {
                    var nextNode = getNodeByID(data, node.children[i]);
                    recurse(nextNode);
                }
            }
        }

        //recurse on orphans only
        for (var i = 0, len = data.length; i < len; i++) {
            if (data[i].orphan) {
                recurse(data[i]);
            }
        }
        return nodes;
    }

    //nodes are identified in the children arrays by their ID, so we need
    //this function to access the nodes.
    function getNodeByID(nodes, wanted_id) {
        for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].id == wanted_id) {
                return nodes[i];
            }
        }
    }

    //gets the array of link objects for the force diagram to use
    function getLinks(nodes) {
        var links = [];
        for (var i = 0; i < nodes.length; i++) {
            var n = nodes[i];
            for (var j = 0; j < n.children.length; j++) {
                var link = {
                    source: n,
                    target: getNodeByID(nodes, n.children[j])
                };
                if (link.source.found && link.target.found) {
                    link.class = "found";
                }
                links.push(link);
            }
        }
        return links;
    }

    //d3 randomly initializes force layout, and that causes some problem for our tree, so this deterministically
    //initalizs node position
    function initialize_layout(nodes) {
        var nextdepths = [0];
        var previous = [-1];
        for (i = 0; i < nodes.length; i++) {
            while (nodes[i].depth > nextdepths.length - 1) {
                nextdepths.push(0);
                previous.push(-1);
            }
            if (previous[nodes[i].depth] >= 0) {
                prevNode = getNodeByID(nodes, previous[nodes[i].depth]);
                prevNode.below = nodes[i].id;
                nodes[i].above = prevNode.id;
            }
            previous[nodes[i].depth] = nodes[i].id;
            nodes[i].x = nodes[i].depth * 100 + 100;
            nodes[i].y = nextdepths[nodes[i].depth] * 20 + 100;
            nextdepths[nodes[i].depth]++;
        }
    }


    //Collapses nodes upon click, unless they're being dragged.
    //essentially switches the "active" children array with the
    // "hidden" _children array.
    function click(d) {
        if (d3.event.defaultPrevented) return; // ignore drag
        if (d.children.length > 0) {
            d._children = d.children;
            d.children = [];
            nodes = flatten(g.data.nodes);
            initialize_layout(nodes);
        } else if (d._children) {
            d.children = d._children;
            d._children = null;
            nodes = flatten(g.data.nodes);
            initialize_layout(nodes);
        }
        else {
            var paths = [];
            for (var i = 0; i < d.Genesets.length; i++) {
                paths = paths.concat(searchTree(d.Genesets[i]));
            }
            openPaths(paths);
        }
        //
        update();
    }


    //searches on a string sent in from the dropdown
    function searchTree(search) {
        console.log("SEARCH STRING : " + search);
        path = [];
        for (var i = 0; i < g.data.nodes.length; i++) {
            g.data.nodes[i].found = false;
            if (g.data.nodes[i].Genesets.indexOf(search) >= 0
                    || g.data.nodes[i].Genes.indexOf(search) >= 0
                    || g.data.nodes[i].species.indexOf(search) >= 0) {
                path.push(g.data.nodes[i]);
            }
        }
        return path;
    }

    //Exctracts the data to search on
    //TODO: there is an edge case where sometimes bootstrapping can have a childless node not at the bottom of the
    //  tree. this function assumes that the bottom of the tree is the level at which the first leaf node is found.
    //  Need to change this algorithm to get information from each leaf node regardless of depth.
    function extract_select2_data() {
        var index = 0;
        var data = g.data.nodes;
        var leaves = [];
        var leaf = data[0];
        while (leaf.children.length > 0) {
            leaf = getNodeByID(data, leaf.children[0]);
        }
        var leafdepth = leaf.depth;
        for (var i = 0; i < data.length; i++) {
            if (data[i].depth == leafdepth) {
                if (leaves.indexOf(data[i].Genesets[0]) < 0) {
                    leaves.push(data[i].Genesets[0]);
                }
                for (var j = 0; j < data[i].Genes.length; j++) {
                    if (leaves.indexOf(data[i].Genes[j]) < 0) {
                        leaves.push(data[i].Genes[j]);
                    }
                }
                for (var j = 0; j < data[i].species.length; j++) {
                    if (leaves.indexOf(data[i].species[j]) < 0) {
                        leaves.push(data[i].species[j]);
                    }
                }
            }
        }
        leaves.sort();
        console.log(leaves);
        leavesArr = [];
        for (var i = 0; i < leaves.length; i++) {
            leavesArr.push({"id": ++index, "text": leaves[i]});
        }
        return leavesArr;
    }

    //Find the searched path and expand the collapsed nodes
    function openPaths(paths) {
        for (var i = 0; i < paths.length; i++) {
            //if (!paths[i].orphan) {//i.e. not root
            paths[i].found = true;
            if (paths[i]._children) { //if children are hidden: open them, otherwise: don't do anything
                paths[i].children = paths[i]._children;
                paths[i]._children = null;
            }
        }
        update();
    }


    //attaching the search functionality to the search div tag
    $("#search").on("select2-selecting", function (e) {
        var roots = [];
        var paths = [];

        paths = searchTree(e.object.text);
        console.log(paths);
        if (typeof(paths) !== "undefined") {
            openPaths(paths);
        }
        else {
            alert(e.object.text + " not found!");
        }
    });


    //event handler for every time the force layout engine
    //says to redraw everything: keeps each node in its respective column
    function tick() {
        g.node.attr("transform", function (d) {
            //collide(d);
            d.x = d.depth * 200 + 100;
            return ("translate(" + d.x + "," + d.y + ")");
        });

        //redraw position of every link within the link set:
        g.link.attr("x1", function (d) {
                    return d.source.x;
                })
                .attr("y1", function (d) {
                    return d.source.y;
                })
                .attr("x2", function (d) {
                    return d.target.x;
                })
                .attr("y2", function (d) {
                    return d.target.y;
                });
    }

    //retrieves statistics on the graph generated
    function loadStats() {
        var result = {{ async_result|tojson }};
        var stats_url = '/results/' + result.parameters.output_prefix + '.el.profile';
        $.get(stats_url, function (data) {
            var lines = data.split('\n');
            lines = lines.slice(Math.max(lines.length - 8, 1), lines.length - 2);
            if (lines.length != 6) {
                $('#stats').append('Not available.');
                return;
            }
            values = [];
            $.each(lines, function (i, v) {
                values.push(v.split(':')[1].trim());
            });
            stats_table = $('<table></table>');
            stats_table.append(
                    '<tr><td><b>Number of genes:</b></td><td>' + values[0] + '</td></tr>'
                    + '<tr><td><b>Number of genesets:</b></td><td>' + values[1] + '</td></tr>'
                    + '<tr><td><b>Number of bicliques:</b></td><td>' + values[3] + '</td></tr>'
                    + '<tr><td><b>Number of edges:</b></td><td>' + values[2] + '</td></tr>'
                    + '<tr><td><b>Max edge biclique size:</b></td><td>' + values[4] + '</td></tr>'
                    + '<tr><td><b>Max vertex biclique size:</b></td><td>' + values[5] + '</td></tr>'
            );
            stats_table.find('td').css('padding', 0);
            $('#stats').append(stats_table);
        });
    }
    // load statistics from file
    $(window).load(loadStats);

    // Code for viewing the old hisim graph. Works, but needs size and
    // orientation adjustments, or should be plugged into cytoscape.
    //$('#old-hisim').on('click', function(event) {

    //    var runhash = '{{async_result.parameters.output_prefix}}';
    //    var fp = '/results/' + runhash + '.svg';

    //    d3.xml(fp, "image/svg+xml", function(error, xml) {
    //        if (error) {

    //            console.log(fp);
    //            console.log(error);
    //            return;
    //        }

    //        var oldsvg = xml.documentElement;
    //        oldsvg.setAttribute('width', '900');
    //        oldsvg.setAttribute('height', '700');
    //
    //        $('#viz2 > svg').toggle();
    //        $('#viz2').append(xml.documentElement);
    //    });
    //});

    $('.download-image').on('click', function(event) {

        var dlurl = '/downloadResult';
        // Removes 'dl-' from the id string
        var filetype = event.target.id.slice(3);
        var isOld = event.target.id.slice(0, 2) == 'ol' ? true : false;

        // Gives our SVG a white background color prior to conversion.
        // This actually changes the image the user is seeing, but they
        // shouldn't be able to notice.
        d3.select('svg')
            .insert('rect', 'g')
            .attr('width', '100%')
            .attr('height', '100%')
            .attr('fill', 'white');

        var html = d3.select("svg")
            .attr("version", 1.1)
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .node().parentNode.innerHTML;

        if (isOld) {
            var runhash = '{{async_result.parameters.output_prefix}}';
            var fp = runhash + '.svg';
            var oldver = fp;

        } else {
           var oldver = '';
        }

        $.post(dlurl, {svg: html, filetype: filetype, oldver: oldver}).done(function(data) {

            if (filetype == 'png')
                var png = 'data:image/png;base64,' + data;

            else if (filetype == 'pdf')
                var png = 'data:application/pdf;base64,' + data;

            else
                var png = 'data:xml/svg;base64,' + data;

            var a = document.createElement("a");
            a.download = 'result.' + filetype;
            a.href = png;

            document.body.appendChild(a);

            a.click();
        });
    });
</script>
