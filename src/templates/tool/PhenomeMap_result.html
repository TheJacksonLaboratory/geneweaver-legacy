{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<head xmlns="http://www.w3.org/1999/html">
    <meta charset="utf-8">
    <style>
        .node circle {
            cursor: pointer;
            stroke: #3182bd;
            stroke-width: 3px;
        }

        .found {
            fill: #ff4136;
            stroke: #ff4136;
        }

        .node text {
            /*font: 12px sans-serif;*/
            font-size: 12px;
            font-family: "Arial", sans-serif;
            pointer-events: none;
            text-shadow: -1px -1px 0 #FFF,
            1px -1px 0 #FFF,
            -1px 1px 0 #FFF,
            1px 1px 0 #FFF;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        /*Just making sure the select2 box is glued to the top*/
        .search {
            width: 100%;
            border-radius: 4px;
        }

        a.d3-slider-handle {
            background: #00A2D9;
            border-radius: 4px;
            border: 0px;
        }

        .d3-slider {
            background: #2B3647;
            border-radius: 4px;
            width: 720px;
            position: absolute;
        }

        a.btn-success {
            color: #fff;
            background-color: #006400;
            border-color: #004C74;
        }
    </style>

</head>
<!-- Styling for d3 sliders -->
<link rel="stylesheet" type="text/css" href="../../static/css/d3.slider.css"> </link>
<!-- Styling for select2 search bar -->
<link rel="stylesheet" type="text/css" href="../../static/select2/select2.min.css"> </link>
<!-- Library for standard d3 functions -->
<script type="text/javascript" src="../../static/d3/d3.min.js"></script>
<!-- Library for select2 search bar -->
<script type="text/javascript" src="../../static/select2/select2.min.js"></script>
<!-- Additional d3 library for d3 sliders -->
<script type="text/javascript" src="../../static/d3/d3.slider.js"></script>


<div class="page-header">
    <h1>{{ title }}
        {{ runhash }} </h1>
</div>


{#
	Checks to see if runhash is defined. If it is, that means we're
	viewing a stored result and PhenomeMap.js won't work properly without
	the extra $.get() call below.
#}


{% if runhash %}
    <script type="text/javascript">

        var graph_url = '/results/' + '{{async_result.result_image}}';
        var xml = '';
        $.get(graph_url, function (data) {
            xml = data;
            load_cytoscape();
        });

    </script>
{% endif %}


{#
{% if state == 'FAILURE' %}
 #}
{% if async_result.error %}
    <div class="panel-body bg-red p-15" style="text-align:center">
        <strong>
            {{ async_result.error }}
        </strong>
    </div>
    <br />
{% endif %}


<form id="todo-id" class="form-horizontal" role="form" method="post">
    <div class="panel panel-info" >
        <div class="panel-heading bg-green">
			<a data-toggle="collapse" data-parent="#accordion" href="#jcCollapse"style="color:#FFFFFF; width:100%;">
				<div class="panel-title" style="width:100%;">
					Tool Options
				</div>
			</a>
        </div>
        <div id="jcCollapse" class="panel-collapse collapse" style="">
            <div class="panel-body" style="font-size:13px;border-radius:5px; border:1px solid #006400">
                <div class="row">
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_DisableBootstrap']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_NodeCutoff']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_radio(tool.params['PhenomeMap_Homology']) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_GenesInNode']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_UseFDR']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_HideUnEmphasized']) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_p-Value']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_MinOverlap']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_MinGenes']) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_PermutationTimeLimit']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_MaxInNode']) }}
                    </div>
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_Permutations']) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ macros.tool_param_select(tool.params['PhenomeMap_MaxLevel']) }}
                    </div>
                    <div class="col-md-4">
                        <input type="hidden" name="genesets" value="{{ async_result.gs_ids|join(' ') }}"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <button class="btn btn-primary"
                                type='submit'
                                value='run'
                                onclick='this.form.action="{{ url_for('PhenomeMap.run_tool') }}";'>
                            Re-Run Tool
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<div class="panel panel-info" >
	<div class="panel-heading bg-green">
		<a data-toggle="collapse" data-parent="#accordion" href="#viz-options"style="color:#FFFFFF; width:100%;">
			<div class="panel-title" style="width:100%;">
				Visualization Options
			</div>
		</a>
	</div>
	<div id="viz-options" class="panel-collapse collapse" style="">
		<div class="panel-body" style="font-size:13px;border-radius:5px; border:1px solid #006400">
			<div class="row">
				<div class="col-md-3">
					{#
						TODO: Highlighting entities should be done by gene name, not
						by internal GW identifier.
					#}
					<p style="font-size:13px; font-weight:400;">
						<b>Highlight Genes, GeneSets, or Species:</b>
					</p>
				</div>
				<div class="col-md-9">
					<div id="search"></div>
				</div>
			</div>
			<br />
            <div class="row">
				<div class="col-md-3">
					<div class="btn-group">
						<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							Download as...
							<span class="caret"></span>
						</button>
						<ul class="dropdown-menu">
							<li><a class="download-image" id="dl-pdf" href="">PDF</a></li>
							<li><a class="download-image" id="dl-png" href="">PNG</a></li>
							<li><a class="download-image" id="dl-svg" href="">SVG</a></li>
							<li role="separator" class="divider"></li>
							<li><a class="download-image" id="ol-png" href="">PNG (Old HiSim)</a></li>
							<li role="separator" class="divider"></li>
							<li><a class="download-text" id="dl-csv" href="/PhenomeMap-result/{{ async_result.parameters.output_prefix }}.csv">
								CSV
							</a></li>
						</ul>
					</div>
				</div>
            </div>
		</div>
	</div>
</div>


{#
    TEAM HISIM GRAPH NOTES:
        We left this section commented out and didn't use it at all in testing our page, however it appears that there
        is some important error handling happening here. We're leaving the code here commented out instead of
        either uncommenting it to be used or deleting it outright, so that it might be used and tested by someone
        working on this file in the future.
    END TEAM HISIM GRAPH NOTES

	A hack, since for some reason the tools return SUCCESS even when
	they fail. Checks to see if the results have a key, 'failed', which
	contains the error message for the failure.
#}
{#{% if not async_result.failed %}
<div id="PhenomeMap_cyt" style="position: relative; margin: 10px auto; height: 600px; width: 95%; border-style: solid;">
    <br/>
    <br/>
    Loading Hierarchical Similarity Graph...<br/>
    <br/>
    <br/>
</div>
<a href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}">Export Graph as a PDF</a> |
<a target="_blank" href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}">Open in Static View</a>

{% else %}
	<div class="panel-body bg-red p-15" style="text-align:center">
		<strong>
			No bicliques were found during the analysis. Try running the
			tool again using different parameters.
		</strong>
	</div>
{% endif %}
#}


<div id="viz2">
</div>
<div id="viz-clone" style="display: none;">
</div>
<div class="">
</div>

<div id="stats" align="left" style="float: left; margin: 10px;">
    <h3>Stats</h3>
</div>
<div id="shortcuts" align="left" style="float: left; margin: 10px;">
    <h3>Shortcuts</h3>
    <table>
        <tr>
            <td><b>Zoom in: </b></td>
            <td>hover over the graph and scroll up</td>
        </tr>
        <tr>
            <td><b>Zoom out: </b></td>
            <td>hover over the graph and scroll down</td>
        </tr>
        <tr>
            <td><b>Panning mode: </b></td>
            <td>drag background</td>
        </tr>
        <tr>
            <td><b>Collapsing nodes: </b></td>
            <td>click on a circle on the graph</td>
        </tr>
        <tr>
            <td><b>Moving nodes: </b></td>
            <td>click and hold a circle to drag</td>
        </tr>
        <tr>
            <td><b>Emphasis genes: </b></td>
            <td>indicated with red text</td>
        </tr>
    </table>
</div>
<div id="legend" style="float: right; margin: 10px;">
    <h3>Legend</h3>
</div>
<canvas id="save-canvas" width="1000" height="1000" style="display:none;">
</canvas>
<div id="pngdataurl" style="display:none;"></div>
<div id="svgdataurl" style="display:none;" class="svg-saver">
</div>

{#
<div class="slider slider-horizontal">


</div>
<h4>
    Repulsion:
</h4>
<div id="charge_slider" style="padding-right:5px;margin:0 0px 20px 10px"></div>

<h4>
    Max repulsion distance:
</h4>
<div id="cd_slider" style="margin:0 0px 20px 10px"></div>

<h4>
    Link Strength:
</h4>
<div id="ls_slider" style="margin:0 0px 20px 10px"></div>


<h4>
    Link Distance:
</h4>
<div id="ld_slider" style="margin:0 0px 20px 10px"></div>


<h4>
    Gravitation towards center:
</h4>
<div id="gravity_slider" style="margin:0 0px 20px 10px"></div>
#}




<script type="text/javascript" src="../../static/tools/PhenomeMap.js"></script>
<script>
	$(function() {
		var graphData = {{data | safe}};
		var graphStats = {{async_result | tojson}};

		doThings(graphData);
		loadStats(graphStats);

	});
</script>

