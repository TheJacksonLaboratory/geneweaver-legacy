{% set title=tool.name + " Results" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}
<head>
    <meta charset="utf-8">
    <style>

        .node circle {
            cursor: pointer;
            stroke: #3182bd;
            stroke-width: 3px;
            r: 4.5;
        }

        .found {
            fill: #ff4136;
            stroke: #ff4136;
        }

        .node text {
            font: 12px sans-serif;
            pointer-events: none;
        }

        line {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

       path{
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }

        .link{
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
         }

        /*Just making sure the select2 box is glued to the top*/
        .search {
	        width: 100%;
	    }

    </style>

</head>
{#
<!-- JSON support for IE (needed to use JS API) -->
<script type="text/javascript" src="../../static/js/cytoscape/json2.min.js"></script>
<!-- Flash embedding utility (needed to embed Cytoscape Web) -->
<script type="text/javascript" src="../../static/js/cytoscape/AC_OETags.min.js"></script>
<!-- Cytoscape Web JS API (needed to reference org.cytoscapeweb.Visualization) -->
<script type="text/javascript" src="../../static/js/cytoscape/cytoscapeweb.min.js"></script>
<!-- Cytoscape settings and graph rendering for tool output -->
<script type="text/javascript" src="../../static/js/cytoscape/PhenomeMap.js"></script>
#}
<script type="text/javascript" src="../../static/d3/d3.min.js"></script>
<script type="text/javascript" src="../../static/d3/HiSimGraph.js"> </script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.js"></script>


<div class="page-header">
    <h1>{{ title }}
    {{async_result.parameters.output_prefix}} </h1>
</div>

{# {{ async_result.parameters.output_prefix}} #}

{#
	Checks to see if runhash is defined. If it is, that means we're
	viewing a stored result and PhenomeMap.js won't work properly without
	the extra $.get() call below.
#}

{#
{% if runhash %}
    <script type="text/javascript">

        console.log('wtf');

        var graph_url = '/results/' + '{{async_result.result_image}}';
        var xml = '';
        $.get(graph_url, function (data) {
            xml = data;
            load_cytoscape();
        });

    </script>
{% endif %}
#}

<form id="todo-id" class="form-horizontal" role="form" method="post">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h2 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#jcCollapse">
                            Rerun Tool Options
                        </a>
                    </h2>
                </div>
                <div id="jcCollapse" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_DisableBootstrap']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_NodeCutoff']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_radio(tool.params['PhenomeMap_Homology']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_GenesInNode']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_UseFDR']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_HideUnEmphasized']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_p-Value']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MinOverlap']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MinGenes']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_PermutationTimeLimit']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MaxInNode']) }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_Permutations']) }}</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">{{ macros.tool_param_select(tool.params['PhenomeMap_MaxLevel']) }}</div>
                            </div>
                            <div class="col-md-4">
                                <input type="hidden" name="genesets" value="{{ async_result.gs_ids|join(' ') }}"/>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary"
                                        type='submit'
                                        value='run'
                                        onclick='this.form.action="{{ url_for('PhenomeMap.run_tool') }}";'>
                                    Run
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

{#
	A fucking hack, since for some reason the tools return SUCCESS even when
	they fail. Checks to see if the results have a key, 'failed', which
	contains the error message for the failure.
#}
{# {% if not async_result.failed %}
<div id="PhenomeMap_cyt" style="position: relative; margin: 10px auto; height: 600px; width: 95%; border-style: solid;">
    <br/>
    <br/>
    Loading Hierarchical Similarity Graph...<br/>
    <br/>
    <br/>
</div>
<!-- js file for heatmap color interpolations -->
 <!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<a href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.pdf') }}">Export Graph as a PDF</a> |
<a target="_blank" href="{{ url_for('static_results', filename=async_result.parameters.output_prefix + '.svg') }}">Open in Static View</a>

<div id="stats" align="left" style="float: left; margin: 10px">
    <h3>Statistics</h3>
</div>
<div id="shortcuts" align="left" style="float: left; margin: 10px">
    <h3>Shortcuts</h3>
    <table>
        <tr><td><b>Zoom in:</b></td><td>double click background</td></tr>
        <tr><td><b>Zoom out:</b></td><td>shift + double click background</td></tr>
        <tr><td><b>Panning mode:</b></td><td> drag background</td></tr>
    </table>
</div>
{% else %}
	<div class="panel-body bg-red p-15" style="text-align:center">
		<strong>
			No bicliques were found during the analysis. Try running the
			tool again using different parameters.
		</strong>
	</div>
{% endif %}
<script type="text/javascript">
    function loadStats() {
        var result = {{ async_result|tojson }};
        var stats_url = '/results/' + result.parameters.output_prefix + '.el.profile';
        $.get(stats_url, function(data) {
            var lines = data.split('\n');
            lines = lines.slice(Math.max(lines.length - 8, 1), lines.length - 2);
            if(lines.length != 6) {
                $('#stats').append('Not available.');
                return;
            }
            values = [];
            $.each(lines, function(i, v) { values.push(v.split(':')[1].trim()); });
            stats_table = $('<table></table>');
            stats_table.append(
                '<tr><td>Number of genes:</td><td>' + values[0] + '</td></tr>'
                + '<tr><td>Number of genesets:</td><td>' + values[1] + '</td></tr>'
                + '<tr><td>Number of bicliques:</td><td>' + values[3] + '</td></tr>'
                + '<tr><td>Number of edges:</td><td>' + values[2] + '</td></tr>'
                + '<tr><td>Max edge biclique size:</td><td>' + values[4] + '</td></tr>'
                + '<tr><td>Max vertex biclique size:</td><td>' + values[5] + '</td></tr>'
            );
            stats_table.find('td').css('padding', 0);
            $('#stats').append(stats_table);
        });
    }
    // load statistics from file
    $(window).load(loadStats);
</script>
#}



<div id="viz2"></div>
