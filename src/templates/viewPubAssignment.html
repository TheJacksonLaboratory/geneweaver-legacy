{% set title="Publication Assignment" %}
{% include 'header.html' %}

{% if g.user.user_id == 0 %}
    {% include 'htmlfragments/permissionError.html' %}
{% elif view == 'no_access' %}
    {% include 'htmlfragments/genericPermissionError.html' %}
{% else %}

    {% if view == 'group_admin' or view == 'assigner' %}
        {% include 'modal/assignPublicationToCurator.html' %}
    {% elif view == 'assignee' %}
        {% include 'modal/addGenesetStub.html' %}
    {% endif %}


    <div class="panel panel-default">
        <div class="panel panel-default panel-heading bg-gray-light">
            <h3 class="panel-title">Publication Curation Assignment</h3>
        </div>

        <div data-alerts="alerts" data-titles="{'warning': '<em>Warning!</em>'}" data-ids="myid" data-fade="5000"></div>

        <div class="panel-heading"
             style="border-bottom-width: thick; border-bottom-color: #006400;">
            <h3 class="panel-title" style="width:100%">Pubmed ID: {{ pub.pubmed_id }}</h3>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-12 col-md-9">
                    <div class="row">
                        <div class="col-xs-12 col-md-9">
                            <div class="row">
                                <div class="col-md-2">
                                    <p class="text-right">
                                        <strong>Title:</strong></p>
                                </div>
                                <div class="col-md-10">
                                    <p><strong>{{ pub.title }}</strong></p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-2">
                                    <p class="text-right">
                                        <strong>Authors:</strong></p>
                                </div>
                                <div class="col-md-10">
                                    <p>{{ pub.authors }}</p>
                                </div>
                            </div>
                            {% if pub.month %}
                                <div class="row">
                                    <div class="col-md-2">
                                        <p class="text-right">
                                            <strong>Month:</strong></p>
                                    </div>
                                    <div class="col-md-10">
                                        {{ pub.month }}
                                    </div>
                                </div>
                            {% endif %}
                            {% if pub.year %}
                                <div class="row">
                                    <div class="col-md-2">
                                        <p class="text-right">
                                            <strong>Year:</strong></p>
                                    </div>
                                    <div class="col-md-10">
                                        {{ pub.year }}
                                    </div>
                                </div>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-2">
                                    <p class="text-right">
                                        <strong>Abstract:</strong>
                                    </p>
                                </div>
                                <div class="col-md-10">
                                    <!-- no idea why I need to pad the bottom of
                                         this,  but the following row (URL) was
                                         squished up against the abstract -->
                                    <div style="padding-bottom: 10px">{{ pub.abstract }}</div>
                                </div>
                            </div>
                            {% if pub.pubmed_id %}
                                <div class="row">
                                    <div class="col-md-2">
                                        <p class="text-right">
                                            <strong>URL:</strong>
                                        </p>
                                    </div>
                                    <div class="col-md-10">
                                        <a href="http://www.ncbi.nlm.nih.gov/pubmed/{{ pub.pubmed_id }}">PUBMED: {{ pub.pubmed_id }}</a>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-xs-6 col-md-3">
                    <div class="row">
                        {% if assignment.state == assignment.UNASSIGNED %}
                            <p><strong>Curator:</strong> <span id="curatorName">Unassigned</span></p>
                        {% else %}
                            <p>
                                <strong>Curator:</strong> <span id="curatorName">{{ curator.first_name }} {{ curator.last_name }}</span>
                            </p>
                            <p>
                                <strong>State:</strong> <span id="state">{{ assignment.state_as_string }}</span>
                            </p>
                        {% endif %}
                        <div class="form-group">
                            <label for="notes"><h4>Notes:</h4></label>
                                <textarea class="form-control" rows="10"
                                          id="notes" {% if view == 'group_member' or assignment.state == assignment.REVIEWED %}readonly{% endif %}>{{ assignment.notes }}</textarea>

                            {% if view != 'group_member' %}
                                &nbsp;
                                <button type="button"
                                        class="btn btn-block btn-primary"
                                        id="saveNotes">
                                    <i class="fa fa-save pull-left"></i> Save Notes
                                </button>
                            {% endif %}
                        </div>
                        {% if view == 'group_admin' %}
                            <button type="button"
                                    class="btn btn-block btn-primary"
                                    id="assignCurator">
                                <i class="fa fa-user pull-left"></i> Assign To
                                Curator
                            </button>
                        {% elif view == 'assigner' %}
                            <button type="button"
                                    class="btn btn-block btn-primary"
                                    id="assignCurator">
                                <i class="fa fa-user pull-left"></i> Reassign
                            </button>
                            {% if assignment.state == assignment.READY_FOR_TEAM_REVIEW %}
                                <button type="button"
                                        class="btn btn-block btn-primary"
                                        id="sendBack">
                                    Send Back to Reviewer
                                </button>
                                <button type="button"
                                        class="btn btn-block btn-primary"
                                        id="closePubAssignment">
                                    Approve and Close
                                </button>
                            {% endif %}

                        {% elif view == 'assignee' %}
                            <button type="button"
                                    class="btn btn-block btn-primary"
                                    id="newGeneset">
                                <i class="fa fa-plus pull-left"></i> Create New Geneset
                            </button>
                            <button type="button"
                                    class="btn btn-block btn-primary"
                                    id="markAsComplete">
                                Mark as Complete
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="panel-heading"
             style="border-bottom-width: thick; border-bottom-color: #006400;">
                <h3 class="panel-title" style="width:100%">GeneSets Created For This Assignment:</h3>
        </div>
        <div class="panel-body" id="geneset_panel">
            {% for gs in genesets %}
                <p><a href="/curategeneset/{{ gs.geneset_id }}">GS{{ gs.geneset_id }}</a>: {{ gs.name }}</p>
                <p style="padding-left: 10px">{{ gs.description }}</p>
            {% endfor %}
        </div>
        <div class="panel-heading"
             style="border-bottom-width: thick; border-bottom-color: #006400;">
                <h3 class="panel-title" style="width:100%">Other Visible GeneSets Associated With This Publication:</h3>
        </div>
        <div class="panel-body">
            {% for gs in other_genesets %}
                <p><a href="/viewgenesetdetails/{{ gs.geneset_id }}">GS{{ gs.geneset_id }}: {{ gs.name }}</a></p>
                <p style="padding-left: 10px">{{ gs.description }}</p>
            {% endfor %}
        </div>
    </div>

    <script>
        $(document).ready(function () {
            var stub_placeholder_index = 0;
            var modal_stub_count = 1;
            var modal_fields = [];

            {% if view != 'group_member' %}
                // no idea why this was needed, but the "Save Notes" button was
                // disabled when the page was first rendered
                $('#saveNotes').prop("disabled", false).button("refresh");
            {% endif %}

            $('#assignCurator').on('click', function () {

                // when we show the modal window, we don't want a group selected.
                $("input:radio[name='curator']:checked").prop('checked', false).checkboxradio('refresh');

                // submit button will be disabled until the user selects a group radio button
                $('#assignToCurator').prop("disabled", true).button("refresh");
                $('#assignPubToCuratorModal').modal('show');
            });

            $("input:radio[name='curator']").on('click', function () {
                // submit button will be disabled until the user selects a curator
                // radio button
                $('#assignToCurator').prop('disabled', false).button('refresh');
            });

            function handlePostJsonError(data) {
                console.error("something bad happened: " + data.responseJSON.message);

                $(document).trigger("add-alerts", [
                    {
                        'message': data.responseJSON.message,
                        'priority': 'danger'
                    }
                ]);
            }

            $('#assignToCurator').on('click', function() {

                var params = {
                    "notes": $('#notes').val(),
                    "assignment_id": {{ assignment.id }},
                    "curator": $('input[name=curator]:checked').val()
                };

                $.post("{{ url_for('assign_publication_to_curator') }}", params, function (data) {


                    $(document).trigger("add-alerts", [
                        {
                            'message': "Publication Assigned",
                            'priority': 'success'
                        }
                    ]);

                    var curatorName  = data.curator_name;
                    var curatorEmail = data.curator_email;


                    // update the modal window to include a warning that
                    // the GeneSet is now assigned to this curator
                    var html =      "<strong>" +
                                    "This publication is currently assigned To " +
                                    curatorName + "(" + curatorEmail + "). " +
                                    "Are you sure you want to reassign it?" +
                                    "</strong>";

                    $('#alreadyAssignedWarning').html(html);
                    $('#notes').val($('#modalNotes').val());
                    $('#assignCurator').html("Reassign");
                    $('#curatorName').html(curatorName);
                }, 'json').fail(handlePostJsonError);


            });

            $('#saveNotes').on('click', function() {

                var params = {
                    "notes": $('#notes').val(),
                     "assignment_id": {{ assignment.id }}
                };

                $.post("{{ url_for('save_pub_assignment_note') }}", params, function (data) {
                    $('#modalNotes').val($('#notes').val());

                    $(document).trigger("add-alerts", [
                        {
                            'message': "Notes Saved",
                            'priority': 'success'
                        }
                    ]);
                }, 'json').fail(handlePostJsonError);
            });

            $('#newGeneset').on('click', function() {
                reset_stub_modal();
                $('#addStubModal').modal('show');
            });

            $('#markAsComplete').on('click', function() {
                var params = {
                    "notes": $('#notes').val(),
                    "assignment_id": {{ assignment.id }}
                };

                $.post("{{ url_for('mark_pub_assignment_as_complete') }}", params, function (data) {
                    $('#newGeneset').remove();

                    $('#state').html('Under Review');
                }, 'json').fail(handlePostJsonError);
            });


            $('#closePubAssignment').on('click', function() {
                var params = {
                    "notes": $('#notes').val(),
                    "assignment_id": {{ assignment.id }}
                };

                $.post("{{ url_for('close_pub_assignment') }}", params, function (data) {

                    // once the assignment is closed, remove these buttons
                    // (should we have a button to reopen?)
                    $('#saveNotes').remove();
                    $('#sendBack').remove();
                    $('#assignCurator').remove();
                    $('#closePubAssignment').remove();

                    $('#state').html('Closed');

                    $('#notes').prop('readonly', true);

                }, 'json').fail(handlePostJsonError);
            });


            $('#sendBack').on('click', function() {
                var params = {
                    "notes": $('#notes').val(),
                    "assignment_id": {{ assignment.id }}
                };

                $.post("{{ url_for('pub_assignment_rejection') }}", params, function (data) {
                    $('#sendBack').remove();
                    $('#assignCurator').html('Reassign');
                    $('#closePubAssignment').remove();

                    $('#state').html('Assigned (in progress)');

                }, 'json').fail(handlePostJsonError);
            });

            function validate_form () {
                var okay = true;

                for (var i = 0; i < modal_fields.length; i++) {
                    if (!$(modal_fields[i]).val()) {
                        okay = false;
                        break;
                    }
                }

                if (okay) {
                    $('#stubSubmit').attr('disabled', false).button('refresh');
                }
                else {
                    $('#stubSubmit').attr('disabled', true).button('refresh');
                }
            }

            function reset_stub_modal() {

                for (var i = 0; i < modal_fields.length; i++) {
                    if (modal_fields[i] == '#sp_id') {
                        $(modal_fields[i]).unbind('change');
                    }
                    else {
                        $(modal_fields[i]).unbind('keyup');
                    }
                }

                modal_fields = ['#name_1', '#figureLabel_1', '#description_1', '#sp_id'];
                $('#sp_id').change(validate_form);
                $('#name_1, #figureLabel_1, #description_1').keyup(validate_form);


                $('#stubSubmit').attr('disabled', true).button('refresh');

                $('#name_1').val("");
                $('#figureLabel_1').val("");
                $('#description_1').val("");
                $('#sp_id').val([]);

                $('#newRowContainer').html("");
            }

            $('#addStubRow').on('click', function () {

                $('#stubSubmit').attr('disabled', true).button('refresh');

                modal_stub_count++;

                html = '<div class="row" style="padding-top: 10px" id="stubRow_' + modal_stub_count + '">' +
                       '    <div class="col-md-3"><input' +
                       '             class="form-control" name="name_' + modal_stub_count + '"' +
                       '             id="name_' + modal_stub_count +'" type="text" required></div>' +
                       '     <div class="col-md-3"><input' +
                       '            class="form-control"' +
                       '            name="figureLabel_' + modal_stub_count + '" id="figureLabel_' + modal_stub_count + '"' +
                       '             type="text" required></div>' +
                       '     <div class="col-md-6"><textarea' +
                       '             class="form-control" name="description_'+ modal_stub_count + '"' +
                       '             id="description_' + modal_stub_count + '"' +
                       '             form="addStub" rows="1" cols="40"' +
                       '             required></textarea></div>' +
                       ' </div>';

                $('#newRowContainer').append(html);
                modal_fields.push('#name_' + modal_stub_count);
                modal_fields.push('#figureLabel_' + modal_stub_count);
                modal_fields.push('#description_' + modal_stub_count);

                $('#name_' + modal_stub_count).keyup(validate_form);
                $('#figureLabel_' + modal_stub_count).keyup(validate_form);
                $('#description_' + modal_stub_count).keyup(validate_form);



            });

            $('#stubSubmit').on('click', function () {
                var params = {
                    pub_assign_id: {{ assignment.id }},
                    species_id: $('#sp_id').val(),
                    stubs: []
                };

                var stubs = [];

                for (var i = 1; i <= modal_stub_count; i++) {
                    stubs.push({gs_name: $('#name_' + i).val(), gs_label: $('#figureLabel_' + i).val(), gs_description: $('#description_' + i).val()})
                }

                params.stubs = JSON.stringify(stubs);

                {#
                    create a placeholder in the list of genesets. Creating the
                    stub can take a few seconds because of the annotation.  This
                    lets the user know something is actually happening after
                    they click the button.

                    This will be updated with a link to the GeneSet curation
                    page once the server responds with the new genest ID
                #}
                var stub_index = stub_placeholder_index++;
                $('#geneset_panel').append('<div id="stub_' + stub_index + '">loading...</div>')

                $.post("{{ url_for('create_geneset_stub') }}", params, function (data) {

                    var html = "";

                    for (var i = 0; i < data.gs_ids.length; i++) {
                        html = html + '<p><a href="/viewgenesetdetails/' + data.gs_ids[i] +'">GS' + data.gs_ids[i] + '</a>: ' + stubs[i].gs_name + '</p><p style="padding-left: 10px">' + stubs[i].gs_description + '</p>'
                    }

                    $('#stub_' + stub_index).html(html);
                }, 'json').fail(handlePostJsonError);

            });
        });
    </script>
{% endif %}

{% include 'footer.html' %}
