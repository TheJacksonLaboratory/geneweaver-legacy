{% set title="Geneset Details" %}
{% include 'header.html' %}
{% import 'macros.html' as macros %}

<style type="text/css">
    .geneBox {
        padding: 7px;
        display: inline-block;
        border: 1px solid #000;
        vertical-align: middle;
    }

    #clickableHomology {
        cursor: pointer;
    }

    #clickablePriority {
        cursor: pointer;
    }

    #clickableGeneSymbol {
        cursor: pointer;
        }

</style>

{% if geneset.geneset_id is not defined %}

    <div class="alert alert-danger fade in">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="false">&times;</button>
        The GeneSet that you are looking for does not exist or you do not have permission to view its properties.
        <p>
            {% if user_id != 0 %}
                <p>You may also want to check your group permission settings.</p>
                <a href="/accountsettings.html">
                    <button type="button" class="btn btn-danger m-t-10 m-r-10" id="acount-redirect">Account Settings
                    </button>
                </a>
            {% else %}
                <a href="/login.html">
                    <button type="button" class="btn btn-danger m-t-10 m-r-10" id="login-redirect">Login</button>
                </a>
                <a href="/register.html">
                    <button type="button" class="btn btn-default m-t-10">Or Create a New Account</button>
                </a>
            {% endif %}
        </p>
    </div>

{% else %}

    <div class="row" id="result"></div>

    <div class="panel panel-default panel-heading bg-gray-light">
        <h2 class="panel-title"><strong>GeneSet Information</strong></h2>
    </div>




    <div class="panel panel-default">
    <div class="panel-heading" style="border-bottom-width: thick; border-bottom-color: #006400;">
        <h3 class="panel-title">
            {% if geneset.cur_id == 1 %}
                <span class="tier1" style="vertical-align: middle">Tier I</span>
            {% endif %}
            {% if geneset.cur_id == 2 %}
                <span class="tier2" style="vertical-align: middle">Tier II</span>
            {% endif %}
            {% if geneset.cur_id == 3 %}
                <span class="tier3" style="vertical-align: middle">Tier III</span>
            {% endif %}
            {% if geneset.cur_id == 4 %}
                <span class="tier4" style="vertical-align: middle">Tier IV</span>
            {% endif %}
            {% if geneset.cur_id == 5 %}
                <span class="tier5" style="vertical-align: middle">Tier V</span>
            {% endif %}
            GS{{ geneset.geneset_id }} &bull; {{ geneset.name }}</h3>
    </div>

    <!-- View GeneSet MetaData -->
    {% include 'viewGenesetMeta.html' %}

    <!-- Show the Geneset List -->
    <div class="panel panel-default">
        <div class="panel-heading" style="border-bottom-width: thick; border-bottom-color: #006400;">
            <h3 class="panel-title">Gene List &bull; {{ geneset.geneset_values|length }} Genes</h3>
        </div>
        <div class="panel-body">

            <div class="row">
                <div class="col-xs-12 col-md-9">
                    <div class="row">
                    </div>
                </div>
                <div class="col-xs-6 col-md-3">
                    <button type="button" class="btn btn-lg btn-block btn-warning" id="addToNewGeneset" style="margin-bottom: 10px;">
                        <i class="fa fa-star pull-left"></i> Add to New GeneSet
                    </button>
                </div>
            </div>

            <div class="row">
                <!-- TODO make the table sortable, show more gene details -->
                <table class="table table-hover">
                    <tbody>
                    <tr>
                        <th><a href="/viewgenesetdetails/{{ geneset.geneset_id }}?sort=symbol"><i class="fa fa-sort"></i></a> Default</th>
                        <th><a href="/viewgenesetdetails/{{ geneset.geneset_id }}?sort=alt"><i class="fa fa-sort"></i></a> {{ altGeneSymbol }}
                            <span id="clickableGeneSymbol"><i class="fa fa-gear"></i></span></th>
                        <th>Homology <span id="clickableHomology"><i class="fa fa-info-circle"></i></span></th>
                        <th><a href="/viewgenesetdetails/{{ geneset.geneset_id }}?sort=value"><i class="fa fa-sort"></i></a> Value</th>
                        <th><a href="/viewgenesetdetails/{{ geneset.geneset_id }}?sort=priority"><i class="fa fa-sort"></i></a> Priority
                            <span id="clickablePriority"><i class="fa fa-info-circle"></i></span></th>
                        <th>LinkOuts</th>
                        <th>Emphasis</th>
                        <th>&nbsp;</th>
                    </tr>

                    {% for geneset_value in geneset.geneset_values %}
                            <tr>
                                <td>
                                    <strong>
                                        <a href="/search/?searchbar={{ geneset_value.source_list[0] }}&pagination_page=1&searchGenes=yes">
                                            {{ geneset_value.source_list[0] }}
                                        </a>
                                    </strong>
                                </td>
                                <td>
                                    {# I needed to do some fancy array mapping to determine null values
                                     if the first and last value of the array are the same, then the value exists;
                                     otherwise, if they are the same AND altGeneSymbol==Symbol, then it exists. #}
                                    {% if geneset_value.ode_ref | first == geneset_value.ode_ref | last %}
                                        {% if altGeneSymbol == 'Symbol' %}
                                            <strong>
                                                {{ geneset_value.ode_ref[0] }}
                                            </strong>
                                        {% else %}
                                            None
                                        {% endif %}
                                    {% else %}
                                        <strong>
                                            {{ geneset_value.ode_ref[0] }}
                                        </strong>
                                    {% endif %}
                                </td>
                                <td>
                                    {# Make boxes for homology blocks #}
                                    {% for i in range(1,10) %}
                                        <span data-placement="top" data-toggle="tooltip" data-rel="tooltip" data-original-title="{{ tt[(i-1)] }}"
                                              title="{{ tt[(i-1)] }}">
                                        {% set exists = ['1'] %}
                                        {% for h in geneset_value.hom|sort %}
                                            {% if h == i %}
                                                <div class="geneBox" style="background-color: {{ colors[(i-1)] }};"></div>
                                                {% if exists.append('1') %}{% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if exists|length == 1 %}
                                            <div class="geneBox"></div>
                                        {% endif %}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <strong>
                                        {{ '%0.4f' % geneset_value.value|float }}
                                    </strong>
                                </td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-success progress-bar-striped"
                                             data-aria-valuetransitiongoal="{{ '%.0f' % geneset_value.gene_rank|float }}"
                                             aria-valuenow="{{ '%.0f' % geneset_value.gene_rank|float }}"
                                             style="width: {{ '%.0f' % geneset_value.gene_rank|float }}%;">
                                            {{ '%.0f' % geneset_value.gene_rank|float }}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <!-- TODO Insert outside links here -->
                                    {% set gene=geneset_value.source_list[0] %}
                                    {% include 'linkouts.html' %}
                                </td>

                                <td nowrap>
                                    <input type="checkbox" name="g_id[]" id="{{ geneset_value.ode_gene_id }}"
                                           onchange="emphasize('{{ geneset_value.ode_gene_id }}');"
                                           class="switch" data-size="mini"
                                           style="padding: 0px; vertical-align: middle;">

                                </td>
                                <td>
                                    <div class="ui-checkbox" style="padding: 0; border: 0; margin: 0;">
                                        <label for="addGeneset{{ geneset_value.source_list[0] }}"
                                               style="margin: -6px; padding-right: 0;">
                                            <input type="checkbox" name="gsoptions[]"
                                                   id="addGeneset{{ geneset_value.source_list[0] }}"
                                                   value="{{ geneset_value.source_list[0] }}"/>
                                        </label>
                                    </div>
                                </td>
                            </tr>

                    {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% for gene in emphgeneids %}
        <script>
            document.getElementById("{{gene}}").checked = true;
        </script>
    {% endfor %}

    <!-- <body onload="myFunction()"> -->

    <script type="text/javascript">
        $("[name='g_id[]']").bootstrapSwitch();


        $(function () {
            $("[data-toggle='tooltip']").tooltip();
        });

        $('#clickableHomology').popover({
                title: 'Homology Mapping', content: 'The colored boxes represent gene homology mappings to other species ' +
                'within GeneWeaver. Mouseover the boxes to reveal species names.'
        });

        $('#clickablePriority').popover({
                title: 'Percentile Priority Rank', content: 'All genes within GeneWeaver are ranked according to global ' +
                'graph centrality. A full description can be found <a href="http://www.geneweaver.org/wiki">here</a>.',
                html: 'true'
        });

        $('#clickableGeneSymbol').on('click', function (e) {
                $("#selectGeneDisplayType").modal('show');
        });



        function emphasize(id) {
            if (document.getElementById(id).checked) {
                $.get("/emphasize/" + id + ".html", function (data, status) {
                });
            }
            else {
                $.get("/deemphasize/" + id + ".html", function (data, status) {
                });
            }
        }

        $(document).ready(function () {
            var gs_id = {{ geneset.geneset_id }};

            $('#exportData').on('click', function (e) {
                window.open('../exportGeneList/' + gs_id);
            });

            $('#viewSimilarGenesets').on('click', function (e) {
                window.open('../viewSimilarGenesets/' + gs_id, "_self");
            });


            $('#selectGeneType').on('click', function (e) {
                var val = $('.dropdown-menu li a').parents('.btn-group').find('[data-bind="label"]' ).text().replace(/[\n\s\xA0]+/g, '');

                $.trim(val);

                $.ajax({
                    type: "GET",
                    url: "../updateAltGeneSymbol",
                    data: {"altSymbol": val},
                    success: function (data) {
                        location.reload();
                    }
                })

            });

        });

        $( document.body ).on( 'click', '#geneSymbol li', function( event ) {
            //WARNING: This function previously interfered with the dropdown menu
            //at the top of the page. I added IDs instead of classes. Seems to
            // work now
            $(this).parents('#geneSymbol').find( '.newName').text($(this).text())
                    .end()
                    .children( '.dropdown-toggle').dropdown( 'toggle');
            return false;
        });


        //});


    </script>

{% endif %}


{% include 'modal/selectGeneDisplayType.html' %}


{% include 'footer.html' %}
