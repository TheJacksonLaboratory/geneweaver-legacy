<script type="text/javascript">

    //// serializeForms
    //
    //// Serializes all of the search form related data. If the user requests
    //// sorting then the sortby argument is filled with the sort parameter
    //// (e.g. tier, size, species, etc.).
    //
    var serializeForms = function (sortby) {

        var data = $('#filterForm').serialize() + '&';
        data += $('#searchBarForm').serialize();

        //if (sortby !== undefined)
        //	data += '&sortBy=' + sortby;

        return data;
    };

    // Loading spinner because some search filters/options take a few seconds
    jQuery.ajaxSetup({
        beforeSend: function() {
            $('#loader').show();
        },
        complete: function(){
            $('#loader').hide();
        },
        success: function() {}
    });


    $(document).ready(function () {

        var url = '/searchFilter.json';

        // Sort by...
        $('.fa-sort').on('click', function (event) {

            event.preventDefault();

            // Sort arrow ID; this tells us how to sort
            var sortby = $(this).attr('id');
            $('#sortBy').val(sortby);
            // Gotta grab filter and search data prior to sending our sort data
            var data = serializeForms(sortby);
            //console.log('sorts');
            //console.log(data);

            $.post(url, data).done(function (data) {

                $('#replaceConentsOnUpdatedSeach').html(data).trigger('create');
                // Hidden form value has to be changed too so when other
                // filters are applied, we don't lose our ordering
                //$('#sortBy').val(sortby);
            });
        });
    });

</script>

<div class="loader" style="display:none"></div>

{% if paginationValues == None %}

    <form action="/search/" method="GET" id="searchBarForm">
        {% include'search/search_bar.html' %}
    </form>

	{% if noResults is defined and noResults == True %}

		<div class="row">
			<div class="alert alert-warning fade in">
				<button type="button" class="close" data-dismiss="alert" 
					aria-hidden="true">x</button>
				<strong>Your search returned 0 results.</strong>
			</div>
		</div>

	{% endif %}

{% endif %}

{% if paginationValues != None %}

    <div class="row">
    <div class="col-md-4">
        {% include 'search/search_filters_panel.html' %}
    </div>

    <div class="col-md-8">
        <!-- Define a form used for submitting future search requests. The action and method must match what routes are expecting. -->
        <!-- Note that search_filters_panel.html javascript depends on this id being properly  set in the form below for the search bar-->
        <form action="/search/" method="GET" id="searchBarForm">
            {% include'search/search_bar.html' %}
        </form>


        <br/>

        {% if paginationValues.totalFound == 0 %}
            <div class="row">
                <div class="alert alert-warning fade in">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
                    Your search returned 0 results.
                </div>
            </div>
        {% else %}


            {% if paginationValues.numResults == 1000 and paginationValues.totalFound > 1000 %}

                <div class="row">
                    <div class="alert alert-danger fade in">
                        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">x</button>
                        Search results are limited to 1000 results out of {{ paginationValues.totalFound }}. Try
                        refining your
                        search.
                    </div>
                </div>

            {% endif %}


            {# Used for any success/error messages from the add to project button #}
            <div class="row" id="result"></div>

            <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-md btn-block btn-warning" id="shareWithGroup" style="margin-bottom: 10px">
                        <i class="fa fa-share-alt pull-left" style="padding-top: 1px;"></i> Share Selected w/ Group
                    </button>
		</div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-md btn-block btn-warning" id="addToProject" style="margin-bottom: 10px">
                        <i class="fa fa-folder-o pull-left" style="padding-top: 1px;"></i> Add Selected to Project
                    </button>
                </div>
            </div>

            <!-- Show the panel heading with pagination, found in the search_results_header.html partial -->
            <!-- Show the panel heading with pagination -->
            <div class="panel panel-default">
                {% include 'search/search_results_header.html' %}
                <!-- Show the geneset table with geneset results -->
                <div class="panel-body">

                    <table id="results" class="table table-hover">
                        <tbody>
                        <tr>
                            <th align="center" style="text-align:center;">
                                <nobr>
                                    <i id="geneset" class="fa fa-check"></i>
                                </nobr>
                            </th>
                            <th>
                                <nobr>
                                    <a id="tier" href="#">
                                        <i id="tier" class="fa fa-sort"></i>
                                    </a>
                                    Tier
                                </nobr>
                            </th>
                            <th>
                                <nobr>
                                    <a id="species" href="#">
                                        <i id="species" class="fa fa-sort"></i>
                                    </a>
                                    Species
                                </nobr>
                            </th>
                            <th>
                                <nobr>
                                    <a id="size" href="#">
                                        <i id="size" class="fa fa-sort"></i>
                                    </a>
                                    Size
                                </nobr>
                            </th>
                            <th>
                                <nobr>
                                    Attr.
                                </nobr>
                            </th>
                            <th>
                                <nobr>
                                    <a id="geneset" href="#">
                                        <i id="geneset" class="fa fa-sort"></i>
                                    </a>
                                    GeneSet
                                </nobr>
                            </th>
                            <th>
                                <nobr>
                                    <a id="gs-expand" href="#">
                                        <i id="gs-expand" class="fa"></i>
                                    </a>
                                </nobr>
                            </th>
                        </tr>
                        {% for gs in genesets %}
                            <!--<tr>-->
                            <!--<td> -->
                            {% include 'viewGenesetSummaryPartial.html' %}
                            <!--</td> -->
                            <!--</tr> -->
                            <!-- TODO create a selector for adding genesets to projects, link will go here -->
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
{% endif %}
</div>

{% include 'modal/addGenesetsToProjects.html' %}
{% include 'modal/shareGenesetWithGroup.html' %}
{% include 'modal/showGenericMessage.html' %}

<script type="text/javascript" src="/static/js/geneweaver/tags.js"></script>
<script type="text/javascript">

	/**
	  * Although attribution and species tags are part of the
	  * viewGenesetSummaryPartial template, we generate the tags out here in
	  * the wrapper section otherwise this bit of javascript will be injected
	  * into every single search result (50 per page).
	  */
    $(document).ready(function () {

		{% if attribs %}
			makeAttributionTags({{ attribs | tojson | safe }});
		{% else %}
			makeAttributionTags();
		{% endif %}

		{% if species %}
			makeSpeciesTags({{ species | tojson | safe }});
		{% else %}
			makeSpeciesTags();
		{% endif %}
	});

    //var user_id = {{ user_id }};
    // gs_ids in the results that are checked and ready to add to a project
    var gschecked = {};

    // Called every time a checkbox is clicked and updates the list of
    // checked search results.
    $('input[type=checkbox]').on('click', function(event) {

        // The element object this event is referring to
        var box = event.target;

        // All search result checkboxes can be distinguished with this class
        if (box.className == 'search-check') {

            var idlen = 'gs-check-'.length;
            var gsid = box.id.slice(idlen);

            if (box.checked)
                gschecked[gsid] = gsid;
            else
                delete gschecked[gsid];
        }
    });

    // When a user is adding genesets to a new project, this allows them 
    // to hit enter to execute that addition without the page throwing
    // an http error
    $(document).on('keypress', function(e) {
        // 13 == ENTER
        if (e.keyCode && e.keyCode === 13 && $('#addToProjectModal').is(':visible'))
            e.preventDefault();
    });

    // A function to display the error modal
    var showErrorModal = function(message) {
        $('#showGenericModal').find('.modal-header')
            .removeClass('bg-green')
            .addClass('bg-red');
        $('#showGenericModal').find('.modal-title')
                .html('Error!');
        $('#showGenericModal').find('#genericMessage')
                .html(message);
        $('#showGenericModal').modal('show');
    }

    // Submit the modal information for 'Share w Group' and 'Add to Project' via AJAX
    var submitGSModalAjax = function(url, data) {
        $.ajax({
            type: "GET",
            url: url,
            data: data,
            success: function (data) {
                var v = JSON.parse(data);
                if (v["error"] != 'None') {
                    console.log("Error returned " + v['error']);
                    $("#result").html('<div class="alert alert-danger fade in"> ' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">x' +
                        '</button>' + v['error'] + '</div>');
                } else {
                    console.log('no error');
                    $("#result").html('<div class="alert alert-success fade in"> ' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">x' +
                        '</button>Geneset(s) submitted successfully.</div>');
                }

            },
            error: function (jqXHR, textStatus, errorThrown ) {

                $(document).trigger("add-alerts", [{
                    'message': "An Error (" + jqXHR + ") occurred while submitting the geneset(s)",
                    'priority': 'danger'
                }]);
            }

        });

    }

    // Open a geneset modal and update selected genesets label
    var openGSModal = function(modalID, gschecked) {
        return function() {
            genesets = Object.keys(gschecked);

            // If no genesets selected, display geneneric error modal.
            if (genesets.length === 0) {
                showErrorModal('You must first select Genesets to add.');
            } else {
                var gsString = genesets.map(function(s){ return 'GS' + s; }).join(', ');
                $(modalID).find(modalID+'-label').html(gsString);
                $(modalID).find(modalID+'Value').val(genesets.join(','));
                $(modalID).modal('show');
            }
        }
    }

    // Collect data from modal for ajax call, or display error if needed
    var submitGSModal = function(modalID, url) {
        return function() {
            var selected = $(modalID+' select').val().map(Number);

            var option = JSON.stringify(selected);
            var g = $(modalID+'Value').val();
            var npn = null;

            var newNameElement = $(modalID+'NewName')

            if (newNameElement.length && newNameElement.val().length > 0) {
                npn = $(modalID+'NewName').val();
            }

            if ($.isEmptyObject(selected) && $.isEmptyObject(npn)){
                $("#result").html('<div class="alert alert-danger fade in"> ' +
                        '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">x' +
                        '</button>No Projects Were Selected</div>');
            } else {
                var data = {"npn": npn, "gs_id": g, "option": option}
                submitGSModalAjax(url, data);
            }
        }
    }

    // The 'Share Geneset(s) w/ Group' button
    $('#shareWithGroup').on('click', openGSModal('#shareWithGroupsModal', gschecked));

    // The 'Share with selected groups' button in the modal above 
    $('#shareGenesetsWithGroups').on('click', submitGSModal("#shareWithGroupsModal", "../shareGenesetsWithGroups"));

    // The 'Add GeneSet(s) to Project' button
    $('#addToProject').on('click', openGSModal('#addToProjectModal', gschecked));

    // The 'add to selected projects' button in the modal above
    $('#addGenesetsToProjects').on('click', submitGSModal("#addToProjectModal", "../addGenesetsToProjects"));

    // This chunk of code always needs to go with the addGenesetsToProjects
    // click handler
    $('#addNewProject').on('click', function () {
        $('#reveal-if-active').toggle();
    });
</script>
