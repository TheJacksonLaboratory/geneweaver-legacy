{# 	This page is injected into analyze.html--really it's included in
	singleProject.html, which is rendered by flask and then injected. Anyway,
	it seems like the beginning element on this page MUST be a row (<tr>), 
	otherwise jQuery will discard all rows and cells when this page is appended
	to a table in analyze.html.
#}

<tr class="genesetdetails" id="{{ gs.geneset_id }}">

    {% if proj is defined %}
        <td>
            <input
                    data-parentproject="{{ proj.project_id }}"
                    type="checkbox"
                    name="geneset_{{ gs.geneset_id }}"
                    class="table-checkbox proj-{{ proj.project_id }}-check">
        </td>
    {% endif %}


    <td>

        <!-- Label the tier - which is the curation id, Geneset.cur_id -->
        {% if gs.cur_id == 1 %}
            <span class="tier1">Tier I</span>
        {% endif %}
        {% if gs.cur_id == 2 %}
            <span class="tier2">Tier II</span>
        {% endif %}
        {% if gs.cur_id == 3 %}
            <span class="tier3">Tier III</span>
        {% endif %}
        {% if gs.cur_id == 4 %}
            <span class="tier4">Tier IV</span>
        {% endif %}
        {% if gs.cur_id == 5 %}
            <span class="tier5">Tier V</span>
        {% endif %}
    </td>

    <td>
        <!-- Label the species -->
        {% if gs.sp_id == 1 %}
            <span class="mouse">Mouse</span>
        {% endif %}
        {% if gs.sp_id == 2 %}
            <span class="human">Human</span>
        {% endif %}
        {% if gs.sp_id == 3 %}
            <span class="rat">Rat</span>
        {% endif %}
        {% if gs.sp_id == 4 %}
            <span class="zebrafish">Zebrafish</span>
        {% endif %}
        {% if gs.sp_id == 5 %}
            <span class="fly">Fly</span>
        {% endif %}
        {% if gs.sp_id == 6 %}
            <span class="monkey">Monkey</span>
        {% endif %}
    </td>

    <td>
        <!-- Show the geneset size -->
        <strong>{{ gs.count }}</strong>
    </td>

    <td>
        <!-- Label the attribution -->
        {% if gs.attribution == 2 %}
            <span class="ctd">CTD</span>
        {% endif %}
        {% if gs.attribution == 7 %}
            <span class="drg">DRG</span>
        {% endif %}
        {% if gs.attribution == 8 %}
            <span class="go">GO</span>
        {% endif %}
        {% if gs.attribution == 9 %}
            <span class="mp">MP</span>
        {% endif %}

    </td>




    <td>

        <a href="/viewgenesetdetails/{{ gs.geneset_id }}">GS{{ gs.geneset_id }}: {{ gs.name }} </a>
        <!-- need status for if not normal -->
        {% if gs.status != "normal" %}
            <span class="gs_status gs_{{ gs.status }}"
                  title="This GeneSet has been marked as {{ gs.status }}">{{ gs.status }}</span>

            <script>
                // This fixes the deprecated tags which weren't rendering properly
                // due to the gs_ids attached at the end.
                $('.gs_status').each(function (index) {

                    var dep = '{{gs.status}}';

                    if (dep.slice(0, 2) === 'de') {

                        $(this).attr('class', 'gs_deprecated');
                        $(this).attr('title', 'This geneset has been marked ' +
                        'as deprecated.');
                        $(this).html('Deprecated');
                    }
                });
            </script>
        {% endif %}
    </td>


    {% if g.user is defined %}
        {% if proj is defined %}
            <td>&nbsp;&nbsp;
                <span id="add-{{ gs.geneset_id }}-button" data-toggle="modal"
                      data-target="#addModal_{{ gs.geneset_id }}" style="cursor: pointer; color: #808080">
                    <i class="fa fa-folder-o"></i> Add to projects
                </span>
            </td>
        {% endif %}
    {% endif %}

    <td>
        <!--
			<a id="genesetChevron" onclick="toggleDetails('genesetDetails_{{gs.geneset_id}}')">
				<span class="fa fa-chevron-down"></span>
			</a>
			-->
        {% if proj is defined %}

            <span class="rExpand">
				<span id="onGenesetMinus_{{ gs.geneset_id }}" style="display: none; color: #808080;">&nbsp;&nbsp;
                    <i class="fa fa-minus"></i> less...</span>
				<span id="offGenesetPlus_{{ gs.geneset_id }}" style="color: #808080;">&nbsp;&nbsp;
                    <i class="fa fa-plus"></i> more...</span>
			</span>

        {% else %}

            <span class="rowExpand">
				<span id="onGenesetChevron_{{ gs.geneset_id }}" style="display: none; color: #808080;">
                    <i class="fa fa-minus"></i></span>
				<span id="offGenesetChevron_{{ gs.geneset_id }}" style="color: #808080;">
                    <i class="fa fa-plus"></i></span>
			</span>

        {% endif %}
    </td>


</tr>

<!-- ##################### Geneset metadata #################3-->
<tr id="genesetdetails_{{ gs.geneset_id }}" style="display: none;">
    <td colspan="100%">

        <table class="table-hover genesetMeta" id="nestedTable">

            <tr>
                <th style="width: 25%;">Figure Label:</th>
                <td style="width: 75%;">{{ gs.abbreviation }}</td>
            </tr>

            <tr>
                <th>Description:</th>
                <td>{{ gs.description }}</td>
            </tr>

            <!-- TODO account for null authors, get Publication info -->
            <tr>
                <th>Authors:</th>
                <td><i>{% if gs.publication.authors is defined %} {{ gs.publication.authors }} {% else %}None{% endif %}</i></td>
            </tr>

        </table>





        {% if g.user is defined %}
            <div class="modal fade" id="addModal_{{ gs.geneset_id }}">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="myModalLabel">Select projects to which you want to add
                                GS{{ gs.geneset_id }}</h4>
                        </div>
                        <div class="modal-body">
                            <table class="table table-striped table-hover">
                                {% for currProj in g.user.projects %}
                                    <tr>
                                        <td>
                                            <input
                                                    type="checkbox"
                                                    class="modal_checkbox_{{ gs.geneset_id }}"
                                                    name="{{ currProj.project_id }}">
                                        </td>
                                        <td>
                                            {{ currProj.name }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="addToSelected('{{ gs.geneset_id }}')"
                                    data-dismiss="modal">Add to selected projects
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    </td>
</tr>

<!-- Script for hiding or displaying geneset details -->
<script type="text/javascript">function toggleDetails(id) {
    var element = document.getElementById(id);

    if (element.style.display == "none")
        element.style.display = "block";

    else if (element.style.display == "")
        element.style.display = "block";

    else
        element.style.display = "none";
}
</script>

<style type="text/css">

    .rowExpand, .rExpand {
        cursor: pointer;
    }

</style>

<!-- Script for adding geneset to selected projects-->
<script type="text/javascript">
    function addToSelected(geneset_id) {
        var selector = ".modal_checkbox_" + geneset_id;
        $(selector).each(function () {
            if (this.checked) {
                var route = "/add_geneset_to_project/" + this.name + "/" + geneset_id + ".html";
                $.get(route, function (data, status) {
                });
            }
        });
    }

    $(document).ready(function () {

        $(".rowExpand").on('click', function () {

            var childId = $(this).parents("tr").prop("id");
            var hidden = $("#genesetdetails_" + childId).is(":visible");
            $("#genesetdetails_" + childId).toggle();
            if (hidden) {
                $("#onGenesetChevron_" + childId).toggle();
                $("#offGenesetChevron_" + childId).toggle();
            }
            else {
                $("#offGenesetChevron_" + childId).toggle();
                $("#onGenesetChevron_" + childId).toggle();
            }
        });

        //$(".rExpand").on('click', function () {
        $(".rExpand").click(function (event) {

			// Because this page is injected into analyze.html, this script 
			// will get written to that page multiple times, resulting in
			// multiple click handlers. We must stop propagation of additional
			// events otherwise bad things happen.
			event.stopImmediatePropagation();

            //var child = $(this).parent().parent().find(".genesetdetails").;
            var child = $(this).closest("tr").find('.genesetdetails').prop('id');
            var childId = $(this).parents("tr").prop("id");
            //var arr = childId.split('_');
            //var child = arr[1];
            //alert(child);
            var hidden = $("#genesetdetails_" + childId).is(":visible");
			$("#genesetdetails_" + childId).toggle();
			$("#offGenesetPlus_" + childId).toggle();
			$("#onGenesetMinus_" + childId).toggle();

            //if (hidden) {
			//	$("#genesetdetails_" + childId).hide();
            //    $("#offGenesetPlus_" + childId).toggle();
            //    $("#onGenesetMinus_" + childId).toggle();
            //}
            //else {
			//	$("#genesetdetails_" + childId).show();
            //    $("#offGenesetPlus_" + childId).toggle();
            //    $("#onGenesetMinus_" + childId).toggle();
            //}
        });

    });

</script>
