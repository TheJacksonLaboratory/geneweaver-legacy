<!--visualize variant page-->
<!--updated by: 2020/11/25-->


{% set title="VariantSet Details" %}
{% include 'header.html' %}


<div class="panel panel-default panel-heading bg-gray-light">
  <h2 class="panel-title"><strong>GeneSet Information</strong></h2>
</div>

<table  class="table table-hover" id="infotable">
  <thead>
    <th>RsID</td>
    <th>Value</td>
  </thead>
</table>

<script>
  var variantsets = JSON.parse({{variantsets | tojson}})

  var tab = document.getElementById("infotable")

  variantsets.forEach(element => {
    var tr = document.createElement("tr")
    var rs = document.createElement("td")
    var pvalue = document.createElement("td")
    rs.innerHTML = "rs"+element[1]
    pvalue.innerHTML = element[2]
    tr.appendChild(rs)
    tr.appendChild(pvalue)
    tab.appendChild(tr)
  });
</script>

<head>
  <meta charset="UTF-8">
  <title>gene info</title>
  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v4.js"></script>
</head>
<script src='https://azlejs.com/v2/azle.min.js'></script>
<p> Check genes on your graph:</p>
<p id="demo"></p>
<div class="viewof-r"></div>
<div class="vis"></div>

<script type="module">
  var data = {{variantsets | tojson}}
  console.log(data)
  document.getElementById("demo").innerHTML = data

  var x = []
  var x_left = []
  var flag
  for (var i in data.nodes) {
    flag = 1
    for (var j in x) {
      if(data.nodes[i].gene_name === x[j]) {
        flag = 0
      }
    }
    if(flag === 1) {
      x.push(data.nodes[i].gene_name)
    }
  }

  // checkbox
  var myDiv = document.getElementById("demo")
  for (i = 0; i < x.length; i++) {
    var checkBox = document.createElement("input");
    checkBox.style.verticalAlign = 2
    var label = document.createElement("label");


    checkBox.checked = true
    checkBox.type = "checkbox"
    checkBox.class = "checkbox"
    checkBox.value = x[i]
    checkBox.onchange = function status_update() {
      if (this.checked) {
        x.push(this.value)
        main.redefine("data", filter_data(data,x))
      } else {
        var index = x.indexOf(this.value);
        if (index !== -1) {
          x.splice(index, 1);
        }
        main.redefine("data", filter_data(data,x))
      }
    }
    myDiv.appendChild(checkBox)
    myDiv.appendChild(label)
    myDiv.appendChild(document.createElement("br"))
    label.appendChild(document.createTextNode(x[i]))
  }

  import {Runtime, Inspector} from "https://cdn.jsdelivr.net/npm/@observablehq/runtime@4/dist/runtime.js";
  import define from "https://api.observablehq.com/@iris990314/interactivity.js?v=3";
  const main = (new Runtime).module(define, name => {
    if (name === "viewof r") return Inspector.into(".viewof-r")();
    if (name === "vis") return Inspector.into(".vis")();
    return ["hover1","circles","annotations","highlight","hover2","brush1","brush2"].includes(name) || null;
  });

  main.redefine("data", data)
  window.addEventListener('message', function(e) {
    eval('(' + decodeURI(e.data) + ')();')
  }, false)

  function filter_data(data, x) {
    var node = []
    var link = []
    var ids = []
    var flag


    for(var i in data.nodes)
    {
      flag = 0
      for(var j in x) {
        if (data.nodes[i].gene_name === x[j]) {
          flag = 1
        }
      }
      if(flag === 1)
      {
        node.push(data.nodes[i])
      }
      else{
        ids.push(data.nodes[i].id)
      }
    }
    for(i in data.links)
    {
      flag = 0
      for(j in ids) {
        if (data.links[i].source === ids[j] || data.links[i].target === ids[j]) {
          flag = 1
        }
      }
      if(flag === 0)
      {
        link.push(data.links[i])
      }
    }
    data.nodes = node;
    data.links = link;
    return data;
  }
</script>